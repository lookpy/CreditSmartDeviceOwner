 ExplicaÃ§Ã£o para Time APK: Fluxo de ConexÃ£o e Pareamento
ðŸ–¥ï¸ O QUE ESTÃ APARECENDO NO PDV
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸ“· Escanear com app Credit Smart       â”‚
â”‚     e digitar cÃ³digo                    â”‚
â”‚                                         â”‚
â”‚     CÃ³digo: ZB7E-RZVX                   â”‚
â”‚                                         â”‚
â”‚     â³ Aguardando ConexÃ£o...            â”‚
â”‚                                         â”‚
â”‚     Contrato: CTR_1770246531734_953198  â”‚
â”‚     Aguardando...                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ðŸ”„ O QUE O APK DEVE FAZER
PASSO 1: Cliente digita o cÃ³digo no APK
O cliente digita ZB7E-RZVX na tela do APK.

PASSO 2: APK envia requisiÃ§Ã£o de autenticaÃ§Ã£o
POST /api/apk/auth
Content-Type: application/json
{
  "pairingCode": "ZB7E-RZVX"
}
Campos alternativos aceitos:

token
code
pairingCode
apkToken
ðŸ“¡ RESPOSTAS POSSÃVEIS
âœ… SUCESSO (200 OK)
{
  "success": true,
  "saleId": "sale_1770246531734_xxxxx",
  "apkToken": "ZB7E-RZVX",
  "customerId": "uuid-do-cliente",
  "storeId": "uuid-da-loja",
  "imei": "353104906953198",
  "stage": "pending_contract_code",
  "deviceData": {
    "name": "MOTOROLA Moto G15 Power",
    "totalValue": "1400.00",
    "installmentValue": "58.33",
    "installmentCount": 24
  }
}
AÃ§Ã£o do APK: AvanÃ§ar para tela de biometria KYC

â³ NÃƒO ENCONTRADO (404 Not Found)
{
  "success": false,
  "message": "not found"
}
AÃ§Ã£o do APK:

Mostrar tela "Aguardando Vendedor"
Fazer polling a cada 2 segundos
Timeout mÃ¡ximo: 6 minutos
ðŸ“Š DIAGRAMA DO FLUXO
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      PDV         â”‚          â”‚     BACKEND      â”‚          â”‚       APK        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                             â”‚                             â”‚
         â”‚  POST /api/sales            â”‚                             â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚                             â”‚
         â”‚                             â”‚                             â”‚
         â”‚  {pairingCode: ZB7E-RZVX}   â”‚                             â”‚
         â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                             â”‚
         â”‚                             â”‚                             â”‚
         â”‚  Mostra cÃ³digo na tela      â”‚                             â”‚
         â”‚                             â”‚                             â”‚
         â”‚                             â”‚    Cliente digita cÃ³digo    â”‚
         â”‚                             â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                             â”‚                             â”‚
         â”‚                             â”‚    POST /api/apk/auth       â”‚
         â”‚                             â”‚    {pairingCode: ZB7E-RZVX} â”‚
         â”‚                             â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                             â”‚                             â”‚
         â”‚                             â”‚    200 OK + dados da venda  â”‚
         â”‚                             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                             â”‚                             â”‚
         â”‚    WebSocket: APK_CONNECTED â”‚                             â”‚
         â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                             â”‚
         â”‚                             â”‚                             â”‚
         â”‚  Atualiza: "APK Conectado!" â”‚                             â”‚
         â”‚                             â”‚                             â”‚
         â”‚                             â”‚    APK inicia biometria     â”‚
         â”‚                             â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
ðŸ”” COMO O PDV SABE QUE O APK CONECTOU
O PDV faz polling contÃ­nuo em:

GET /api/sales/check-apk-auth/{saleId}
Quando o APK chama /api/apk/auth com sucesso, o backend:

Atualiza o registro em imei_validations
Muda o stage para apk_connected
O prÃ³ximo polling do PDV detecta a mudanÃ§a
PDV atualiza a tela para "APK Conectado!"
âš ï¸ PONTOS IMPORTANTES PARA O APK
Item	Detalhes
Formato do cÃ³digo	XXXX-XXXX (8 caracteres com hÃ­fen)
Endpoint de autenticaÃ§Ã£o	POST /api/apk/auth
Campo do cÃ³digo	pairingCode, token, code ou apkToken
Polling se 404	A cada 2 segundos
Timeout mÃ¡ximo	6 minutos
Janela de pareamento	24 horas apÃ³s criaÃ§Ã£o da venda
ðŸ” FLUXO COMPLETO ESPERADO DO APK
1. [APK] Recebe cÃ³digo do cliente: "ZB7E-RZVX"
2. [APK] Chama POST /api/apk/auth com o cÃ³digo
3. [APK] Se 404 â†’ Mostra "Aguardando Vendedor" + polling 2s
4. [APK] Se 200 â†’ Salva dados da venda (saleId, customerId, deviceData)
5. [APK] Inicia verificaÃ§Ã£o biomÃ©trica KYC
6. [APK] Monitora status KYC via GET /api/kyc/session/{sessionId}
7. [APK] Quando KYC = Approved â†’ Notifica backend
8. [BACKEND] Cria dispositivo e finaliza venda (Stage 2)
# ğŸ“± DocumentaÃ§Ã£o: Sistema de DesinstalaÃ§Ã£o de Aplicativos
## CDC Credit Smart - Fintech Platform

> **VersÃ£o:** 1.0.0  
> **Ãšltima AtualizaÃ§Ã£o:** 21 de Novembro de 2025  
> **Autor:** Sistema CDC Credit Smart

---

## ğŸ“‹ Ãndice

1. [VisÃ£o Geral](#visÃ£o-geral)
2. [Arquitetura do Sistema](#arquitetura-do-sistema)
3. [Fluxo de DesinstalaÃ§Ã£o](#fluxo-de-desinstalaÃ§Ã£o)
4. [ProteÃ§Ãµes de SeguranÃ§a](#proteÃ§Ãµes-de-seguranÃ§a)
5. [Endpoint da API](#endpoint-da-api)
6. [CÃ³digos de DesinstalaÃ§Ã£o](#cÃ³digos-de-desinstalaÃ§Ã£o)
7. [Comandos MDM](#comandos-mdm)
8. [Auto-DesinstalaÃ§Ã£o](#auto-desinstalaÃ§Ã£o)
9. [Logs e Auditoria](#logs-e-auditoria)
10. [Device Owner e Device Admin](#device-owner-e-device-admin)

---

## ğŸ¯ VisÃ£o Geral

O sistema de desinstalaÃ§Ã£o do CDC Credit Smart Ã© projetado com **mÃºltiplas camadas de seguranÃ§a** para garantir que:

- âœ… Apenas administradores autorizados possam solicitar desinstalaÃ§Ãµes
- âœ… Toda desinstalaÃ§Ã£o seja **validada com cÃ³digo Ãºnico**
- âœ… Todas as aÃ§Ãµes sejam **registradas para auditoria**
- âœ… O dispositivo seja notificado em **tempo real via WebSocket**
- âœ… O APK possa se **auto-desinstalar** quando autorizado

---

## ğŸ—ï¸ Arquitetura do Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ADMIN WEB DASHBOARD                       â”‚
â”‚  (Solicita desinstalaÃ§Ã£o com cÃ³digo de autorizaÃ§Ã£o)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 BACKEND API SERVER                           â”‚
â”‚                                                              â”‚
â”‚  1. Valida cÃ³digo de desinstalaÃ§Ã£o                          â”‚
â”‚  2. Cria comando MDM (UNINSTALL_APP)                        â”‚
â”‚  3. Envia notificaÃ§Ã£o WebSocket                             â”‚
â”‚  4. Registra log de auditoria                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                            â”‚
              â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WEBSOCKET SERVER   â”‚      â”‚  COMANDO MDM DB      â”‚
â”‚  (NotificaÃ§Ã£o Real)  â”‚      â”‚  (24h expiration)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DISPOSITIVO ANDROID (APK)                       â”‚
â”‚                                                              â”‚
â”‚  1. Recebe notificaÃ§Ã£o WebSocket                            â”‚
â”‚  2. Valida comando MDM                                      â”‚
â”‚  3. Verifica cÃ³digo de desinstalaÃ§Ã£o                        â”‚
â”‚  4. Executa auto-desinstalaÃ§Ã£o                              â”‚
â”‚  5. Remove Device Owner/Admin                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Fluxo de DesinstalaÃ§Ã£o

### **Passo 1: SolicitaÃ§Ã£o pelo Admin**

```http
POST /api/devices/:deviceId/uninstall
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json

{
  "uninstallCode": "ABC123XYZ"
}
```

### **Passo 2: ValidaÃ§Ã£o de PermissÃµes**

1. âœ… Verificar se usuÃ¡rio Ã© **admin** (role check)
2. âœ… Verificar se **cÃ³digo de desinstalaÃ§Ã£o** Ã© vÃ¡lido
3. âœ… Verificar se dispositivo existe
4. âŒ **Bloquear** se qualquer validaÃ§Ã£o falhar

### **Passo 3: CriaÃ§Ã£o do Comando MDM**

```typescript
{
  deviceId: "device_123",
  commandType: "UNINSTALL_APP",
  commandData: {
    reason: "DesinstalaÃ§Ã£o autorizada pelo admin",
    uninstallCode: "ABC123XYZ",
    requestedBy: "admin@cdccreditsmart.com"
  },
  priority: "critical",
  status: "pending",
  expiresAt: "2025-11-22T03:00:00.000Z" // 24 horas
}
```

### **Passo 4: NotificaÃ§Ã£o WebSocket**

```json
{
  "type": "mdm_command",
  "command": "UNINSTALL_APP",
  "commandId": "cmd_456",
  "priority": "critical",
  "reason": "DesinstalaÃ§Ã£o autorizada pelo admin",
  "uninstallCode": "ABC123XYZ"
}
```

### **Passo 5: ExecuÃ§Ã£o no Dispositivo**

1. APK recebe notificaÃ§Ã£o WebSocket
2. Valida cÃ³digo de desinstalaÃ§Ã£o com servidor
3. Remove permissÃµes Device Owner/Admin
4. Executa auto-desinstalaÃ§Ã£o
5. Reporta status ao servidor

---

## ğŸ”’ ProteÃ§Ãµes de SeguranÃ§a

### **1. CÃ³digo de DesinstalaÃ§Ã£o ObrigatÃ³rio**

- âœ… CÃ³digo Ãºnico gerado por dispositivo
- âœ… Validado no servidor antes de executar
- âœ… Expira apÃ³s uso ou tempo limite
- âœ… Registrado em log de auditoria

### **2. AutenticaÃ§Ã£o e AutorizaÃ§Ã£o**

```typescript
// Apenas admins podem solicitar desinstalaÃ§Ã£o
if (req.user?.role !== 'admin') {
  return res.status(403).json({ 
    error: 'Acesso negado - apenas administradores podem solicitar desinstalaÃ§Ã£o' 
  });
}
```

### **3. ValidaÃ§Ã£o de CÃ³digo**

```typescript
// Validar cÃ³digo de desinstalaÃ§Ã£o
const isValid = await storage.validateUninstallCode(deviceId, uninstallCode);
if (!isValid) {
  // Log de tentativa invÃ¡lida
  await logAuditEvent({
    action: 'uninstall_attempt_failed',
    reason: 'CÃ³digo de desinstalaÃ§Ã£o invÃ¡lido'
  });
  
  return res.status(403).json({ 
    error: 'CÃ³digo de desinstalaÃ§Ã£o invÃ¡lido' 
  });
}
```

### **4. Prioridade CrÃ­tica**

- âš¡ Comandos de desinstalaÃ§Ã£o tÃªm **prioridade mÃ¡xima**
- ğŸ”” NotificaÃ§Ãµes WebSocket em tempo real
- â±ï¸ ExpiraÃ§Ã£o em 24 horas
- ğŸ“Š Monitoramento de entrega

---

## ğŸŒ Endpoint da API

### **POST /api/devices/:deviceId/uninstall**

**DescriÃ§Ã£o:** Solicita desinstalaÃ§Ã£o do APK de um dispositivo especÃ­fico.

**AutenticaÃ§Ã£o:** Bearer Token (JWT)

**PermissÃ£o:** Admin apenas

**ParÃ¢metros:**

| Nome | Tipo | ObrigatÃ³rio | DescriÃ§Ã£o |
|------|------|-------------|-----------|
| `deviceId` | string | âœ… Sim | ID do dispositivo |
| `uninstallCode` | string | âœ… Sim | CÃ³digo de desinstalaÃ§Ã£o vÃ¡lido |

**Exemplo de Request:**

```bash
curl -X POST https://cdccreditsmart.com/api/devices/device_123/uninstall \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{
    "uninstallCode": "ABC123XYZ"
  }'
```

**Resposta de Sucesso (201):**

```json
{
  "success": true,
  "message": "Comando de desinstalaÃ§Ã£o enviado ao dispositivo",
  "commandId": "cmd_789",
  "command": {
    "id": "cmd_789",
    "deviceId": "device_123",
    "commandType": "UNINSTALL_APP",
    "status": "pending",
    "priority": "critical",
    "expiresAt": "2025-11-22T03:00:00.000Z"
  }
}
```

**Respostas de Erro:**

| CÃ³digo | DescriÃ§Ã£o |
|--------|-----------|
| `400` | CÃ³digo de desinstalaÃ§Ã£o nÃ£o fornecido |
| `403` | Acesso negado (nÃ£o Ã© admin) ou cÃ³digo invÃ¡lido |
| `404` | Dispositivo nÃ£o encontrado |
| `500` | Erro interno do servidor |

---

## ğŸ”‘ CÃ³digos de DesinstalaÃ§Ã£o

### **GeraÃ§Ã£o de CÃ³digos**

Os cÃ³digos de desinstalaÃ§Ã£o sÃ£o:

- ğŸ“ Gerados automaticamente por dispositivo
- ğŸ” Ãšnicos e nÃ£o reutilizÃ¡veis
- â±ï¸ Com tempo de expiraÃ§Ã£o
- ğŸ—„ï¸ Armazenados no banco de dados

### **ValidaÃ§Ã£o de CÃ³digos**

```typescript
// MÃ©todo de validaÃ§Ã£o no storage
async validateUninstallCode(deviceId: string, code: string): Promise<boolean> {
  const result = await db
    .select()
    .from(uninstallCodes)
    .where(
      and(
        eq(uninstallCodes.deviceId, deviceId),
        eq(uninstallCodes.code, code),
        eq(uninstallCodes.used, false),
        gt(uninstallCodes.expiresAt, new Date())
      )
    )
    .limit(1);
  
  if (result.length === 0) {
    return false;
  }
  
  // Marcar cÃ³digo como usado
  await db
    .update(uninstallCodes)
    .set({ used: true, usedAt: new Date() })
    .where(eq(uninstallCodes.id, result[0].id));
  
  return true;
}
```

---

## ğŸ“¡ Comandos MDM

### **Estrutura do Comando MDM**

```typescript
interface MDMCommand {
  id: string;
  deviceId: string;
  commandType: "UNINSTALL_APP";
  commandData: {
    reason: string;
    uninstallCode: string;
    requestedBy: string;
  };
  status: "pending" | "delivered" | "executed" | "failed" | "expired";
  priority: "critical" | "high" | "normal" | "low";
  createdAt: Date;
  expiresAt: Date;
  deliveredAt?: Date;
  executedAt?: Date;
}
```

### **Ciclo de Vida do Comando**

```
pending â†’ delivered â†’ executed
   â†“          â†“          â†“
 expired    failed    failed
```

### **Tipos de Comandos MDM**

| Tipo | DescriÃ§Ã£o |
|------|-----------|
| `UNINSTALL_APP` | Desinstalar o APK do dispositivo |
| `BLOCK_DEVICE` | Bloquear acesso a apps |
| `UNBLOCK_DEVICE` | Desbloquear acesso a apps |
| `UPDATE_CONFIG` | Atualizar configuraÃ§Ãµes |
| `FACTORY_RESET` | Reset de fÃ¡brica (extremo) |

---

## ğŸ¤– Auto-DesinstalaÃ§Ã£o

### **Mecanismo de Auto-DesinstalaÃ§Ã£o**

O APK possui capacidade de **auto-desinstalaÃ§Ã£o** quando recebe comando autorizado:

```typescript
// NotificaÃ§Ã£o WebSocket recebida pelo APK
onWebSocketMessage(message) {
  if (message.command === 'UNINSTALL_APP') {
    const uninstallCode = message.uninstallCode;
    
    // Validar cÃ³digo com servidor
    const isValid = await validateUninstallCode(uninstallCode);
    
    if (isValid) {
      console.log('âœ… CÃ³digo vÃ¡lido - iniciando auto-desinstalaÃ§Ã£o');
      
      // 1. Remover Device Owner/Admin
      await removeDeviceOwner();
      
      // 2. Notificar servidor
      await notifyUninstallStarted();
      
      // 3. Auto-desinstalar
      await selfUninstall();
    }
  }
}
```

### **Processo de RemoÃ§Ã£o Device Owner**

Antes da desinstalaÃ§Ã£o, o APK deve:

1. âœ… Remover permissÃµes de Device Owner
2. âœ… Desabilitar Device Admin Receiver
3. âœ… Limpar polÃ­ticas MDM aplicadas
4. âœ… Notificar servidor sobre conclusÃ£o

```java
// CÃ³digo Android (exemplo)
DevicePolicyManager dpm = getSystemService(DevicePolicyManager.class);
ComponentName adminReceiver = new ComponentName(this, CDCDeviceAdminReceiver.class);

// Remover como Device Owner
dpm.clearDeviceOwnerApp(getPackageName());

// Desinstalar
Intent intent = new Intent(Intent.ACTION_DELETE);
intent.setData(Uri.parse("package:" + getPackageName()));
startActivity(intent);
```

---

## ğŸ“Š Logs e Auditoria

### **Eventos Registrados**

Todos os eventos de desinstalaÃ§Ã£o sÃ£o registrados:

| Evento | DescriÃ§Ã£o |
|--------|-----------|
| `uninstall_authorized` | Admin autorizou desinstalaÃ§Ã£o |
| `uninstall_attempt_failed` | Tentativa com cÃ³digo invÃ¡lido |
| `mdm_command_created` | Comando MDM criado |
| `mdm_websocket_uninstall_notification` | WebSocket enviado |
| `uninstall_started` | APK iniciou desinstalaÃ§Ã£o |
| `uninstall_completed` | DesinstalaÃ§Ã£o concluÃ­da |

### **Estrutura do Log de Auditoria**

```typescript
{
  action: "uninstall_authorized",
  entityType: "device",
  entityId: "device_123",
  userId: "admin_456",
  details: {
    uninstallCode: "ABC123XYZ",
    requestedBy: "admin@cdccreditsmart.com",
    commandId: "cmd_789",
    websocketDelivered: true
  },
  timestamp: "2025-11-21T03:35:14.000Z"
}
```

### **Consulta de Logs**

```sql
SELECT * FROM audit_logs
WHERE action LIKE '%uninstall%'
  AND entity_type = 'device'
  AND entity_id = 'device_123'
ORDER BY created_at DESC;
```

---

## ğŸ›¡ï¸ Device Owner e Device Admin

### **Componente Device Admin Receiver**

O APK utiliza um **Device Admin Receiver** para gerenciar permissÃµes:

```
Component Name: 
com.cdccreditsmart.app/com.cdccreditsmart.device.CDCDeviceAdminReceiver
```

### **DetecÃ§Ã£o AutomÃ¡tica**

O sistema detecta automaticamente o Device Admin Receiver do APK:

```typescript
const detectDeviceAdminComponent = (manifest: any, packageName: string): string | null => {
  // Verificar por padrÃµes comuns
  const commonDeviceAdminClasses = [
    '.device.CDCDeviceAdminReceiver',
    '.admin.CDCDeviceAdminReceiver', 
    '.device.DeviceAdminReceiver',
    '.admin.DeviceAdminReceiver',
    '.admin.AdvancedDeviceAdminReceiver'
  ];
  
  // Buscar no manifest
  const receivers = manifest.application.receiver;
  const deviceAdminReceivers = receivers.filter(receiver => {
    return receiver.permission === 'android.permission.BIND_DEVICE_ADMIN' ||
           receiver['meta-data']?.name === 'android.app.device_admin' ||
           receiver['intent-filter']?.action?.name === 'android.app.action.DEVICE_ADMIN_ENABLED';
  });
  
  return deviceAdminReceivers[0]?.name || null;
};
```

### **PermissÃµes Device Owner**

Quando configurado como Device Owner, o APK pode:

- âœ… **Gerenciar apps** instalados (nÃ£o desinstalar)
- âœ… **Aplicar polÃ­ticas** MDM
- âœ… **Monitorar** uso do dispositivo
- âœ… **Bloquear/desbloquear** acesso a apps
- âŒ **NÃƒO pode bloquear** o aparelho completamente (Lei 19.547/2025)

---

## ğŸš¨ Importante: Lei 19.547/2025 (CearÃ¡)

> **ATENÃ‡ÃƒO:** O sistema **NÃƒO bloqueia o funcionamento** do aparelho telefÃ´nico, apenas **LIMITA o uso de aplicativos** nÃ£o essenciais.

### **Conformidade Legal**

- âœ… **Permitido:** Limitar acesso a apps (redes sociais, jogos, etc.)
- âœ… **Permitido:** GestÃ£o de software via Device Owner
- âŒ **PROIBIDO:** Bloquear funcionamento do aparelho
- âŒ **PROIBIDO:** Impedir ligaÃ§Ãµes ou emergÃªncias

### **FunÃ§Ãµes Sempre DisponÃ­veis**

Mesmo com limitaÃ§Ãµes ativas, o usuÃ¡rio sempre tem acesso a:

- ğŸ“ LigaÃ§Ãµes telefÃ´nicas
- ğŸš¨ ServiÃ§os de emergÃªncia (190, 192, 193)
- ğŸ’¬ SMS
- â° RelÃ³gio e agenda
- ğŸ”¢ Calculadora
- ğŸ¦ Apps essenciais (bancÃ¡rios, governo)

---

## ğŸ“ Exemplo Completo de Uso

### **1. Admin solicita desinstalaÃ§Ã£o**

```bash
curl -X POST https://cdccreditsmart.com/api/devices/device_abc123/uninstall \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{"uninstallCode": "XYZ789DEF"}'
```

### **2. Servidor valida e cria comando**

```
âœ… CÃ³digo vÃ¡lido
âœ… Comando MDM criado: cmd_999
âœ… WebSocket enviado: device_abc123
âœ… Log de auditoria registrado
```

### **3. Dispositivo recebe notificaÃ§Ã£o**

```json
{
  "type": "mdm_command",
  "command": "UNINSTALL_APP",
  "commandId": "cmd_999",
  "priority": "critical",
  "uninstallCode": "XYZ789DEF"
}
```

### **4. APK executa auto-desinstalaÃ§Ã£o**

```
ğŸ”“ Removendo Device Owner...
ğŸ“¡ Notificando servidor...
ğŸ—‘ï¸  Iniciando auto-desinstalaÃ§Ã£o...
âœ… DesinstalaÃ§Ã£o concluÃ­da
```

---

## ğŸ” Troubleshooting

### **Problema: CÃ³digo de desinstalaÃ§Ã£o invÃ¡lido**

**Sintomas:**
```json
{
  "error": "CÃ³digo de desinstalaÃ§Ã£o invÃ¡lido"
}
```

**SoluÃ§Ãµes:**
1. Verificar se o cÃ³digo estÃ¡ correto
2. Verificar se o cÃ³digo nÃ£o expirou
3. Verificar se o cÃ³digo nÃ£o foi usado anteriormente
4. Gerar novo cÃ³digo se necessÃ¡rio

### **Problema: WebSocket nÃ£o entrega comando**

**Sintomas:**
- Comando criado mas APK nÃ£o recebe
- Status permanece "pending"

**SoluÃ§Ãµes:**
1. Verificar conexÃ£o WebSocket do dispositivo
2. Verificar se dispositivo estÃ¡ online
3. Verificar logs do servidor WebSocket
4. Reenviar comando manualmente

### **Problema: APK nÃ£o consegue se desinstalar**

**Sintomas:**
- APK recebe comando mas nÃ£o desinstala
- Erro ao remover Device Owner

**SoluÃ§Ãµes:**
1. Verificar permissÃµes Device Owner
2. Verificar se usuÃ¡rio removeu manualmente Device Admin
3. Executar remoÃ§Ã£o manual de Device Owner no dispositivo
4. Factory reset como Ãºltimo recurso

---

## ğŸ“ Suporte

Para questÃµes sobre desinstalaÃ§Ã£o:

- ğŸ“§ Email: suporte@cdccreditsmart.com
- ğŸ“± WhatsApp: +55 85 9999-9999
- ğŸŒ Portal: https://cdccreditsmart.com/suporte

---

## ğŸ“š ReferÃªncias

- [Android Device Owner Documentation](https://developer.android.com/work/dpc/dedicated-devices/device-owner)
- [Android Device Administration API](https://developer.android.com/guide/topics/admin/device-admin)
- [Lei Estadual 19.547/2025 (CearÃ¡)](https://example.com/lei-19547)
- [CÃ³digo de Defesa do Consumidor](https://www.planalto.gov.br/ccivil_03/leis/l8078.htm)

---

**Ãšltima RevisÃ£o:** 21 de Novembro de 2025  
**VersÃ£o do Sistema:** 1.0.0  
**Autor:** CDC Credit Smart Development Team

# üñºÔ∏è Notifica√ß√µes Push com Imagem - Solu√ß√£o

## üîç Problema Identificado

As notifica√ß√µes push est√£o chegando **SEM IMAGEM** no APK Android, mesmo o backend enviando a `imageUrl` corretamente via Firebase Cloud Messaging (FCM).

**Exemplo de notifica√ß√£o sem imagem:**
```
üì± Notifica√ß√£o recebida:
   T√≠tulo: "CDC"
   Mensagem: "TESTE"
   Imagem: ‚ùå N√ÉO APARECE
```

---

## ‚úÖ Backend Est√° CORRETO

O backend **J√Å est√° enviando** a `imageUrl` corretamente via FCM:

### **C√≥digo de Envio (server/firebase.ts):**

```typescript
const message: admin.messaging.Message = {
  notification: {
    title: notification.title,
    body: notification.body,
    ...(notification.imageUrl && { imageUrl: notification.imageUrl })  // ‚úÖ Enviando
  },
  data: dataPayload,
  android: {
    priority: 'high',
    ttl: 86400000,
    ...(notification.imageUrl && {
      notification: {
        imageUrl: notification.imageUrl  // ‚úÖ Enviando para Android
      }
    })
  },
  token: fcmToken
};
```

**Payload FCM enviado:**
```json
{
  "notification": {
    "title": "CDC",
    "body": "TESTE",
    "imageUrl": "https://cdccreditsmart.com/storage/campaign_xxx.jpg"
  },
  "android": {
    "notification": {
      "imageUrl": "https://cdccreditsmart.com/storage/campaign_xxx.jpg"
    }
  }
}
```

‚úÖ **Backend enviando corretamente!**

---

## ‚ùå Problema Est√° no APK Android

O **APK n√£o est√° processando a `imageUrl`** recebida do FCM. 

**Poss√≠veis causas:**

1. ‚úÖ APK recebe a mensagem FCM
2. ‚ùå APK **N√ÉO** processa o campo `imageUrl`
3. ‚ùå APK **N√ÉO** faz download da imagem
4. ‚ùå APK **N√ÉO** exibe a imagem na notifica√ß√£o

---

## üîß Solu√ß√£o: Processar imageUrl no APK

### **1. Adicionar Permiss√£o de Internet (AndroidManifest.xml):**

```xml
<uses-permission android:name="android.permission.INTERNET" />
```

---

### **2. Processar imageUrl no FirebaseMessagingService:**

```kotlin
package com.cdccreditsmart.app.services

import android.app.NotificationChannel
import android.app.NotificationManager
import android.app.PendingIntent
import android.content.Context
import android.content.Intent
import android.graphics.Bitmap
import android.graphics.BitmapFactory
import android.os.Build
import android.util.Log
import androidx.core.app.NotificationCompat
import com.google.firebase.messaging.FirebaseMessagingService
import com.google.firebase.messaging.RemoteMessage
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.net.HttpURLConnection
import java.net.URL

class CdcFirebaseMessagingService : FirebaseMessagingService() {
    
    private val TAG = "FCM_Service"
    private val CHANNEL_ID = "cdc_push_notifications"
    
    override fun onMessageReceived(remoteMessage: RemoteMessage) {
        Log.d(TAG, "üì• Mensagem FCM recebida de: ${remoteMessage.from}")
        
        // Extrair dados da notifica√ß√£o
        val title = remoteMessage.notification?.title ?: "CDC CreditSmart"
        val body = remoteMessage.notification?.body ?: ""
        val imageUrl = remoteMessage.notification?.imageUrl
        
        Log.d(TAG, "üìã T√≠tulo: $title")
        Log.d(TAG, "üìã Mensagem: $body")
        Log.d(TAG, "üñºÔ∏è Image URL: $imageUrl")
        
        // Verificar se tem imagem
        if (imageUrl != null && imageUrl.isNotEmpty()) {
            // Carregar imagem e exibir notifica√ß√£o com imagem
            loadImageAndShowNotification(title, body, imageUrl, remoteMessage.data)
        } else {
            // Exibir notifica√ß√£o sem imagem
            showNotification(title, body, null, remoteMessage.data)
        }
    }
    
    private fun loadImageAndShowNotification(
        title: String,
        body: String,
        imageUrl: String,
        data: Map<String, String>
    ) {
        CoroutineScope(Dispatchers.IO).launch {
            try {
                Log.d(TAG, "‚¨áÔ∏è Baixando imagem: $imageUrl")
                
                val bitmap = downloadImage(imageUrl)
                
                if (bitmap != null) {
                    Log.d(TAG, "‚úÖ Imagem carregada com sucesso! Tamanho: ${bitmap.width}x${bitmap.height}")
                    withContext(Dispatchers.Main) {
                        showNotification(title, body, bitmap, data)
                    }
                } else {
                    Log.e(TAG, "‚ùå Falha ao carregar imagem, exibindo notifica√ß√£o sem imagem")
                    withContext(Dispatchers.Main) {
                        showNotification(title, body, null, data)
                    }
                }
            } catch (e: Exception) {
                Log.e(TAG, "‚ùå Erro ao carregar imagem: ${e.message}", e)
                withContext(Dispatchers.Main) {
                    showNotification(title, body, null, data)
                }
            }
        }
    }
    
    private fun downloadImage(imageUrl: String): Bitmap? {
        return try {
            val url = URL(imageUrl)
            val connection = url.openConnection() as HttpURLConnection
            connection.doInput = true
            connection.connectTimeout = 10000
            connection.readTimeout = 10000
            connection.connect()
            
            val inputStream = connection.inputStream
            val bitmap = BitmapFactory.decodeStream(inputStream)
            inputStream.close()
            
            bitmap
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Erro ao baixar imagem: ${e.message}", e)
            null
        }
    }
    
    private fun showNotification(
        title: String,
        body: String,
        bitmap: Bitmap?,
        data: Map<String, String>
    ) {
        Log.d(TAG, "üì± Exibindo notifica√ß√£o - Com imagem: ${bitmap != null}")
        
        // Criar canal de notifica√ß√£o (Android 8+)
        createNotificationChannel()
        
        // Intent para abrir o app ao clicar na notifica√ß√£o
        val intent = Intent(this, MainActivity::class.java).apply {
            flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK
            putExtra("fromNotification", true)
            
            // Adicionar data do FCM como extras
            data.forEach { (key, value) ->
                putExtra(key, value)
            }
        }
        
        val pendingIntent = PendingIntent.getActivity(
            this,
            System.currentTimeMillis().toInt(),
            intent,
            PendingIntent.FLAG_IMMUTABLE or PendingIntent.FLAG_UPDATE_CURRENT
        )
        
        // Construir notifica√ß√£o
        val notificationBuilder = NotificationCompat.Builder(this, CHANNEL_ID)
            .setSmallIcon(R.drawable.ic_notification) // Seu √≠cone
            .setContentTitle(title)
            .setContentText(body)
            .setPriority(NotificationCompat.PRIORITY_HIGH)
            .setAutoCancel(true)
            .setContentIntent(pendingIntent)
        
        // Adicionar imagem se dispon√≠vel
        if (bitmap != null) {
            notificationBuilder
                .setLargeIcon(bitmap)  // √çcone grande (thumbnail)
                .setStyle(
                    NotificationCompat.BigPictureStyle()
                        .bigPicture(bitmap)
                        .bigLargeIcon(null)  // Remove √≠cone grande quando expandido
                )
            
            Log.d(TAG, "‚úÖ Notifica√ß√£o com imagem criada!")
        } else {
            // Sem imagem, usar estilo de texto expandido
            notificationBuilder.setStyle(
                NotificationCompat.BigTextStyle()
                    .bigText(body)
            )
            
            Log.d(TAG, "‚ö†Ô∏è Notifica√ß√£o SEM imagem criada")
        }
        
        // Exibir notifica√ß√£o
        val notificationManager = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
        notificationManager.notify(System.currentTimeMillis().toInt(), notificationBuilder.build())
        
        Log.d(TAG, "‚úÖ Notifica√ß√£o exibida com sucesso!")
    }
    
    private fun createNotificationChannel() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            val name = "Push Notifications"
            val descriptionText = "Notifica√ß√µes do CDC CreditSmart"
            val importance = NotificationManager.IMPORTANCE_HIGH
            val channel = NotificationChannel(CHANNEL_ID, name, importance).apply {
                description = descriptionText
            }
            
            val notificationManager: NotificationManager =
                getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
            notificationManager.createNotificationChannel(channel)
        }
    }
    
    override fun onNewToken(token: String) {
        super.onNewToken(token)
        Log.d(TAG, "üîë Novo FCM Token: $token")
        
        // Enviar token para o backend
        // TODO: Implementar envio do token via API
    }
}
```

---

### **3. Registrar Service no AndroidManifest.xml:**

```xml
<service
    android:name=".services.CdcFirebaseMessagingService"
    android:exported="false">
    <intent-filter>
        <action android:name="com.google.firebase.MESSAGING_EVENT" />
    </intent-filter>
</service>
```

---

### **4. Adicionar √çcone de Notifica√ß√£o:**

Crie `res/drawable/ic_notification.xml`:

```xml
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="24dp"
    android:height="24dp"
    android:viewportWidth="24"
    android:viewportHeight="24"
    android:tint="@android:color/white">
    <path
        android:fillColor="@android:color/white"
        android:pathData="M12,22c1.1,0 2,-0.9 2,-2h-4c0,1.1 0.9,2 2,2zM18,16v-5c0,-3.07 -1.64,-5.64 -4.5,-6.32V4c0,-0.83 -0.67,-1.5 -1.5,-1.5s-1.5,0.67 -1.5,1.5v0.68C7.63,5.36 6,7.92 6,11v5l-2,2v1h16v-1l-2,-2z"/>
</vector>
```

---

## üìä Fluxo Completo

### **1. Backend Envia Notifica√ß√£o (Campanha):**

```typescript
// server/services/campaignService.ts
const result = await sendPushNotification(storage, deviceId, {
  title: "CDC",
  body: "TESTE",
  imageUrl: "https://cdccreditsmart.com/storage/campaign_123.jpg",  // ‚úÖ
  type: 'INFO',
  deepLink: 'cdc://home'
});
```

---

### **2. FCM Entrega para o APK:**

```json
{
  "notification": {
    "title": "CDC",
    "body": "TESTE",
    "imageUrl": "https://cdccreditsmart.com/storage/campaign_123.jpg"
  },
  "data": {
    "campaignId": "campaign_123",
    "priority": "high"
  }
}
```

---

### **3. APK Recebe e Processa:**

```kotlin
// CdcFirebaseMessagingService.kt
override fun onMessageReceived(remoteMessage: RemoteMessage) {
    val imageUrl = remoteMessage.notification?.imageUrl
    
    if (imageUrl != null) {
        // ‚úÖ Baixar imagem
        val bitmap = downloadImage(imageUrl)
        
        // ‚úÖ Exibir notifica√ß√£o com imagem
        showNotification(title, body, bitmap, data)
    }
}
```

---

### **4. Notifica√ß√£o Exibida COM IMAGEM:**

```
üì± Notifica√ß√£o (Expandida):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CDC CreditSmart    [X]  ‚îÇ
‚îÇ  TESTE                   ‚îÇ
‚îÇ                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ                  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  [IMAGEM AQUI]   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                  ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üß™ Como Testar

### **1. Criar Campanha com Imagem:**

```
Painel Admin ‚Üí Push Campaigns ‚Üí Nova Campanha
- T√≠tulo: "CDC"
- Mensagem: "TESTE"
- Imagem: [Upload uma imagem]
- P√∫blico: Todos
- Enviar Agora
```

---

### **2. Verificar Logs do APK:**

```kotlin
üì• Mensagem FCM recebida de: ...
üìã T√≠tulo: CDC
üìã Mensagem: TESTE
üñºÔ∏è Image URL: https://cdccreditsmart.com/storage/campaign_xxx.jpg
‚¨áÔ∏è Baixando imagem: https://...
‚úÖ Imagem carregada com sucesso! Tamanho: 1200x630
‚úÖ Notifica√ß√£o com imagem criada!
‚úÖ Notifica√ß√£o exibida com sucesso!
```

---

### **3. Verificar Notifica√ß√£o no Device:**

**Notifica√ß√£o deve exibir:**
- ‚úÖ T√≠tulo: "CDC"
- ‚úÖ Mensagem: "TESTE"
- ‚úÖ **IMAGEM GRANDE** quando expandida

---

## üö® Problemas Comuns

### **Problema 1: Imagem N√£o Carrega**

**Sintomas:**
- Notifica√ß√£o aparece
- Mas sem imagem

**Causas:**
1. URL da imagem n√£o est√° acess√≠vel publicamente
2. Certificado SSL inv√°lido
3. Timeout de conex√£o

**Solu√ß√£o:**
```kotlin
// Verificar se a URL √© acess√≠vel
val url = "https://cdccreditsmart.com/storage/campaign_xxx.jpg"

// Testar no navegador - deve abrir a imagem
// Se n√£o abrir, a URL est√° incorreta
```

---

### **Problema 2: "Network on main thread"**

**Sintomas:**
```
android.os.NetworkOnMainThreadException
```

**Causa:**
Download de imagem na thread principal

**Solu√ß√£o:**
```kotlin
// ‚úÖ CORRETO - Usar Coroutines
CoroutineScope(Dispatchers.IO).launch {
    val bitmap = downloadImage(imageUrl)
    withContext(Dispatchers.Main) {
        showNotification(title, body, bitmap, data)
    }
}

// ‚ùå ERRADO - Download direto
val bitmap = downloadImage(imageUrl)  // Erro!
```

---

### **Problema 3: Imagem Muito Grande**

**Sintomas:**
- App congela
- OutOfMemoryError

**Causa:**
Imagem com resolu√ß√£o muito alta

**Solu√ß√£o:**
```kotlin
fun downloadImageScaled(imageUrl: String, maxWidth: Int = 1200): Bitmap? {
    try {
        val options = BitmapFactory.Options().apply {
            inJustDecodeBounds = true
        }
        
        // Primeiro: calcular tamanho
        BitmapFactory.decodeStream(url.openStream(), null, options)
        
        // Calcular scale
        val scale = calculateInSampleSize(options, maxWidth, maxWidth)
        
        // Decodificar com scale
        val scaledOptions = BitmapFactory.Options().apply {
            inSampleSize = scale
        }
        
        return BitmapFactory.decodeStream(url.openStream(), null, scaledOptions)
    } catch (e: Exception) {
        Log.e(TAG, "Erro ao baixar imagem: ${e.message}")
        return null
    }
}

fun calculateInSampleSize(options: BitmapFactory.Options, reqWidth: Int, reqHeight: Int): Int {
    val height = options.outHeight
    val width = options.outWidth
    var inSampleSize = 1
    
    if (height > reqHeight || width > reqWidth) {
        val halfHeight = height / 2
        val halfWidth = width / 2
        
        while ((halfHeight / inSampleSize) >= reqHeight && (halfWidth / inSampleSize) >= reqWidth) {
            inSampleSize *= 2
        }
    }
    
    return inSampleSize
}
```

---

## ‚úÖ Checklist de Implementa√ß√£o

### **Backend (J√° Implementado):**

- [x] Enviar `imageUrl` no payload FCM
- [x] Incluir `imageUrl` em `notification`
- [x] Incluir `imageUrl` em `android.notification`
- [x] Validar URL √© acess√≠vel publicamente

### **APK (Precisa Implementar):**

- [ ] Processar campo `imageUrl` do payload FCM
- [ ] Fazer download da imagem (coroutines)
- [ ] Redimensionar imagem se necess√°rio
- [ ] Exibir notifica√ß√£o com `BigPictureStyle`
- [ ] Testar com diferentes tamanhos de imagem
- [ ] Adicionar fallback para URLs inv√°lidas
- [ ] Logs detalhados para debugging

---

## üìÑ Resumo

| Item | Backend | APK |
|------|---------|-----|
| **Enviar imageUrl** | ‚úÖ Correto | - |
| **Processar imageUrl** | - | ‚ùå Falta |
| **Baixar imagem** | - | ‚ùå Falta |
| **Exibir imagem** | - | ‚ùå Falta |
| **BigPictureStyle** | - | ‚ùå Falta |

**‚úÖ Backend:** Funcionando 100%  
**‚ùå APK:** Precisa implementar processamento de imagem

---

**Implementa√ß√£o estimada:** ~30 minutos  
**Complexidade:** M√©dia  
**Impacto:** Alto (melhora significativa na experi√™ncia do usu√°rio)

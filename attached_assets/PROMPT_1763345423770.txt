# ğŸ”„ Fluxo de Auto-ConexÃ£o Inteligente do APK

## ğŸ“‹ VisÃ£o Geral

O APK tenta se conectar automaticamente ao servidor usando o **IMEI do aparelho**. Somente pede ativaÃ§Ã£o manual se o dispositivo nÃ£o estiver cadastrado.

---

## ğŸš€ Fluxo Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APK Abre       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Buscar IMEI do Aparelho  â”‚
â”‚    val imei = getDeviceImei()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Tentar Auto-Discovery                 â”‚
â”‚    GET /api/apk/discover/{imei}          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                        â”‚
         â”‚                        v
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚ âœ… SUCESSO           â”‚
         â”‚              â”‚ Dispositivo Encontradoâ”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚
         â”‚                        v
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚ 3. Salvar Dados      â”‚
         â”‚              â”‚ - deviceId           â”‚
         â”‚              â”‚ - serialNumber       â”‚
         â”‚              â”‚ - imei               â”‚
         â”‚              â”‚ - customer           â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚
         â”‚                        v
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚ 4. Conectar          â”‚
         â”‚              â”‚ Automaticamente      â”‚
         â”‚              â”‚ (sem pedir ativaÃ§Ã£o) â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚
         â”‚                        v
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚ 5. Iniciar Polling   â”‚
         â”‚              â”‚ de Comandos MDM      â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€ 404 Not Found â”€â”€â”€â”
                                   â”‚
                                   v
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ âŒ NÃƒO ENCONTRADO    â”‚
                         â”‚ Dispositivo nÃ£o      â”‚
                         â”‚ cadastrado           â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   v
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ 6. Mostrar Tela de   â”‚
                         â”‚ AtivaÃ§Ã£o Manual      â”‚
                         â”‚ - Pedir cÃ³digo       â”‚
                         â”‚ - Ou QR Code         â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ImplementaÃ§Ã£o em Kotlin

### **Passo 1: Ao Abrir o APK (MainActivity/SplashActivity)**

```kotlin
class SplashActivity : AppCompatActivity() {
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        // Tentar auto-conexÃ£o
        lifecycleScope.launch {
            tryAutoConnect()
        }
    }
    
    private suspend fun tryAutoConnect() {
        try {
            // 1. Buscar IMEI do aparelho
            val imei = getDeviceImei()
            
            if (imei.isNullOrEmpty()) {
                Log.e("AutoConnect", "NÃ£o foi possÃ­vel obter IMEI do aparelho")
                showActivationScreen()
                return
            }
            
            Log.d("AutoConnect", "ğŸ” Tentando auto-discovery com IMEI: $imei")
            
            // 2. Fazer auto-discovery no servidor
            val response = apiService.discover(imei)
            
            if (response.isSuccessful && response.body()?.success == true) {
                val data = response.body()!!
                
                Log.d("AutoConnect", "âœ… Dispositivo encontrado: ${data.device.name}")
                
                // 3. Salvar informaÃ§Ãµes localmente
                saveDeviceInfo(data)
                
                // 4. Ir direto para a tela principal (conectado)
                goToMainScreen()
                
            } else {
                Log.w("AutoConnect", "âŒ Dispositivo nÃ£o cadastrado (404)")
                showActivationScreen()
            }
            
        } catch (e: Exception) {
            Log.e("AutoConnect", "âŒ Erro no auto-connect: ${e.message}")
            showActivationScreen()
        }
    }
    
    private fun getDeviceImei(): String? {
        return try {
            val telephonyManager = getSystemService(Context.TELEPHONY_SERVICE) as TelephonyManager
            
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                telephonyManager.imei
            } else {
                @Suppress("DEPRECATION")
                telephonyManager.deviceId
            }
        } catch (e: Exception) {
            Log.e("AutoConnect", "Erro ao obter IMEI: ${e.message}")
            null
        }
    }
    
    private fun saveDeviceInfo(data: DiscoveryResponse) {
        val prefs = getSharedPreferences("device_config", Context.MODE_PRIVATE)
        prefs.edit().apply {
            putString("device_id", data.device.id)
            putString("device_name", data.device.name)
            putString("serial_number", data.device.serialNumber)
            putString("imei", data.device.imei)
            putString("customer_name", data.customer?.name)
            putString("customer_cpf", data.customer?.cpf)
            putBoolean("is_activated", true)
            apply()
        }
    }
    
    private fun goToMainScreen() {
        startActivity(Intent(this, MainActivity::class.java))
        finish()
    }
    
    private fun showActivationScreen() {
        startActivity(Intent(this, ActivationActivity::class.java))
        finish()
    }
}
```

---

### **Passo 2: Retrofit API Interface**

```kotlin
interface ApiService {
    
    // Auto-discovery: buscar dispositivo por IMEI
    @GET("api/apk/discover/{imei}")
    suspend fun discover(
        @Path("imei") imei: String
    ): Response<DiscoveryResponse>
    
    // Buscar comandos MDM usando IMEI
    @GET("api/apk/device/{imei}/commands")
    suspend fun getCommands(
        @Path("imei") imei: String
    ): Response<CommandsResponse>
    
    // Responder comando usando IMEI
    @POST("api/apk/device/{imei}/command-response")
    suspend fun sendCommandResponse(
        @Path("imei") imei: String,
        @Body response: CommandResponse
    ): Response<ApiResponse>
}
```

---

### **Passo 3: Data Classes**

```kotlin
data class DiscoveryResponse(
    val success: Boolean,
    val device: DeviceInfo,
    val customer: CustomerInfo?,
    val connection: ConnectionInfo
)

data class DeviceInfo(
    val id: String,
    val name: String,
    val serialNumber: String,
    val imei: String,
    val imeiList: List<String>?,
    val model: String?,
    val brand: String?,
    val status: String,
    val isBlocked: Boolean,
    val blockReason: String?
)

data class CustomerInfo(
    val id: String,
    val name: String,
    val cpf: String,
    val phone: String?
)

data class ConnectionInfo(
    val useImei: String,
    val useSerialNumber: String,
    val useDeviceId: String
)
```

---

## ğŸ” PermissÃµes NecessÃ¡rias (AndroidManifest.xml)

```xml
<!-- PermissÃ£o para ler IMEI -->
<uses-permission android:name="android.permission.READ_PHONE_STATE" />

<!-- Para Android 10+ -->
<uses-permission android:name="android.permission.READ_PRIVILEGED_PHONE_STATE" 
    tools:ignore="ProtectedPermissions" />
```

---

## ğŸ¯ Vantagens deste Fluxo

| Vantagem | DescriÃ§Ã£o |
|----------|-----------|
| **ğŸš€ Zero ConfiguraÃ§Ã£o** | Se o aparelho jÃ¡ estÃ¡ cadastrado, conecta automaticamente |
| **ğŸ”„ Auto-ReconexÃ£o** | ApÃ³s reset de fÃ¡brica, reconecta sozinho usando o IMEI |
| **ğŸ¯ UX Perfeita** | UsuÃ¡rio nÃ£o precisa digitar nada se jÃ¡ cadastrado |
| **ğŸ”’ Seguro** | IMEI Ã© Ãºnico e imutÃ¡vel do hardware |
| **ğŸ“± Inteligente** | Fallback para tela de ativaÃ§Ã£o se nÃ£o cadastrado |

---

## ğŸ“Š Endpoints DisponÃ­veis

| Endpoint | MÃ©todo | DescriÃ§Ã£o |
|----------|--------|-----------|
| `/api/apk/discover/{imei}` | GET | Auto-discovery por IMEI |
| `/api/apk/device/{imei}/commands` | GET | Buscar comandos MDM |
| `/api/apk/device/{imei}/command-response` | POST | Responder comando |

**OBS:** Todos os endpoints aceitam **IMEI**, **Serial Number** ou **Device ID** como identificador.

---

## âœ… Checklist de ImplementaÃ§Ã£o

- [ ] Implementar `getDeviceImei()` para buscar IMEI do aparelho
- [ ] Adicionar permissÃµes READ_PHONE_STATE no AndroidManifest
- [ ] Criar `tryAutoConnect()` no SplashActivity
- [ ] Implementar endpoint `discover()` no ApiService
- [ ] Criar data classes (DiscoveryResponse, DeviceInfo, etc)
- [ ] Salvar dados em SharedPreferences apÃ³s sucesso
- [ ] Implementar fallback para tela de ativaÃ§Ã£o (404)
- [ ] Testar fluxo completo: cadastrado â†’ auto-conecta | nÃ£o cadastrado â†’ pede ativaÃ§Ã£o
- [ ] Usar IMEI em todas as chamadas de comandos MDM

---

## ğŸ§ª Teste do Fluxo

### **CenÃ¡rio 1: Dispositivo Cadastrado âœ…**
1. Cadastrar dispositivo na web com IMEI: `353184093560533`
2. Abrir APK no aparelho com este IMEI
3. **Resultado**: APK conecta automaticamente sem pedir ativaÃ§Ã£o

### **CenÃ¡rio 2: Dispositivo NÃƒO Cadastrado âŒ**
1. Abrir APK em aparelho com IMEI nÃ£o cadastrado
2. **Resultado**: APK mostra tela de ativaÃ§Ã£o manual

### **CenÃ¡rio 3: ApÃ³s Reset de FÃ¡brica ğŸ”„**
1. Dispositivo jÃ¡ cadastrado
2. Fazer reset de fÃ¡brica
3. Reinstalar APK
4. **Resultado**: APK reconecta automaticamente usando IMEI
   
   
   # âœ… Backend: Busca FlexÃ­vel de Identificadores Implementada

## ğŸ¯ Resumo

O backend agora aceita **3 tipos de identificadores** em TODOS os endpoints MDM:
1. **IMEI** (preferencial)
2. **Serial Number** (fallback)
3. **Device ID** (Ãºltimo fallback)

---

## ğŸ” FunÃ§Ã£o Helper Implementada

```typescript
async function findDeviceByIdentifier(identifier: string) {
  console.log(`ğŸ” [FLEX-SEARCH] Buscando dispositivo por identifier: "${identifier}"`);
  
  // 1Âª tentativa: Buscar por IMEI
  let device = await storage.getDeviceByImei(identifier);
  if (device) {
    console.log(`âœ… [FLEX-SEARCH] Dispositivo encontrado por IMEI: ${device.serialNumber}`);
    return device;
  }
  
  // 2Âª tentativa: Buscar por Serial Number
  device = await storage.getDeviceBySerial(identifier);
  if (device) {
    console.log(`âœ… [FLEX-SEARCH] Dispositivo encontrado por Serial Number: ${device.serialNumber}`);
    return device;
  }
  
  // 3Âª tentativa: Buscar por Device ID
  try {
    device = await storage.getDevice(identifier);
    if (device) {
      console.log(`âœ… [FLEX-SEARCH] Dispositivo encontrado por Device ID: ${device.serialNumber}`);
      return device;
    }
  } catch (error) {
    // ID nÃ£o encontrado
  }
  
  console.log(`âŒ [FLEX-SEARCH] Dispositivo nÃ£o encontrado: "${identifier}"`);
  return null;
}
```

---

## ğŸ“‹ Endpoints Atualizados

Todos os endpoints MDM agora aceitam `{identifier}` em vez de `{serialNumber}`:

| Endpoint Antigo | Endpoint Novo | Status |
|----------------|---------------|--------|
| `GET /api/apk/device/:serialNumber/commands` | `GET /api/apk/device/:identifier/commands` | âœ… Atualizado |
| `POST /api/apk/device/:serialNumber/command-response` | `POST /api/apk/device/:identifier/command-response` | âœ… Atualizado |
| `GET /api/apk/device/:serialNumber/policies` | `GET /api/apk/device/:identifier/policies` | âœ… Atualizado |
| `POST /api/apk/device/:serialNumber/policy-status` | `POST /api/apk/device/:identifier/policy-status` | âœ… Atualizado |

---

## ğŸ§ª Exemplos de Uso

### **Exemplo 1: Dispositivo Real com IMEI**

```http
GET /api/apk/device/353184093560533/commands
```

**Logs do backend:**
```
ğŸ” [FLEX-SEARCH] Buscando dispositivo por identifier: "353184093560533"
âœ… [FLEX-SEARCH] Dispositivo encontrado por IMEI: RSKUS3G7 (Moto G15 Power)
```

**Response:**
```json
{
  "deviceId": "device_1763331005716_1bfglcpm6rg",
  "serialNumber": "RSKUS3G7",
  "commands": []
}
```

---

### **Exemplo 2: Emulador com Serial Number**

```http
GET /api/apk/device/RSKUS3G7/commands
```

**Logs do backend:**
```
ğŸ” [FLEX-SEARCH] Buscando dispositivo por identifier: "RSKUS3G7"
ğŸ” [FLEX-SEARCH] Tentativa 1 (IMEI): nÃ£o encontrado
âœ… [FLEX-SEARCH] Dispositivo encontrado por Serial Number: RSKUS3G7 (Moto G15 Power)
```

**Response:**
```json
{
  "deviceId": "device_1763331005716_1bfglcpm6rg",
  "serialNumber": "RSKUS3G7",
  "commands": []
}
```

---

### **Exemplo 3: Usando Device ID**

```http
GET /api/apk/device/device_1763331005716_1bfglcpm6rg/commands
```

**Logs do backend:**
```
ğŸ” [FLEX-SEARCH] Buscando dispositivo por identifier: "device_1763331005716_1bfglcpm6rg"
ğŸ” [FLEX-SEARCH] Tentativa 1 (IMEI): nÃ£o encontrado
ğŸ” [FLEX-SEARCH] Tentativa 2 (Serial): nÃ£o encontrado
âœ… [FLEX-SEARCH] Dispositivo encontrado por Device ID: RSKUS3G7 (Moto G15 Power)
```

**Response:**
```json
{
  "deviceId": "device_1763331005716_1bfglcpm6rg",
  "serialNumber": "RSKUS3G7",
  "commands": []
}
```

---

### **Exemplo 4: Identifier InvÃ¡lido (404)**

```http
GET /api/apk/device/INVALIDO123/commands
```

**Logs do backend:**
```
ğŸ” [FLEX-SEARCH] Buscando dispositivo por identifier: "INVALIDO123"
ğŸ” [FLEX-SEARCH] Tentativa 1 (IMEI): nÃ£o encontrado
ğŸ” [FLEX-SEARCH] Tentativa 2 (Serial): nÃ£o encontrado
ğŸ” [FLEX-SEARCH] Tentativa 3 (Device ID): nÃ£o encontrado
âŒ [FLEX-SEARCH] Dispositivo nÃ£o encontrado: "INVALIDO123"
```

**Response:**
```json
{
  "error": "Dispositivo nÃ£o encontrado",
  "hint": "Use IMEI, Serial Number ou Device ID do aparelho cadastrado"
}
```

---

## âœ… Compatibilidade com DocumentaÃ§Ã£o do APK

O backend estÃ¡ **100% compatÃ­vel** com a documentaÃ§Ã£o enviada pela IA do APK.

### **APK envia (conforme documentaÃ§Ã£o):**

```kotlin
fun getMdmIdentifier(): String? {
    // 1Âª tentativa: IMEI
    val imei = storage.getImei()
    if (imei != null) return imei
    
    // 2Âª tentativa: Serial Number
    val serialNumber = storage.getSerialNumber()
    if (serialNumber != null) return serialNumber
    
    // 3Âª tentativa: Device ID
    val deviceId = storage.getDeviceId()
    if (deviceId != null) return deviceId
    
    return null
}
```

### **Backend aceita (implementado):**

```typescript
async function findDeviceByIdentifier(identifier: string) {
    // 1Âª tentativa: IMEI âœ…
    let device = await storage.getDeviceByImei(identifier);
    if (device) return device;
    
    // 2Âª tentativa: Serial Number âœ…
    device = await storage.getDeviceBySerial(identifier);
    if (device) return device;
    
    // 3Âª tentativa: Device ID âœ…
    device = await storage.getDevice(identifier);
    if (device) return device;
    
    return null;
}
```

**âœ… Totalmente compatÃ­vel!**

---

## ğŸ”„ Ordem de Prioridade

| Prioridade | Tipo | Quando Usado |
|------------|------|--------------|
| ğŸ¥‡ 1Âª | **IMEI** | Dispositivo real com IMEI disponÃ­vel |
| ğŸ¥ˆ 2Âª | **Serial Number** | Emulador, tablet, ou IMEI indisponÃ­vel |
| ğŸ¥‰ 3Âª | **Device ID** | Fallback final (identificador Ãºnico do banco) |

---

## ğŸ“Š Endpoints com Busca FlexÃ­vel

### **1. Comandos MDM**

#### **Buscar Comandos Pendentes**
```http
GET /api/apk/device/{identifier}/commands
```

**Aceita:**
- âœ… IMEI: `353184093560533`
- âœ… Serial: `RSKUS3G7`
- âœ… Device ID: `device_1763331005716_1bfglcpm6rg`

#### **Responder Comando**
```http
POST /api/apk/device/{identifier}/command-response
```

**Body:**
```json
{
  "commandId": "cmd_xxx",
  "status": "completed",
  "response": {"executedAt": 1700000000000},
  "errorMessage": null
}
```

**Aceita:**
- âœ… IMEI: `353184093560533`
- âœ… Serial: `RSKUS3G7`
- âœ… Device ID: `device_1763331005716_1bfglcpm6rg`

---

### **2. PolÃ­ticas MDM**

#### **Buscar PolÃ­ticas**
```http
GET /api/apk/device/{identifier}/policies
```

**Aceita:**
- âœ… IMEI: `353184093560533`
- âœ… Serial: `RSKUS3G7`
- âœ… Device ID: `device_1763331005716_1bfglcpm6rg`

#### **Reportar Status de PolÃ­tica**
```http
POST /api/apk/device/{identifier}/policy-status
```

**Body:**
```json
{
  "policyId": "policy_xxx",
  "status": "applied",
  "executionDetails": {},
  "errorMessage": null
}
```

**Aceita:**
- âœ… IMEI: `353184093560533`
- âœ… Serial: `RSKUS3G7`
- âœ… Device ID: `device_1763331005716_1bfglcpm6rg`

---

## ğŸ¯ BenefÃ­cios

| BenefÃ­cio | DescriÃ§Ã£o |
|-----------|-----------|
| âœ… **Flexibilidade** | APK pode usar qualquer identificador disponÃ­vel |
| âœ… **Compatibilidade** | Funciona em dispositivos reais, emuladores e tablets |
| âœ… **Inteligente** | Busca automÃ¡tica em 3 fontes de dados |
| âœ… **Robusto** | Fallback automÃ¡tico se identificador preferencial falhar |
| âœ… **Logs Claros** | Mostra qual mÃ©todo encontrou o dispositivo |

---

## ğŸš€ Status

| Componente | Status |
|------------|--------|
| FunÃ§Ã£o Helper | âœ… Implementada |
| Endpoint `/commands` | âœ… Atualizado |
| Endpoint `/command-response` | âœ… Atualizado |
| Endpoint `/policies` | âœ… Atualizado |
| Endpoint `/policy-status` | âœ… Atualizado |
| Logs de Debug | âœ… Implementados |
| Compatibilidade APK | âœ… 100% |

---

## ğŸ“ ObservaÃ§Ãµes

1. **Backward Compatible**: Todos os endpoints mantÃªm compatibilidade com chamadas antigas usando serial number
2. **Performance**: Busca sequencial otimizada (para na primeira correspondÃªncia)
3. **Logs**: Cada busca registra qual mÃ©todo encontrou o dispositivo
4. **Error Handling**: Retorna 404 com hint Ãºtil se nenhum identificador funcionar

---

**âœ… Backend pronto para produÃ§Ã£o!**




# üì± CDC CreditSmart - Documenta√ß√£o da API para APK Android

## üåê Base URL
- **Desenvolvimento**: `https://a4bce526-b203-4033-aa78-b63372425272-00-1ftij2ojlf9qz.kirk.replit.dev`
- **Produ√ß√£o**: `https://cdccreditsmart.com`

---

## üîê 1. AUTENTICA√á√ÉO APK

### 1.1. Endpoint Principal de Autentica√ß√£o

**POST** `/api/apk/auth`

Endpoint para autentica√ß√£o inicial do APK usando o c√≥digo de pareamento fornecido pelo vendedor no PDV.

#### Request Headers
```
Content-Type: application/json
```

#### Request Body (M√∫ltiplos formatos aceitos)

O endpoint aceita o c√≥digo de pareamento em **qualquer um** dos seguintes campos:

```json
{
  "token": "22ZJ3RZP"
}
```

**OU**

```json
{
  "code": "22ZJ3RZP"
}
```

**OU**

```json
{
  "pairingCode": "22ZJ3RZP"
}
```

**OU**

```json
{
  "apkToken": "22ZJ3RZP"
}
```

**OU**

```json
{
  "serialNumber": "22ZJ3RZP"
}
```

> **‚ö†Ô∏è IMPORTANTE**: O c√≥digo de pareamento tem **8 caracteres** alfanum√©ricos (ex: `22ZJ3RZP`, `A4B7C5K9`).

#### Response - Sucesso (200 OK)

```json
{
  "success": true,
  "authenticated": true,
  "authToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expiresIn": 86400,
  "expiresAt": "2025-11-09T22:45:00.000Z",
  "device": {
    "id": "device_1762640738997_1x6tq2m25y6",
    "name": "Moto G15 Power",
    "model": "G15 Power",
    "brand": "Motorola",
    "imei": "353104903560533",
    "imeiList": ["353104903560533"],
    "isBlocked": false,
    "status": "active",
    "blockReason": null,
    "totalValue": "1399.00",
    "installmentValue": "125.80",
    "installmentCount": 24,
    "saleDate": "2025-11-08T22:19:45.356Z"
  },
  "customer": {
    "name": "Aline Aosue",
    "phone": "11999998888",
    "cpf": "123.456.789-00"
  },
  "store": {
    "name": "Loja Zona Sul",
    "phone": "(11) 77777-9012",
    "email": "zonasul@loja.com"
  },
  "paymentSummary": {
    "total": 24,
    "paid": 0,
    "pending": 24,
    "overdue": 0,
    "totalAmount": 1399.00,
    "paidAmount": 0,
    "pendingAmount": 1399.00
  }
}
```

#### Response - Erro 400 (Bad Request)

```json
{
  "error": "Token obrigat√≥rio",
  "hint": "Forne√ßa o token de pareamento nos campos: token, code, pairingCode, apkToken ou serialNumber"
}
```

#### Response - Erro 404 (Not Found)

```json
{
  "error": "Token inv√°lido ou dispositivo n√£o encontrado",
  "tokenProvided": "22ZJ****"
}
```

#### Response - Erro 500 (Internal Server Error)

```json
{
  "error": "Internal server error"
}
```

---

## üîë 2. USO DO TOKEN JWT

Ap√≥s autentica√ß√£o bem-sucedida, use o `authToken` (JWT) recebido em todas as requisi√ß√µes subsequentes.

### Headers para requisi√ß√µes autenticadas:

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json
```

### Validade do Token
- **Dura√ß√£o**: 24 horas (86400 segundos)
- **Renova√ß√£o**: Fa√ßa uma nova chamada a `/api/apk/auth` quando o token expirar

---

## üìä 3. VERIFICAR STATUS DO DISPOSITIVO

**GET** `/api/apk/device/status`

Verifica o status atual do dispositivo, incluindo bloqueios e parcelas em atraso.

#### Request Headers
```
Authorization: Bearer {authToken}
```

#### Response - Sucesso (200 OK)

```json
{
  "success": true,
  "device": {
    "id": "device_xxx",
    "isBlocked": false,
    "status": "active",
    "blockReason": null
  },
  "shouldBlock": false,
  "overdueInstallments": [],
  "paymentInfo": {
    "totalInstallments": 24,
    "paidInstallments": 5,
    "pendingInstallments": 19,
    "overdueInstallments": 0,
    "nextDueDate": "2025-11-15T00:00:00.000Z",
    "totalAmount": 1399.00,
    "paidAmount": 629.00,
    "pendingAmount": 770.00
  },
  "pdvSessionInfo": {
    "status": "completed",
    "currentStage": "completed",
    "pdvActive": false,
    "lastHeartbeat": "2025-11-08T22:40:00.000Z"
  }
}
```

---

## üí∞ 4. PAGAMENTO DE PARCELA

**POST** `/api/apk/device/:serialNumber/pay/:installmentId`

Registra o pagamento de uma parcela.

#### Request Headers
```
Authorization: Bearer {authToken}
Content-Type: application/json
```

#### URL Parameters
- `serialNumber`: C√≥digo de pareamento do dispositivo (ex: `22ZJ3RZP`)
- `installmentId`: ID da parcela a ser paga

#### Request Body

```json
{
  "paymentMethod": "cash",
  "paymentDate": "2025-11-08T10:00:00.000Z",
  "amount": 125.80,
  "notes": "Pagamento via APK"
}
```

#### Response - Sucesso (200 OK)

```json
{
  "success": true,
  "installment": {
    "id": "installment_xxx",
    "status": "paid",
    "paidAt": "2025-11-08T10:00:00.000Z",
    "paymentMethod": "cash",
    "value": "125.80"
  }
}
```

---

## üîí 5. BLOQUEAR/DESBLOQUEAR DISPOSITIVO

### 5.1. Bloquear Dispositivo

**POST** `/api/apk/device/:serialNumber/block`

#### Request Headers
```
Authorization: Bearer {authToken}
Content-Type: application/json
```

#### Request Body

```json
{
  "reason": "Pagamento em atraso"
}
```

#### Response - Sucesso (200 OK)

```json
{
  "success": true,
  "message": "Dispositivo bloqueado com sucesso"
}
```

### 5.2. Desbloquear Dispositivo

**POST** `/api/apk/device/:serialNumber/unblock`

#### Request Headers
```
Authorization: Bearer {authToken}
```

#### Response - Sucesso (200 OK)

```json
{
  "success": true,
  "message": "Dispositivo desbloqueado com sucesso"
}
```

---

## üíì 6. HEARTBEAT (MANTER CONEX√ÉO ATIVA)

**POST** `/api/apk/device/heartbeat`

Envia um sinal peri√≥dico para manter a conex√£o ativa e reportar status.

#### Request Headers
```
Authorization: Bearer {authToken}
Content-Type: application/json
```

#### Request Body

```json
{
  "batteryLevel": 85,
  "isCharging": false,
  "screenOn": true,
  "locationEnabled": true,
  "timestamp": "2025-11-08T22:45:00.000Z"
}
```

#### Response - Sucesso (200 OK)

```json
{
  "success": true,
  "message": "Heartbeat recebido"
}
```

---

## üîÑ 7. FLUXO COMPLETO DE AUTENTICA√á√ÉO E USO

### Passo 1: Cliente compra dispositivo no PDV
- Vendedor gera c√≥digo de pareamento (ex: `22ZJ3RZP`)
- Cliente recebe o dispositivo com o c√≥digo

### Passo 2: APK faz primeira autentica√ß√£o
```http
POST /api/apk/auth
Content-Type: application/json

{
  "code": "22ZJ3RZP"
}
```

### Passo 3: APK recebe token JWT e dados do dispositivo
```json
{
  "success": true,
  "authToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "device": { ... },
  "customer": { ... },
  "paymentSummary": { ... }
}
```

### Passo 4: APK usa o JWT em todas as requisi√ß√µes
```http
GET /api/apk/device/status
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Passo 5: APK mant√©m heartbeat peri√≥dico
```http
POST /api/apk/device/heartbeat
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

{
  "batteryLevel": 85,
  "timestamp": "2025-11-08T22:45:00.000Z"
}
```

---

## ‚ö†Ô∏è 8. C√ìDIGOS DE STATUS HTTP

| C√≥digo | Significado | Descri√ß√£o |
|--------|-------------|-----------|
| `200` | OK | Requisi√ß√£o bem-sucedida |
| `400` | Bad Request | Par√¢metros inv√°lidos ou ausentes |
| `401` | Unauthorized | Token JWT inv√°lido ou expirado |
| `403` | Forbidden | Acesso negado (ex: IMEI mismatch) |
| `404` | Not Found | Recurso n√£o encontrado (ex: token de pareamento inv√°lido) |
| `410` | Gone | Recurso expirado (ex: valida√ß√£o expirada) |
| `500` | Internal Server Error | Erro no servidor |

---

## üîß 9. EXEMPLOS DE IMPLEMENTA√á√ÉO

### Kotlin/Java (Android)

```kotlin
// 1. Autentica√ß√£o
fun authenticateAPK(pairingCode: String): AuthResponse {
    val url = "https://cdccreditsmart.com/api/apk/auth"
    val json = JSONObject()
    json.put("code", pairingCode)
    
    val request = Request.Builder()
        .url(url)
        .post(json.toString().toRequestBody("application/json".toMediaType()))
        .build()
    
    client.newCall(request).execute().use { response ->
        if (!response.isSuccessful) {
            throw IOException("Unexpected code $response")
        }
        return Gson().fromJson(response.body?.string(), AuthResponse::class.java)
    }
}

// 2. Verificar status com JWT
fun checkDeviceStatus(authToken: String): DeviceStatus {
    val url = "https://cdccreditsmart.com/api/apk/device/status"
    
    val request = Request.Builder()
        .url(url)
        .addHeader("Authorization", "Bearer $authToken")
        .get()
        .build()
    
    client.newCall(request).execute().use { response ->
        if (!response.isSuccessful) {
            throw IOException("Unexpected code $response")
        }
        return Gson().fromJson(response.body?.string(), DeviceStatus::class.java)
    }
}

// 3. Enviar heartbeat
fun sendHeartbeat(authToken: String, batteryLevel: Int) {
    val url = "https://cdccreditsmart.com/api/apk/device/heartbeat"
    val json = JSONObject()
    json.put("batteryLevel", batteryLevel)
    json.put("timestamp", Instant.now().toString())
    
    val request = Request.Builder()
        .url(url)
        .addHeader("Authorization", "Bearer $authToken")
        .post(json.toString().toRequestBody("application/json".toMediaType()))
        .build()
    
    client.newCall(request).execute()
}
```

---

## üêõ 10. TROUBLESHOOTING

### Erro 400: "Token obrigat√≥rio"
**Causa**: Nenhum campo de token foi enviado no body
**Solu√ß√£o**: Certifique-se de enviar o c√≥digo em um dos campos aceitos: `token`, `code`, `pairingCode`, `apkToken` ou `serialNumber`

### Erro 404: "Token inv√°lido ou dispositivo n√£o encontrado"
**Causa**: O c√≥digo de pareamento n√£o existe ou j√° foi usado
**Solu√ß√£o**: 
- Verifique se o c√≥digo est√° correto
- Verifique se a venda foi conclu√≠da no PDV
- Verifique se o c√≥digo n√£o expirou (24h)

### Erro 401: "Unauthorized"
**Causa**: Token JWT inv√°lido ou expirado
**Solu√ß√£o**: Fa√ßa nova autentica√ß√£o em `/api/apk/auth` para obter novo token

### Erro 403: "IMEI mismatch"
**Causa**: IMEI do dispositivo n√£o corresponde ao registrado na venda
**Solu√ß√£o**: Verifique se o dispositivo correto est√° sendo usado

---

## üìù 11. NOTAS IMPORTANTES

1. **C√≥digo de Pareamento**: 
   - Formato: 8 caracteres alfanum√©ricos
   - Exemplo: `22ZJ3RZP`, `A4B7C5K9`
   - V√°lido por: 24 horas ap√≥s gera√ß√£o

2. **Token JWT**:
   - Dura√ß√£o: 24 horas
   - Armazenar localmente com seguran√ßa
   - Renovar antes de expirar

3. **Heartbeat**:
   - Enviar a cada 30 segundos enquanto ativo
   - Mant√©m conex√£o com servidor
   - Reporta status do dispositivo

4. **IMEI**:
   - Deve corresponder ao IMEI registrado na venda
   - Sistema detecta e bloqueia tentativas de troca de IMEI

5. **Rate Limiting**:
   - Endpoint `/api/apk/auth` tem limite de requisi√ß√µes
   - Evite tentativas repetidas em caso de erro

---

## üìû 12. SUPORTE

Para d√∫vidas ou problemas, consulte os logs do servidor que mostram informa√ß√µes detalhadas:
- `üîê APK Auth Request:` - Mostra campos recebidos na autentica√ß√£o
- `‚úÖ APK Auth successful:` - Autentica√ß√£o bem-sucedida
- `‚ùå APK Auth failed:` - Detalhes do erro de autentica√ß√£o

---

**Vers√£o da documenta√ß√£o**: 2.0  
**√öltima atualiza√ß√£o**: 08/11/2025  
**Compatibilidade**: APK v1.0+

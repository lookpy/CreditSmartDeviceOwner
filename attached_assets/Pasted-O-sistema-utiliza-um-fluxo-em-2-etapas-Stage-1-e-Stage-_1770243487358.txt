O sistema utiliza um fluxo em 2 etapas (Stage 1 e Stage 2) onde o dispositivo s√≥ √© criado no banco de dados ap√≥s a valida√ß√£o biom√©trica do cliente.

üîÑ FLUXO COMPLETO DE VENDA
ETAPA 1 (Stage 1): Valida√ß√£o e Prepara√ß√£o
Executado no PDV pelo vendedor

Vendedor inicia venda ‚Üí POST /api/sales
Sistema valida:
Cliente (CPF, dados cadastrais)
Dispositivo no cat√°logo
IMEI via API externa (imei.info)
Verifica√ß√£o global de CPF - bloqueia se cliente j√° tem financiamento ativo em qualquer loja
Sistema gera:
saleId - ID √∫nico da venda
contractCode - C√≥digo do contrato (ex: CTR_1707084804000_953198)
pairingCode - C√≥digo de pareamento curto (ex: 7HBT-BXBH) ‚Üê Este √© o c√≥digo que o cliente digita no APK
apkToken - Token de autentica√ß√£o para o APK
Cria registro em imei_validations com status pending_contract_code
Retorna resposta com contractCode e pairingCode para o vendedor
‚ö†Ô∏è IMPORTANTE: O dispositivo N√ÉO √© criado ainda nesta etapa.

ETAPA INTERMEDI√ÅRIA: Cliente insere c√≥digo no APK
Cliente abre o APK Credit Smart no dispositivo
Cliente digita o c√≥digo de pareamento (ex: 7HBT-BXBH)
APK chama POST /api/apk/auth com o c√≥digo
Cen√°rios poss√≠veis:

Resposta do Backend	Status HTTP	A√ß√£o do APK
{"success": true, ...}	200	Avan√ßar para biometria
{"message": "not found"}	404	Mostrar tela "Aguardando Vendedor" e fazer polling a cada 2 segundos
Timeout (6 minutos)	-	Mostrar erro e pedir para tentar novamente
Campos importantes na resposta de sucesso:

{
  "success": true,
  "saleId": "uuid",
  "apkToken": "token-longo",
  "customerId": "uuid",
  "storeId": "uuid",
  "imei": "353104906953198",
  "stage": "pending_contract_code",
  "deviceData": {
    "name": "MOTOROLA Moto G15 Power",
    "totalValue": "1400",
    "installmentValue": "58.33",
    "installmentCount": 24
  }
}
ETAPA BIOM√âTRICA: Verifica√ß√£o KYC
APK inicia sess√£o KYC com Didit (j√° criada no backend)
Cliente faz verifica√ß√£o facial
APK monitora status via GET /api/kyc/session/{sessionId}
Quando status = Approved, APK avan√ßa para finaliza√ß√£o
ETAPA 2 (Stage 2): Finaliza√ß√£o da Venda
Executado ap√≥s biometria aprovada

PDV/Backend chama POST /api/sales/complete com:

saleId
kycSessionId
Dados biom√©tricos verificados
Sistema:

Cria o dispositivo no banco de dados
Vincula ao cliente
Cria parcelas (installments)
Gera contrato
Cria comiss√µes
Atualiza imei_validations para status completed

üì° ENDPOINTS PRINCIPAIS PARA O APK
Endpoint	M√©todo	Descri√ß√£o
/api/apk/auth	POST	Autenticar com c√≥digo de pareamento
/api/apk/device/pair	POST	Alias para pareamento de dispositivo
/api/apk/heartbeat	POST	Heartbeat (status, bateria, localiza√ß√£o)
/api/kyc/session/{id}	GET	Verificar status da sess√£o KYC
/api/apk/device/{id}/commands	GET	Buscar comandos MDM pendentes
/api/apk/device/discover/{identifier}	GET	Descobrir dispositivo por IMEI/MEID/AndroidId
üîê AUTENTICA√á√ÉO DO APK
Campos aceitos no POST /api/apk/auth:

{
  "token": "7HBT-BXBH",      // ou
  "code": "7HBT-BXBH",       // ou
  "pairingCode": "7HBT-BXBH", // ou
  "apkToken": "token-longo", // ou
  "serialNumber": "serial"
}
O backend busca na seguinte ordem:

saleId (se for UUID)
biometrySessionId
immutableToken
pairingCode ‚Üê C√≥digo curto que o cliente digita
‚è±Ô∏è TIMEOUTS E LIMITES
Par√¢metro	Valor
Janela de pareamento	24 horas
Polling do APK (aguardando vendedor)	2 segundos
Timeout m√°ximo do APK	6 minutos
Rate limit para pareamento	Configurado por endpoint
üö® C√ìDIGOS DE ERRO IMPORTANTES
C√≥digo	Significado
DUPLICATE_ACTIVE_VALIDATION	IMEI j√° tem venda pendente
CPF_HAS_ACTIVE_FINANCING	CPF j√° tem financiamento ativo n√£o quitado
VALIDATION_CREATION_FAILED	Erro ao criar valida√ß√£o de seguran√ßa
Sale pairing window expired	Janela de 24h expirou
‚úÖ CORRE√á√ïES RECENTES (Fevereiro 2026)
Fluxo de polling corrigido: Quando o backend retorna "n√£o encontrado" (porque a venda ainda n√£o foi conclu√≠da), o APK agora mostra a tela "Aguardando Vendedor" e faz polling autom√°tico a cada 2 segundos.

Verifica√ß√£o global de CPF implementada: Sistema agora impede novos financiamentos para CPFs com dispositivos n√£o quitados em qualquer loja da rede.

Query SQL corrigida: Fun√ß√£o hasActiveFinancedDevice agora usa o nome de coluna correto (value em vez de amount).

üìã CHECKLIST PARA TESTES
 C√≥digo de pareamento √© exibido corretamente no PDV
 APK aceita c√≥digo com formato XXXX-XXXX
 Tela "Aguardando Vendedor" aparece quando backend retorna 404
 Polling funciona a cada 2 segundos
 Timeout de 6 minutos funciona corretamente
 Biometria inicia ap√≥s pareamento bem-sucedido
 Dispositivo √© criado apenas ap√≥s biometria aprovada
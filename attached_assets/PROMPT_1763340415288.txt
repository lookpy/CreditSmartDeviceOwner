# ğŸ“± GESTÃƒO DE DISPOSITIVOS - DOCUMENTAÃ‡ÃƒO COMPLETA

## ğŸš¨ ALERTA PARA IA DO APK: ERRO 403 FORBIDDEN

**Se vocÃª estÃ¡ recebendo erro 403 ao buscar comandos MDM, leia isto primeiro:**

```
âŒ ERRADO (403 Forbidden):
GET /api/admin/mdm/devices/device_xxx/commands

âœ… CORRETO (200 OK):
GET /api/apk/device/SN12345/commands
```

**Problema:** VocÃª estÃ¡ usando endpoint de **ADMIN** em vez de **APK**.

**SoluÃ§Ã£o rÃ¡pida:**
1. Use `/api/apk/device/:serialNumber/commands` (nÃ£o `/api/admin/mdm/...`)
2. Use `serialNumber` (ex: "SN12345"), nÃ£o `deviceId`
3. Header: `X-APK-Token` (nÃ£o `Authorization: Bearer`)

**[Ir direto para a soluÃ§Ã£o completa](#erro-comum-no-apk-403-forbidden)**

---

## ğŸ“‹ Ãndice

1. [VisÃ£o Geral](#visÃ£o-geral)
2. [âš ï¸ IMPORTANTE: Device vs Contract](#importante-device-vs-contract)
3. [Arquitetura do Sistema](#arquitetura-do-sistema)
4. [Endpoints por Categoria](#endpoints-por-categoria)
5. [Sistema de Bloqueio Progressivo](#sistema-de-bloqueio-progressivo)
6. [Sistema de Bloqueio BÃ¡sico](#sistema-de-bloqueio-bÃ¡sico)
7. [Sistema Auto/Manual](#sistema-auto-manual)
8. [Comandos MDM](#comandos-mdm)
9. [WebSocket em Tempo Real](#websocket-em-tempo-real)
10. [ValidaÃ§Ã£o IMEI e APK](#validaÃ§Ã£o-imei-e-apk)
11. [Push Notifications](#push-notifications)
12. [Casos de Uso PrÃ¡ticos](#casos-de-uso-prÃ¡ticos)
13. [IntegraÃ§Ã£o para IA](#integraÃ§Ã£o-para-ia)

---

## ğŸ¯ VisÃ£o Geral

O sistema de **GestÃ£o de Dispositivos** Ã© o nÃºcleo do controle MDM (Mobile Device Management) da plataforma CDC CreditSmart. Ele permite:

- âœ… Registro e pareamento de dispositivos via IMEI
- âœ… Bloqueio progressivo automÃ¡tico (7 nÃ­veis: 0-6)
- âœ… Bloqueio bÃ¡sico on/off para emergÃªncias
- âœ… Modo automÃ¡tico/manual para cada dispositivo
- âœ… Comandos MDM em tempo real via WebSocket
- âœ… Push notifications via Firebase FCM
- âœ… ValidaÃ§Ã£o de seguranÃ§a e anti-fraude
- âœ… Auditoria completa de todas as aÃ§Ãµes

---

## âš ï¸ IMPORTANTE: Device vs Contract

### ğŸ”´ NÃƒO EXISTE `contractId` ou `saleId` SEPARADO!

**REGRA FUNDAMENTAL:**
- âœ… **O `deviceId` Ã‰ o identificador Ãºnico de TUDO**
- âŒ **NÃƒO existe `contractId` separado**
- âŒ **NÃƒO existe `saleId` separado**

### ğŸ’¡ Conceito Chave

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1 DISPOSITIVO = 1 VENDA = 1 CONTRATO = 1 DEVICE   â”‚
â”‚                                                     â”‚
â”‚  deviceId â†’ Identifica o dispositivo                â”‚
â”‚  deviceId â†’ Identifica a venda                      â”‚
â”‚  deviceId â†’ Identifica o contrato                   â”‚
â”‚  deviceId â†’ Identifica as parcelas                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“Š Estrutura de Dados

```javascript
// âœ… CORRETO: Tudo usa deviceId
{
  "devices": {
    "id": "device_1763331005716_xxx",  // â† Este Ã© o deviceId
    "name": "Moto G15 Power",
    "imei": "123456789012345",
    "customerId": "customer_xxx",
    "totalValue": 1500.00,
    "installmentCount": 10,
    "installmentValue": 150.00
  },
  "installments": [
    {
      "id": "inst_1",
      "deviceId": "device_1763331005716_xxx",  // â† Referencia o deviceId
      "installmentNumber": 1,
      "value": 150.00
    }
  ],
  "device_block_levels": {
    "deviceId": "device_1763331005716_xxx",  // â† Referencia o deviceId
    "currentLevel": 0
  }
}
```

### âŒ ERROS COMUNS (NÃƒO FAÃ‡A ISSO!)

```javascript
// âŒ ERRADO: NÃ£o existe contractId
{
  "contractId": "contract_xxx",  // ISTO NÃƒO EXISTE!
  "deviceId": "device_xxx"
}

// âŒ ERRADO: NÃ£o existe saleId
{
  "saleId": "sale_xxx",  // ISTO NÃƒO EXISTE!
  "deviceId": "device_xxx"
}

// âŒ ERRADO: Buscar parcelas por contractId
GET /api/contracts/contract_xxx/installments  // ENDPOINT NÃƒO EXISTE!

// âœ… CORRETO: Buscar parcelas por deviceId
GET /api/devices/device_xxx/installments
```

### ğŸ¯ Exemplos PrÃ¡ticos

#### Exemplo 1: APK Busca Parcelas em Atraso

```kotlin
// âŒ ERRADO
class ApkClient {
  fun getOverdueInstallments(contractId: String) {  // NÃƒO!
    api.get("/api/contracts/$contractId/overdue")  // ENDPOINT NÃƒO EXISTE!
  }
}

// âœ… CORRETO
class ApkClient {
  fun getOverdueInstallments(deviceId: String) {  // SIM!
    api.get("/api/devices/$deviceId/overdue-installments")
  }
}
```

#### Exemplo 2: APK Autentica

```kotlin
// Quando APK autentica
POST /api/apk/auth
{
  "imei": "123456789012345",
  "serialNumber": "SN12345"
}

// Resposta
{
  "token": "apk_token_xxx",
  "deviceId": "device_1763331005716_xxx"  // â† Use ESTE ID para tudo!
}

// âœ… CORRETO: Salvar deviceId e usar em todas as requisiÃ§Ãµes
sharedPreferences.edit()
  .putString("DEVICE_ID", "device_1763331005716_xxx")  // â† Salvar
  .apply()

// Depois usar em todas as APIs
val deviceId = sharedPreferences.getString("DEVICE_ID", null)

// âœ… Buscar status
GET /api/apk/device/status  // Usa token APK (jÃ¡ sabe o deviceId)

// âœ… Buscar parcelas em atraso
GET /api/apk/device/overdue  // Usa token APK (jÃ¡ sabe o deviceId)

// âœ… Buscar comandos MDM
GET /api/apk/device/:serialNumber/commands
```

#### Exemplo 3: Admin Bloqueia Dispositivo

```javascript
// âŒ ERRADO
async function blockContract(contractId) {
  await api.post(`/api/contracts/${contractId}/block`);  // NÃƒO EXISTE!
}

// âœ… CORRETO
async function blockDevice(deviceId) {
  await api.post(`/api/devices/${deviceId}/block`);
}

// Uso:
blockDevice("device_1763331005716_xxx");
```

#### Exemplo 4: Listar Parcelas

```javascript
// âŒ ERRADO - API nÃ£o tem /api/contracts
const installments = await fetch('/api/contracts/contract_xxx/installments');

// âœ… CORRETO - API usa /api/devices
const installments = await fetch('/api/devices/device_xxx/installments');

// Resposta:
[
  {
    "id": "inst_1",
    "deviceId": "device_xxx",  // â† deviceId, NÃƒO contractId
    "installmentNumber": 1,
    "value": 150.00
  }
]
```

### ğŸ” Como Identificar IDs no Sistema

```javascript
// PadrÃ£o de IDs gerados pelo sistema:
device_1763331005716_xxx    // â† deviceId (sempre comeÃ§a com device_)
customer_xxx                // â† customerId
store_xxx                   // â† storeId
inst_xxx                    // â† installmentId
cmd_xxx                     // â† commandId

// âš ï¸ NUNCA EXISTIRÃ:
contract_xxx  âŒ  // NÃ£o existe!
sale_xxx      âŒ  // NÃ£o existe!
```

### ğŸ“± Fluxo Completo APK

```kotlin
// 1. APK inicia
class MainActivity : AppCompatActivity() {
  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    
    // Buscar deviceId salvo
    val deviceId = sharedPreferences.getString("DEVICE_ID", null)
    
    if (deviceId == null) {
      // NÃ£o autenticado, fazer auth
      authenticate()
    } else {
      // JÃ¡ tem deviceId, usar para tudo
      checkDeviceStatus(deviceId)
      fetchOverdueInstallments(deviceId)
      connectWebSocket(deviceId)
    }
  }
  
  // 2. Autenticar e receber deviceId
  private suspend fun authenticate() {
    val response = api.post("/api/apk/auth") {
      body = {
        "imei": deviceImei,
        "serialNumber": deviceSerial
      }
    }
    
    // Salvar deviceId recebido
    val deviceId = response.deviceId  // â† device_1763331005716_xxx
    sharedPreferences.edit()
      .putString("DEVICE_ID", deviceId)  // â† SALVAR!
      .apply()
      
    // Salvar token tambÃ©m
    val token = response.token
    sharedPreferences.edit()
      .putString("APK_TOKEN", token)
      .apply()
  }
  
  // 3. Usar deviceId em todas as operaÃ§Ãµes
  private suspend fun checkDeviceStatus(deviceId: String) {
    // âŒ ERRADO
    // val status = api.get("/api/contracts/$contractId/status")
    
    // âœ… CORRETO
    val status = api.get("/api/apk/device/status")  // Usa token, nÃ£o precisa deviceId na URL
  }
  
  private suspend fun fetchOverdueInstallments(deviceId: String) {
    // âŒ ERRADO
    // val installments = api.get("/api/contracts/$contractId/installments")
    
    // âœ… CORRETO
    val installments = api.get("/api/apk/device/overdue")  // Usa token
    
    // Ou via admin API (se tiver deviceId)
    // val installments = api.get("/api/devices/$deviceId/overdue-installments")
  }
}
```

### ğŸ“ Resumo para IA

**Quando vocÃª for desenvolver o APK, lembre-se:**

1. âœ… **SÃ³ existe `deviceId`** - Ã© o identificador Ãºnico de tudo
2. âœ… **Salve o `deviceId` ao autenticar** - vocÃª vai precisar dele
3. âœ… **Use `/api/devices/:deviceId/*` nas APIs admin** - para admin web portal
4. âœ… **Use `/api/apk/device/*` nas APIs APK** - para o aplicativo Android
5. âŒ **NUNCA use `contractId` ou `saleId`** - eles nÃ£o existem!

**Mapeamento mental:**
```
deviceId = contractId = saleId = deviceId
```

Tudo Ã© deviceId! ğŸ¯

### ğŸ“Š Tabela Comparativa: Endpoints Admin vs APK

| Funcionalidade | âŒ ERRADO (NÃƒO EXISTE) | âœ… Admin API | âœ… APK API |
|----------------|------------------------|--------------|------------|
| **Buscar parcelas em atraso** | `/api/contracts/:contractId/overdue` | `/api/devices/:deviceId/overdue-installments` | `/api/apk/device/overdue` |
| **Buscar todas parcelas** | `/api/sales/:saleId/installments` | `/api/devices/:deviceId/installments` | `/api/apk/device/installments` |
| **Status do dispositivo** | `/api/contracts/:contractId/status` | `/api/devices/:deviceId` | `/api/apk/device/status` |
| **Bloquear dispositivo** | `/api/contracts/:contractId/block` | `/api/devices/:deviceId/block` | - |
| **Desbloquear dispositivo** | `/api/sales/:saleId/unblock` | `/api/devices/:deviceId/unblock` | - |
| **Bloqueio progressivo** | `/api/contracts/:contractId/progressive-block` | `/api/devices/:deviceId/progressive-block` | - |
| **Comandos MDM** | `/api/contracts/:contractId/commands` | - | `/api/apk/device/:serialNumber/commands` |

### ğŸ”„ Exemplo Real Completo

```kotlin
// ================================================
// CÃ“DIGO APK COMPLETO - EXEMPLO REAL
// ================================================

class CreditSmartAPK {
  private lateinit var deviceId: String
  private lateinit var apkToken: String
  private lateinit var apiClient: ApiClient
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 1. AUTENTICAÃ‡ÃƒO
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  suspend fun authenticate() {
    val imei = getDeviceImei()  // "123456789012345"
    val serial = getDeviceSerial()  // "SN12345"
    
    // âœ… Endpoint correto
    val response = apiClient.post("/api/apk/auth") {
      body = AuthRequest(
        imei = imei,
        serialNumber = serial,
        fingerprint = getDeviceFingerprint()
      )
    }
    
    // Salvar deviceId e token
    deviceId = response.deviceId  // "device_1763331005716_xxx"
    apkToken = response.token      // "apk_token_xxx"
    
    // Persistir
    sharedPreferences.edit()
      .putString("DEVICE_ID", deviceId)
      .putString("APK_TOKEN", apkToken)
      .apply()
      
    Log.d("APK", "âœ… Autenticado! deviceId: $deviceId")
  }
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 2. BUSCAR PARCELAS EM ATRASO (PARA OVERLAY)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  suspend fun fetchOverdueInstallments(): OverdueData {
    // âŒ ERRADO - NÃ£o faÃ§a isso!
    // val url = "/api/contracts/$contractId/overdue"
    
    // âœ… CORRETO - Use endpoint APK
    val response = apiClient.get("/api/apk/device/overdue") {
      header("X-APK-Token", apkToken)
    }
    
    Log.d("APK", "Parcelas em atraso: ${response.overdueCount}")
    return response
  }
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 3. VERIFICAR STATUS DO DISPOSITIVO
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  suspend fun checkDeviceStatus(): DeviceStatus {
    // âŒ ERRADO - NÃ£o faÃ§a isso!
    // val url = "/api/contracts/$contractId/status"
    
    // âœ… CORRETO - Use endpoint APK
    val response = apiClient.get("/api/apk/device/status") {
      header("X-APK-Token", apkToken)
    }
    
    if (response.isBlocked) {
      Log.w("APK", "âš ï¸ Dispositivo bloqueado!")
      showBlockScreen()
    }
    
    return response
  }
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 4. BUSCAR COMANDOS MDM (POLLING)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  suspend fun fetchMdmCommands(): List<MdmCommand> {
    val serial = getDeviceSerial()
    
    // âŒ ERRADO - NÃ£o faÃ§a isso!
    // val url = "/api/contracts/$contractId/commands"
    
    // âœ… CORRETO - Use endpoint APK
    val response = apiClient.get("/api/apk/device/$serial/commands") {
      header("X-APK-Token", apkToken)
    }
    
    response.commands.forEach { command ->
      when (command.type) {
        "BLOCK_BASIC" -> handleBlockBasic(command)
        "BLOCK_APPS_PROGRESSIVE" -> handleProgressiveBlock(command)
        "FULL_DEVICE_LOCK" -> handleFullLock(command)
        else -> Log.w("APK", "Comando desconhecido: ${command.type}")
      }
    }
    
    return response.commands
  }
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 5. EXIBIR OVERLAY NÃVEL 6
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  suspend fun showLevel6Overlay() {
    // âœ… Buscar parcelas em atraso usando deviceId correto
    val overdueData = fetchOverdueInstallments()
    
    // Exibir overlay com informaÃ§Ãµes
    val overlayIntent = Intent(this, OverlayActivity::class.java).apply {
      putExtra("DEVICE_ID", deviceId)  // â† deviceId, NÃƒO contractId!
      putExtra("OVERDUE_COUNT", overdueData.overdueCount)
      putExtra("TOTAL_AMOUNT", overdueData.totalOverdueAmount)
      putExtra("INSTALLMENTS", overdueData.installments.toTypedArray())
    }
    
    startActivity(overlayIntent)
  }
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 6. CONECTAR WEBSOCKET
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fun connectWebSocket() {
    // âœ… WebSocket usa token APK
    val wsUrl = "wss://domain.replit.app/ws?token=$apkToken"
    
    val webSocket = OkHttpClient().newWebSocket(
      Request.Builder().url(wsUrl).build(),
      object : WebSocketListener() {
        override fun onMessage(webSocket: WebSocket, text: String) {
          val message = Json.decodeFromString<WsMessage>(text)
          
          if (message.type == "MDM_COMMAND") {
            handleMdmCommand(message.command)
          }
        }
      }
    )
  }
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // RESUMO: VARIÃVEIS IMPORTANTES
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fun printDebugInfo() {
    Log.d("APK", """
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ“± CREDIT SMART APK - DEBUG INFO
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      deviceId: $deviceId
      apkToken: $apkToken
      
      âœ… USE SEMPRE:
      - deviceId (NÃƒO contractId, NÃƒO saleId)
      - Endpoints: /api/apk/device/*
      - Header: X-APK-Token
      
      âŒ NUNCA USE:
      - contractId (nÃ£o existe!)
      - saleId (nÃ£o existe!)
      - Endpoints: /api/contracts/* (nÃ£o existem!)
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """.trimIndent())
  }
}
```

### ğŸ¯ Checklist para IA do APK

Antes de fazer qualquer requisiÃ§Ã£o, verifique:

- [ ] âœ… Estou usando `deviceId` (nÃ£o contractId/saleId)?
- [ ] âœ… Estou usando endpoint `/api/apk/device/*`?
- [ ] âœ… Estou enviando header `X-APK-Token`?
- [ ] âœ… Salvei o `deviceId` ao autenticar?
- [ ] âŒ NÃƒO estou tentando usar `/api/contracts/*`?
- [ ] âŒ NÃƒO estou tentando usar `/api/sales/*`?
- [ ] âŒ NÃƒO estou tentando usar `/api/admin/*`?

---

## ğŸš¨ ERRO COMUM NO APK: 403 Forbidden

### âŒ Erro nos Logs

```
GET https://cdccreditsmart.com/api/admin/mdm/devices/device_xxx/commands
<-- 403 Forbidden
{"error":"Acesso negado"}
```

### ğŸ” DiagnÃ³stico

**Problema:** O APK estÃ¡ tentando acessar endpoint de **ADMIN**, nÃ£o de **APK**.

**Endpoints ERRADOS (NÃƒO USE!):**
```kotlin
// âŒ ERRADO - Endpoint de admin (403 Forbidden)
GET /api/admin/mdm/devices/{deviceId}/commands

// âŒ ERRADO - Endpoint de admin (403 Forbidden)
GET /api/devices/{deviceId}/commands

// âŒ ERRADO - Requer JWT token de admin
GET /api/admin/devices/{deviceId}/status
```

**Endpoints CORRETOS (USE ESTES!):**
```kotlin
// âœ… CORRETO - Endpoint APK com serial number
GET /api/apk/device/{serialNumber}/commands

// âœ… CORRETO - Endpoint APK para status
GET /api/apk/device/status

// âœ… CORRETO - Endpoint APK para parcelas
GET /api/apk/device/overdue
```

### ğŸ”§ SoluÃ§Ã£o

#### Antes (ERRADO):
```kotlin
class MdmCommandReceiver {
  suspend fun fetchPendingCommands(): List<MdmCommand> {
    val deviceId = getDeviceId()  // device_xxx
    
    // âŒ ERRADO: Usando endpoint de admin
    val response = apiClient.get(
      "/api/admin/mdm/devices/$deviceId/commands"
    ) {
      header("X-APK-Token", apkToken)  // Header correto, mas endpoint errado!
    }
    
    // Resultado: 403 Forbidden {"error":"Acesso negado"}
    return response.commands
  }
}
```

#### Depois (CORRETO):
```kotlin
class MdmCommandReceiver {
  suspend fun fetchPendingCommands(): List<MdmCommand> {
    val serialNumber = getDeviceSerial()  // SN12345
    
    // âœ… CORRETO: Usando endpoint APK com serial number
    val response = apiClient.get(
      "/api/apk/device/$serialNumber/commands"
    ) {
      header("X-APK-Token", apkToken)
    }
    
    // Resultado: 200 OK com lista de comandos
    return response.commands
  }
}
```

### ğŸ“Š DiferenÃ§a: Admin vs APK Endpoints

| Funcionalidade | âŒ Admin Endpoint (403 para APK) | âœ… APK Endpoint (Use este!) |
|----------------|----------------------------------|----------------------------|
| **AutenticaÃ§Ã£o** | JWT Token (admin/store_user) | APK Token (X-APK-Token) |
| **Comandos MDM** | `/api/admin/mdm/devices/:deviceId/commands` | `/api/apk/device/:serialNumber/commands` |
| **Status** | `/api/devices/:deviceId` | `/api/apk/device/status` |
| **Parcelas** | `/api/devices/:deviceId/overdue-installments` | `/api/apk/device/overdue` |
| **Heartbeat** | N/A | `/api/apk/device/heartbeat` |
| **FCM Token** | N/A | `/api/apk/device/fcm-token` |

### ğŸ¯ Por que 403 Forbidden?

```javascript
// Backend verifica tipo de autenticaÃ§Ã£o
app.get('/api/admin/mdm/devices/:deviceId/commands', 
  authenticateToken,  // â† Espera JWT Token de admin
  async (req, res) => {
    // APK estÃ¡ enviando X-APK-Token, nÃ£o JWT Token
    // Resultado: 403 Forbidden
  }
);

// APK deve usar este endpoint:
app.get('/api/apk/device/:serialNumber/commands',
  apkTokenMiddleware,  // â† Espera X-APK-Token
  async (req, res) => {
    // APK envia X-APK-Token corretamente
    // Resultado: 200 OK
  }
);
```

### ğŸ”„ Exemplo Completo Corrigido

```kotlin
class CreditSmartAPK {
  private lateinit var apkToken: String
  private lateinit var serialNumber: String
  private val apiClient = ApiClient("https://cdccreditsmart.com")
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 1. AUTENTICAR (CORRETO)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  suspend fun authenticate() {
    val imei = getDeviceImei()
    serialNumber = getDeviceSerial()  // â† Salvar serial number!
    
    val response = apiClient.post("/api/apk/auth") {
      body = AuthRequest(
        imei = imei,
        serialNumber = serialNumber,
        fingerprint = getDeviceFingerprint()
      )
    }
    
    apkToken = response.token
    
    // Salvar token e serial
    sharedPreferences.edit()
      .putString("APK_TOKEN", apkToken)
      .putString("SERIAL_NUMBER", serialNumber)
      .apply()
  }
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 2. BUSCAR COMANDOS MDM (CORRETO)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  suspend fun fetchMdmCommands(): List<MdmCommand> {
    // âœ… CORRETO: Usar serial number, nÃ£o deviceId
    val response = apiClient.get(
      "/api/apk/device/$serialNumber/commands"  // â† Serial, nÃ£o deviceId!
    ) {
      header("X-APK-Token", apkToken)
    }
    
    Log.d("APK", "âœ… Comandos recebidos: ${response.commands.size}")
    return response.commands
  }
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 3. POLLING DE COMANDOS (CORRETO)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fun startCommandPolling() {
    coroutineScope.launch {
      while (isActive) {
        try {
          val commands = fetchMdmCommands()
          
          commands.forEach { command ->
            when (command.type) {
              "BLOCK_BASIC" -> handleBlockBasic(command)
              "BLOCK_APPS_PROGRESSIVE" -> handleProgressiveBlock(command)
              "FULL_DEVICE_LOCK" -> handleFullLock(command)
              "UNBLOCK_BASIC" -> handleUnblock(command)
              else -> Log.w("APK", "Comando desconhecido: ${command.type}")
            }
          }
        } catch (e: Exception) {
          Log.e("APK", "Erro ao buscar comandos", e)
        }
        
        delay(30_000) // 30 segundos
      }
    }
  }
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 4. CONFIRMAR EXECUÃ‡ÃƒO DE COMANDO (CORRETO)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  suspend fun confirmCommandExecution(commandId: String, success: Boolean) {
    apiClient.post(
      "/api/apk/device/$serialNumber/command-response"
    ) {
      header("X-APK-Token", apkToken)
      body = CommandResponse(
        commandId = commandId,
        status = if (success) "executed" else "failed",
        executedAt = System.currentTimeMillis(),
        result = mapOf("success" to success)
      )
    }
  }
}
```

### ğŸ“ Resumo da CorreÃ§Ã£o

1. **âŒ NÃƒO use:** `/api/admin/mdm/devices/:deviceId/commands`
2. **âœ… USE:** `/api/apk/device/:serialNumber/commands`
3. **âŒ NÃƒO use:** `deviceId` para buscar comandos
4. **âœ… USE:** `serialNumber` para buscar comandos
5. **âŒ NÃƒO use:** JWT Token
6. **âœ… USE:** APK Token (header `X-APK-Token`)

### ğŸ“ Para a IA do APK

**Regra simples:**
```
Se vocÃª estÃ¡ no APK, SEMPRE use:
âœ… Endpoints que comeÃ§am com /api/apk/device/*
âœ… Header X-APK-Token (nÃ£o Authorization)
âœ… serialNumber para comandos MDM (nÃ£o deviceId)
```

**NUNCA use no APK:**
```
âŒ /api/admin/*  â†’ Endpoints de administraÃ§Ã£o (403)
âŒ /api/devices/* â†’ Endpoints de gestÃ£o (403)
âŒ Authorization: Bearer â†’ JWT token (errado)
âŒ deviceId para comandos â†’ Use serialNumber
```

---

## ğŸ—ï¸ Arquitetura do Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ADMIN WEB PORTAL                     â”‚
â”‚          (React + TanStack Query + Wouter)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ JWT Auth + REST APIs
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   EXPRESS BACKEND                       â”‚
â”‚        â€¢ AutenticaÃ§Ã£o (Replit Auth + JWT)              â”‚
â”‚        â€¢ ValidaÃ§Ã£o de permissÃµes (admin/store)         â”‚
â”‚        â€¢ LÃ³gica de negÃ³cio                             â”‚
â”‚        â€¢ Audit logs                                    â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚        â”‚         â”‚                            â”‚
   â”‚        â”‚         â”‚                            â”‚
   â–¼        â–¼         â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DB â”‚  â”‚ FCM â”‚  â”‚ WebSocketâ”‚                â”‚ APK Deviceâ”‚
â”‚    â”‚  â”‚     â”‚  â”‚ Server   â”‚                â”‚           â”‚
â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                             â”‚
                      â”‚   wss://domain/ws?token=X   â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  MDM Commands    â”‚
                        â”‚  â€¢ BLOCK_BASIC   â”‚
                        â”‚  â€¢ BLOCK_PROG    â”‚
                        â”‚  â€¢ UNBLOCK       â”‚
                        â”‚  â€¢ WIPE          â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Componentes Principais

1. **Admin Web Portal**: Interface React para gerenciar dispositivos
2. **Express Backend**: API REST + WebSocket server
3. **PostgreSQL Database**: Armazena dispositivos, bloqueios, comandos, audit logs
4. **Firebase FCM**: Push notifications para APK
5. **WebSocket Server**: Comandos MDM em tempo real
6. **APK Client**: App Android nos dispositivos arrendados

---

## ğŸ“¡ Endpoints por Categoria

### 1ï¸âƒ£ Registro e GestÃ£o BÃ¡sica

#### **GET /api/devices**
Listar todos os dispositivos (com filtros opcionais)

**Auth:** JWT Token (admin ou store_user)

**Query Params (opcionais):**
```
?storeId=store_xxx       // Filtrar por loja
?status=active           // Filtrar por status
?search=Moto             // Busca por nome/modelo
```

**Resposta:**
```json
[
  {
    "id": "device_xxx",
    "name": "Moto G15 Power",
    "model": "Moto G15",
    "imei": "123456789012345",
    "serialNumber": "SN12345",
    "isBlocked": false,
    "isPaired": true,
    "storeId": "store_xxx",
    "customerId": "customer_xxx",
    "apkToken": "token_xxx",
    "fcmToken": "fcm_token_xxx",
    "lastSeen": "2025-11-17T10:30:00Z",
    "createdAt": "2025-11-01T00:00:00Z"
  }
]
```

**Exemplo:**
```bash
curl -X GET "http://localhost:5000/api/devices?storeId=store_xxx" \
  -H "Authorization: Bearer <JWT_TOKEN>"
```

---

#### **POST /api/devices**
Registrar novo dispositivo

**Auth:** JWT Token (admin ou store_user)

**Body:**
```json
{
  "name": "Moto G15 Power",
  "model": "Moto G15",
  "imei": "123456789012345",
  "serialNumber": "SN12345",
  "storeId": "store_xxx",
  "customerId": "customer_xxx"
}
```

**ValidaÃ§Ãµes:**
- âœ… IMEI deve ter 15 dÃ­gitos
- âœ… IMEI nÃ£o pode estar cadastrado em outro dispositivo
- âœ… Serial number deve ser Ãºnico
- âœ… Store e Customer devem existir

**Resposta:**
```json
{
  "id": "device_1763331005716_xxx",
  "name": "Moto G15 Power",
  "model": "Moto G15",
  "imei": "123456789012345",
  "serialNumber": "SN12345",
  "isBlocked": false,
  "isPaired": false,
  "createdAt": "2025-11-17T10:30:00Z"
}
```

**Exemplo:**
```bash
curl -X POST "http://localhost:5000/api/devices" \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Moto G15 Power",
    "model": "Moto G15",
    "imei": "123456789012345",
    "serialNumber": "SN12345",
    "storeId": "store_xxx",
    "customerId": "customer_xxx"
  }'
```

---

#### **GET /api/devices/:id**
Obter detalhes de um dispositivo especÃ­fico

**Auth:** JWT Token (admin ou store_user)

**Resposta:**
```json
{
  "id": "device_xxx",
  "name": "Moto G15 Power",
  "model": "Moto G15",
  "imei": "123456789012345",
  "serialNumber": "SN12345",
  "isBlocked": false,
  "isPaired": true,
  "storeId": "store_xxx",
  "customerId": "customer_xxx",
  "apkToken": "token_xxx",
  "fcmToken": "fcm_token_xxx",
  "lastSeen": "2025-11-17T10:30:00Z",
  "blockLevel": {
    "currentLevel": 0,
    "manualOverride": false,
    "lastChecked": "2025-11-17T10:30:00Z"
  }
}
```

---

#### **DELETE /api/devices/:id**
Deletar dispositivo

**Auth:** JWT Token (apenas admin)

**Resposta:**
```json
{
  "message": "Dispositivo deletado com sucesso",
  "deviceId": "device_xxx"
}
```

**Comportamento:**
- âœ… Envia comando WIPE para o APK via WebSocket
- âœ… Remove todos os dados relacionados
- âœ… Cria audit log
- âœ… Aguarda confirmaÃ§Ã£o do APK (timeout 30s)

---

#### **GET /api/devices/imei/:imei**
Buscar dispositivo por IMEI

**Auth:** JWT Token (admin ou store_user)

**Resposta:**
```json
{
  "id": "device_xxx",
  "name": "Moto G15 Power",
  "imei": "123456789012345",
  "isPaired": true,
  "customerId": "customer_xxx"
}
```

---

#### **GET /api/devices/check-paired**
Verificar se um IMEI jÃ¡ estÃ¡ pareado

**Auth:** JWT Token (admin ou store_user)

**Query Params:**
```
?imei=123456789012345
```

**Resposta:**
```json
{
  "isPaired": true,
  "device": {
    "id": "device_xxx",
    "name": "Moto G15 Power",
    "customerId": "customer_xxx"
  }
}
```

---

### 2ï¸âƒ£ Bloqueio BÃ¡sico (On/Off)

#### **POST /api/devices/:id/block**
Bloquear dispositivo (bloqueio bÃ¡sico on/off)

**Auth:** JWT Token (admin ou store_user)

**Body (opcional):**
```json
{
  "reason": "Roubo reportado",
  "sendNotification": true
}
```

**Resposta:**
```json
{
  "message": "Dispositivo bloqueado com sucesso",
  "deviceId": "device_xxx",
  "commandSent": true
}
```

**Comportamento:**
- âœ… Envia comando MDM `BLOCK_BASIC` via WebSocket
- âœ… Envia push notification via FCM (opcional)
- âœ… Atualiza `devices.isBlocked = true`
- âœ… Cria audit log

**Exemplo:**
```bash
curl -X POST "http://localhost:5000/api/devices/device_xxx/block" \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "reason": "Roubo reportado",
    "sendNotification": true
  }'
```

---

#### **POST /api/devices/:id/unblock**
Desbloquear dispositivo (bloqueio bÃ¡sico)

**Auth:** JWT Token (admin ou store_user)

**Body (opcional):**
```json
{
  "reason": "SituaÃ§Ã£o regularizada",
  "sendNotification": true
}
```

**Resposta:**
```json
{
  "message": "Dispositivo desbloqueado com sucesso",
  "deviceId": "device_xxx",
  "commandSent": true
}
```

**Comportamento:**
- âœ… Envia comando MDM `UNBLOCK_BASIC` via WebSocket
- âœ… Envia push notification via FCM (opcional)
- âœ… Atualiza `devices.isBlocked = false`
- âœ… Cria audit log

---

### 3ï¸âƒ£ Bloqueio Progressivo (7 NÃ­veis)

#### **GET /api/devices/block-levels**
Listar todos os dispositivos com seus nÃ­veis de bloqueio

**Auth:** JWT Token (admin ou store_user)

**Resposta:**
```json
[
  {
    "deviceId": "device_xxx",
    "deviceName": "Moto G15 Power",
    "currentLevel": 3,
    "manualOverride": false,
    "daysOverdue": 10,
    "lastChecked": "2025-11-17T10:30:00Z",
    "metadata": {
      "lastModeChange": "2025-11-17T10:00:00Z",
      "changedBy": "admin@admin.com",
      "mode": "auto"
    }
  }
]
```

---

#### **GET /api/devices/:id/block-level**
Obter nÃ­vel de bloqueio de um dispositivo especÃ­fico

**Auth:** JWT Token (admin ou store_user)

**Resposta:**
```json
{
  "deviceId": "device_xxx",
  "deviceName": "Moto G15 Power",
  "currentLevel": 3,
  "manualOverride": false,
  "daysOverdue": 10,
  "rule": {
    "level": 3,
    "days": 9,
    "categories": ["social_media"],
    "exceptions": ["com.whatsapp", "com.android.dialer"],
    "message_title": "AtenÃ§Ã£o: redes sociais bloqueadas",
    "message_body": "Atraso de 9 dias. Todas as redes sociais foram bloqueadas, exceto WhatsApp."
  },
  "lastChecked": "2025-11-17T10:30:00Z"
}
```

---

#### **POST /api/devices/:id/progressive-block**
Aplicar bloqueio progressivo manual

**Auth:** JWT Token (apenas admin)

**Body:**
```json
{
  "targetLevel": 3,
  "manualOverride": true,
  "expiresInMinutes": 1440
}
```

**ParÃ¢metros:**
- `targetLevel` (0-6): NÃ­vel de bloqueio a ser aplicado
- `manualOverride` (boolean): Se true, sistema automÃ¡tico nÃ£o altera
- `expiresInMinutes` (opcional): Tempo atÃ© o comando expirar

**Resposta:**
```json
{
  "success": true,
  "message": "Bloqueio progressivo nÃ­vel 3 aplicado com sucesso",
  "deviceId": "device_xxx",
  "deviceName": "Moto G15 Power",
  "previousLevel": 0,
  "newLevel": 3,
  "commandSent": true,
  "rule": {
    "level": 3,
    "days": 9,
    "categories": ["social_media"],
    "message_title": "AtenÃ§Ã£o: redes sociais bloqueadas"
  }
}
```

**Comportamento:**
- âœ… Envia comando MDM `BLOCK_APPS_PROGRESSIVE` ou `UNBLOCK_APPS_PROGRESSIVE`
- âœ… Atualiza tabela `device_block_levels`
- âœ… Cria `mdm_commands` com regras de bloqueio
- âœ… Cria audit log
- âœ… Se `manualOverride=true`, sistema automÃ¡tico pula esse dispositivo

**Exemplo:**
```bash
curl -X POST "http://localhost:5000/api/devices/device_xxx/progressive-block" \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "targetLevel": 3,
    "manualOverride": true
  }'
```

---

### 4ï¸âƒ£ Sistema Auto/Manual

#### **GET /api/devices/:id/block-mode**
Verificar modo atual (automÃ¡tico ou manual)

**Auth:** JWT Token (admin ou store_user)

**Resposta:**
```json
{
  "deviceId": "device_xxx",
  "deviceName": "Moto G15 Power",
  "mode": "auto",
  "manualOverride": false,
  "currentLevel": 0,
  "daysOverdue": 0,
  "description": "Sistema automÃ¡tico gerencia o bloqueio baseado em atrasos"
}
```

**Modos possÃ­veis:**
- `auto`: Sistema automÃ¡tico gerencia (manualOverride=false)
- `manual`: Admin controla manualmente (manualOverride=true)

---

#### **POST /api/devices/:id/toggle-auto-manual**
Alternar entre modo automÃ¡tico e manual

**Auth:** JWT Token (apenas admin)

**Body (opcional):**
```json
{
  "mode": "manual"
}
```

**OpÃ§Ãµes:**
- `{ "mode": "auto" }` â†’ ForÃ§a modo automÃ¡tico
- `{ "mode": "manual" }` â†’ ForÃ§a modo manual
- `{}` â†’ Toggle: se estÃ¡ em auto vai para manual, vice-versa

**Resposta:**
```json
{
  "success": true,
  "message": "Modo manual ativado - sistema automÃ¡tico nÃ£o alterarÃ¡ o nÃ­vel de bloqueio",
  "deviceId": "device_xxx",
  "deviceName": "Moto G15 Power",
  "previousMode": "auto",
  "newMode": "manual",
  "manualOverride": true,
  "currentLevel": 0,
  "emoji": "ğŸ‘¤"
}
```

**Comportamento:**
- âœ… Atualiza `device_block_levels.manualOverride`
- âœ… Cria audit log
- âœ… Atualiza metadata (quem alterou, quando, modo anterior)
- âœ… Se modo manual, sistema automÃ¡tico pula esse dispositivo

**Exemplo:**
```bash
# Ativar modo manual
curl -X POST "http://localhost:5000/api/devices/device_xxx/toggle-auto-manual" \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"mode": "manual"}'

# Toggle automÃ¡tico
curl -X POST "http://localhost:5000/api/devices/device_xxx/toggle-auto-manual" \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{}'
```

---

### 5ï¸âƒ£ Comandos MDM

#### **GET /api/apk/device/:serialNumber/commands**
APK busca comandos pendentes (polling)

**Auth:** APK Token (via header `X-APK-Token`)

**Resposta:**
```json
{
  "commands": [
    {
      "id": "cmd_xxx",
      "type": "BLOCK_APPS_PROGRESSIVE",
      "payload": {
        "level": 3,
        "categories": ["social_media"],
        "exceptions": ["com.whatsapp"],
        "message": "Dispositivo bloqueado - nÃ­vel 3"
      },
      "issuedBy": "admin@admin.com",
      "issuedAt": "2025-11-17T10:30:00Z",
      "expiresAt": "2025-11-18T10:30:00Z"
    }
  ]
}
```

**Tipos de comando MDM:**
- `BLOCK_BASIC`: Bloqueio bÃ¡sico (tela preta)
- `UNBLOCK_BASIC`: Desbloquear bÃ¡sico
- `BLOCK_APPS_PROGRESSIVE`: Bloqueio progressivo (nÃ­veis 1-5)
- `UNBLOCK_APPS_PROGRESSIVE`: Desbloqueio progressivo (nÃ­vel 0)
- `FULL_DEVICE_LOCK`: Bloqueio total com overlay (nÃ­vel 6)
- `WIPE`: Limpar dados do dispositivo
- `NOTIFICATION`: Enviar notificaÃ§Ã£o

---

#### **POST /api/apk/device/:serialNumber/command-response**
APK confirma execuÃ§Ã£o de comando

**Auth:** APK Token

**Body:**
```json
{
  "commandId": "cmd_xxx",
  "status": "executed",
  "executedAt": "2025-11-17T10:31:00Z",
  "result": {
    "success": true,
    "message": "Comando executado com sucesso"
  }
}
```

**Status possÃ­veis:**
- `executed`: Comando executado com sucesso
- `failed`: Falha na execuÃ§Ã£o
- `expired`: Comando expirou antes da execuÃ§Ã£o

---

### 6ï¸âƒ£ Parcelas e Atrasos

#### **GET /api/devices/:deviceId/overdue-installments**
Buscar parcelas em atraso de um dispositivo

**Auth:** JWT Token (admin ou store_user)

**Resposta:**
```json
{
  "deviceId": "device_xxx",
  "overdueCount": 3,
  "totalOverdueAmount": 450.00,
  "daysOverdue": 10,
  "installments": [
    {
      "id": "inst_1",
      "installmentNumber": 1,
      "amount": 150.00,
      "dueDate": "2025-11-01",
      "status": "overdue",
      "daysOverdue": 16
    },
    {
      "id": "inst_2",
      "installmentNumber": 2,
      "amount": 150.00,
      "dueDate": "2025-11-08",
      "status": "overdue",
      "daysOverdue": 9
    },
    {
      "id": "inst_3",
      "installmentNumber": 3,
      "amount": 150.00,
      "dueDate": "2025-11-15",
      "status": "overdue",
      "daysOverdue": 2
    }
  ]
}
```

---

#### **GET /api/devices/:deviceId/installments**
Buscar todas as parcelas de um dispositivo

**Auth:** JWT Token (admin ou store_user)

**Query Params (opcionais):**
```
?status=pending        // Filtrar por status (pending, paid, overdue)
```

**Resposta:**
```json
[
  {
    "id": "inst_1",
    "installmentNumber": 1,
    "amount": 150.00,
    "dueDate": "2025-11-01",
    "status": "paid",
    "paidAt": "2025-11-01T10:00:00Z"
  },
  {
    "id": "inst_2",
    "installmentNumber": 2,
    "amount": 150.00,
    "dueDate": "2025-11-15",
    "status": "pending"
  }
]
```

---

### 7ï¸âƒ£ Endpoints APK (Device Side)

#### **POST /api/apk/auth**
APK autentica e recebe token

**Body:**
```json
{
  "imei": "123456789012345",
  "serialNumber": "SN12345",
  "fingerprint": "device_fingerprint_xxx"
}
```

**ValidaÃ§Ãµes:**
- âœ… IMEI deve existir no banco
- âœ… IMEI deve estar pareado (isPaired=true)
- âœ… Fingerprint deve corresponder ao registrado
- âœ… Rate limiting: 5 tentativas por minuto

**Resposta:**
```json
{
  "success": true,
  "token": "apk_token_xxx",
  "deviceId": "device_xxx",
  "expiresIn": 2592000
}
```

---

#### **GET /api/apk/device/status**
APK verifica status atual

**Auth:** APK Token

**Resposta:**
```json
{
  "deviceId": "device_xxx",
  "isBlocked": false,
  "blockLevel": {
    "currentLevel": 0,
    "manualOverride": false
  },
  "hasPendingCommands": false,
  "lastSync": "2025-11-17T10:30:00Z"
}
```

---

#### **GET /api/apk/device/overdue**
APK busca parcelas em atraso (para overlay nÃ­vel 6)

**Auth:** APK Token

**Resposta:**
```json
{
  "deviceId": "device_xxx",
  "overdueCount": 3,
  "totalOverdueAmount": 450.00,
  "installments": [
    {
      "installmentNumber": 1,
      "amount": 150.00,
      "dueDate": "2025-11-01",
      "daysOverdue": 16
    }
  ],
  "contactInfo": {
    "phone": "+55 11 98765-4321",
    "whatsapp": "+55 11 98765-4321",
    "storeName": "Loja Centro"
  }
}
```

**Uso:** APK exibe essas informaÃ§Ãµes no overlay de bloqueio nÃ­vel 6

---

#### **POST /api/apk/device/fcm-token**
APK registra token FCM para push notifications

**Auth:** APK Token

**Body:**
```json
{
  "fcmToken": "firebase_cloud_messaging_token_xxx"
}
```

**Resposta:**
```json
{
  "success": true,
  "message": "FCM token registrado com sucesso"
}
```

---

#### **POST /api/apk/device/heartbeat**
APK envia heartbeat (prova de vida)

**Auth:** APK Token

**Body:**
```json
{
  "batteryLevel": 85,
  "isCharging": false,
  "signalStrength": 4,
  "location": {
    "latitude": -23.550520,
    "longitude": -46.633308
  }
}
```

**Resposta:**
```json
{
  "success": true,
  "serverTime": "2025-11-17T10:30:00Z"
}
```

**Comportamento:**
- âœ… Atualiza `devices.lastSeen`
- âœ… Armazena telemetria (bateria, sinal, localizaÃ§Ã£o)

---

#### **POST /api/apk/device/permissions**
APK reporta permissÃµes concedidas/negadas

**Auth:** APK Token

**Body:**
```json
{
  "permissions": {
    "DEVICE_ADMIN": true,
    "SYSTEM_ALERT_WINDOW": true,
    "USAGE_STATS": true,
    "LOCATION": false,
    "CAMERA": true
  }
}
```

**Resposta:**
```json
{
  "success": true,
  "message": "PermissÃµes atualizadas"
}
```

---

## ğŸšï¸ Sistema de Bloqueio Progressivo

### 7 NÃ­veis (0-6)

O sistema possui **7 nÃ­veis de bloqueio progressivo** aplicados automaticamente baseado em dias de atraso:

```javascript
const PROGRESSIVE_BLOCK_RULES = [
  {
    level: 0,
    days: 0,
    categories: [],
    exceptions: [],
    message_title: "Dispositivo Desbloqueado",
    message_body: "Seu dispositivo estÃ¡ funcionando normalmente. Todas as parcelas estÃ£o em dia."
  },
  {
    level: 1,
    days: 3,
    categories: ["photos", "gallery", "video_players", "web_browsers"],
    exceptions: ["com.whatsapp", "com.android.dialer", "com.android.messaging", "bancos_allowed", "emails_allowed"],
    message_title: "AtenÃ§Ã£o: limite de apps reduzido",
    message_body: "Seu aparelho estÃ¡ com atraso de 3 dias. Aplicativos de fotos, galeria, vÃ­deos e navegadores foram temporariamente bloqueados atÃ© a regularizaÃ§Ã£o."
  },
  {
    level: 2,
    days: 6,
    categories: ["youtube", "music_players", "play_store", "games"],
    exceptions: ["com.whatsapp", "com.android.dialer", "com.android.messaging", "bancos_allowed", "emails_allowed"],
    message_title: "AtenÃ§Ã£o: restriÃ§Ã£o ampliada",
    message_body: "Atraso de 6 dias. YouTube, apps de mÃºsica, Play Store e jogos foram bloqueados alÃ©m das restriÃ§Ãµes anteriores."
  },
  {
    level: 3,
    days: 9,
    categories: ["social_media"],
    exceptions: ["com.whatsapp", "com.android.dialer", "com.android.messaging", "bancos_allowed", "emails_allowed"],
    message_title: "AtenÃ§Ã£o: redes sociais bloqueadas",
    message_body: "Atraso de 9 dias. Todas as redes sociais foram bloqueadas, exceto WhatsApp."
  },
  {
    level: 4,
    days: 12,
    categories: ["all_apps_except_whatsapp"],
    exceptions: ["com.whatsapp", "com.android.dialer", "com.android.messaging", "bancos_allowed", "emails_allowed"],
    message_title: "AtenÃ§Ã£o: restriÃ§Ã£o severa",
    message_body: "Atraso de 12 dias. Quase todos os aplicativos estÃ£o bloqueados, WhatsApp continua liberado."
  },
  {
    level: 5,
    days: 15,
    categories: ["all_apps_except_banks_calls_sms_emails"],
    exceptions: ["bancos_allowed", "com.android.dialer", "com.android.messaging", "emails_allowed"],
    message_title: "AtenÃ§Ã£o: restriÃ§Ã£o mÃ¡xima",
    message_body: "Atraso de 15 dias. Apenas apps bancÃ¡rios, de e-mail, telefone e SMS permanecerÃ£o disponÃ­veis. Demais apps foram bloqueados."
  },
  {
    level: 6,
    days: 18,
    categories: ["FULL_DEVICE_LOCK"],
    exceptions: [],
    message_title: "âš ï¸ DISPOSITIVO BLOQUEADO",
    message_body: "Atraso de 18 dias ou mais. Dispositivo bloqueado completamente. Uma tela de bloqueio com suas parcelas em atraso serÃ¡ exibida sobrepondo todo o sistema Android atÃ© a regularizaÃ§Ã£o do pagamento."
  }
];
```

### CÃ¡lculo AutomÃ¡tico de NÃ­veis

```javascript
function determineBlockLevel(daysOverdue: number): number {
  if (daysOverdue < 3) return 0;   // 0-2 dias: sem bloqueio
  if (daysOverdue < 6) return 1;   // 3-5 dias: nÃ­vel 1
  if (daysOverdue < 9) return 2;   // 6-8 dias: nÃ­vel 2
  if (daysOverdue < 12) return 3;  // 9-11 dias: nÃ­vel 3
  if (daysOverdue < 15) return 4;  // 12-14 dias: nÃ­vel 4
  if (daysOverdue < 18) return 5;  // 15-17 dias: nÃ­vel 5
  return 6;                        // 18+ dias: nÃ­vel 6 (BLOQUEIO TOTAL)
}
```

### Sistema AutomÃ¡tico

O sistema roda **a cada 15 minutos** verificando:

1. âœ… Busca vendas com pagamentos em atraso
2. âœ… Calcula dias de atraso de cada dispositivo
3. âœ… Determina nÃ­vel apropriado (0-6)
4. âœ… **Pula dispositivos com `manualOverride=true`**
5. âœ… Envia comandos MDM via WebSocket
6. âœ… Atualiza `device_block_levels`
7. âœ… Cria audit logs

**Desbloqueio AutomÃ¡tico:**
- Quando parcelas atrasadas sÃ£o pagas
- Sistema detecta na prÃ³xima execuÃ§Ã£o (15 min)
- Calcula novo nÃ­vel (geralmente 0)
- Envia comando `UNBLOCK_PROGRESSIVE`
- APK fecha overlay/desbloqueio automaticamente

---

## ğŸ”’ Sistema de Bloqueio BÃ¡sico

Bloqueio binÃ¡rio simples (on/off) para emergÃªncias:

### Quando usar:
- ğŸš¨ Roubo reportado
- ğŸš¨ Perda do dispositivo
- ğŸš¨ Fraude detectada
- ğŸš¨ ViolaÃ§Ã£o de contrato

### CaracterÃ­sticas:
- âœ… **Independente do bloqueio progressivo**
- âœ… Tem **prioridade sobre bloqueio progressivo**
- âœ… Bloqueia totalmente o dispositivo
- âœ… APK exibe tela preta com mensagem
- âœ… NÃ£o libera apps essenciais

### LÃ³gica de Prioridade:

```javascript
// VerificaÃ§Ã£o no APK
if (device.isBlocked) {
  // Bloqueio bÃ¡sico tem prioridade mÃ¡xima
  showBlackScreen();
  return;
}

// Depois verifica bloqueio progressivo
if (device.blockLevel.currentLevel === 6) {
  showOverlayWithInstallments();
} else if (device.blockLevel.currentLevel > 0) {
  applyProgressiveBlocking();
}
```

---

## ğŸ”„ Sistema Auto/Manual

Permite alternar entre **gestÃ£o automÃ¡tica** e **controle manual** por dispositivo.

### ğŸ¤– Modo AutomÃ¡tico (AUTO)

**CaracterÃ­sticas:**
- Sistema calcula nÃ­veis 0-6 automaticamente
- Baseado em dias de atraso
- Desbloqueio automÃ¡tico ao pagar
- Roda a cada 15 minutos
- `manualOverride = false`

**Quando usar:**
- âœ… OperaÃ§Ã£o padrÃ£o do sistema
- âœ… GestÃ£o em escala de muitos dispositivos
- âœ… Quando nÃ£o hÃ¡ acordos especiais

---

### ğŸ‘¤ Modo Manual (MANUAL)

**CaracterÃ­sticas:**
- Admin define nÃ­vel especÃ­fico
- Sistema automÃ¡tico **NÃƒO altera** mais esse dispositivo
- NÃ­vel permanece fixo atÃ© admin mudar
- `manualOverride = true`

**Quando usar:**
- âœ… Clientes com acordos especiais
- âœ… NegociaÃ§Ãµes de prazo
- âœ… Testes de bloqueio
- âœ… Clientes VIP

---

### AlternÃ¢ncia Entre Modos

```bash
# Verificar modo atual
GET /api/devices/:id/block-mode

# Ativar modo manual
POST /api/devices/:id/toggle-auto-manual
{ "mode": "manual" }

# Ativar modo automÃ¡tico
POST /api/devices/:id/toggle-auto-manual
{ "mode": "auto" }

# Toggle (alternar automaticamente)
POST /api/devices/:id/toggle-auto-manual
{}
```

---

## ğŸŒ WebSocket em Tempo Real

O sistema usa **WebSocket** para enviar comandos MDM instantaneamente aos dispositivos.

### ConexÃ£o APK

```kotlin
// APK conecta ao WebSocket
val wsUrl = "wss://domain.replit.app/ws?token=${apkToken}"
val webSocket = OkHttpClient().newWebSocket(
    Request.Builder().url(wsUrl).build(),
    object : WebSocketListener() {
        override fun onMessage(webSocket: WebSocket, text: String) {
            val message = Json.decodeFromString<WSMessage>(text)
            handleMdmCommand(message)
        }
    }
)
```

### Mensagens WebSocket

**Formato:**
```json
{
  "type": "MDM_COMMAND",
  "command": {
    "id": "cmd_xxx",
    "type": "BLOCK_APPS_PROGRESSIVE",
    "payload": {
      "level": 3,
      "categories": ["social_media"],
      "exceptions": ["com.whatsapp"],
      "message": "Bloqueio nÃ­vel 3"
    },
    "issuedBy": "admin@admin.com",
    "issuedAt": "2025-11-17T10:30:00Z"
  }
}
```

### Tipos de Comando via WebSocket

1. **BLOCK_BASIC**: Bloqueio bÃ¡sico total
2. **UNBLOCK_BASIC**: Desbloqueio bÃ¡sico
3. **BLOCK_APPS_PROGRESSIVE**: Bloqueio progressivo (nÃ­veis 1-5)
4. **UNBLOCK_APPS_PROGRESSIVE**: Desbloqueio progressivo (nÃ­vel 0)
5. **FULL_DEVICE_LOCK**: Bloqueio total com overlay (nÃ­vel 6)
6. **WIPE**: Limpar dados do dispositivo
7. **NOTIFICATION**: Enviar notificaÃ§Ã£o

---

## ğŸ” ValidaÃ§Ã£o IMEI e APK

### Fluxo de Registro

1. **Admin registra dispositivo no portal**
   ```bash
   POST /api/devices
   {
     "imei": "123456789012345",
     "serialNumber": "SN12345",
     ...
   }
   ```

2. **APK tenta autenticar**
   ```bash
   POST /api/apk/auth
   {
     "imei": "123456789012345",
     "serialNumber": "SN12345",
     "fingerprint": "device_fingerprint_xxx"
   }
   ```

3. **Backend valida**
   - âœ… IMEI existe?
   - âœ… IMEI estÃ¡ pareado (isPaired=true)?
   - âœ… Fingerprint corresponde?
   - âœ… Rate limiting ok?

4. **Backend retorna token**
   ```json
   {
     "success": true,
     "token": "apk_token_xxx",
     "deviceId": "device_xxx"
   }
   ```

5. **APK usa token para todas as requisiÃ§Ãµes**
   ```
   Header: X-APK-Token: apk_token_xxx
   ```

### SeguranÃ§a

- âœ… **IMEI imutÃ¡vel**: NÃ£o pode ser alterado apÃ³s registro
- âœ… **Fingerprint Ãºnico**: Device fingerprint Ãºnico por dispositivo
- âœ… **Rate limiting**: 5 tentativas de auth por minuto
- âœ… **Token expirÃ¡vel**: Tokens APK expiram em 30 dias
- âœ… **Bloqueio automÃ¡tico**: 3 falhas consecutivas â†’ dispositivo bloqueado
- âœ… **Audit log**: Todas as tentativas sÃ£o registradas

---

## ğŸ“² Push Notifications

O sistema usa **Firebase Cloud Messaging (FCM)** para enviar notificaÃ§Ãµes aos dispositivos.

### Registro de Token FCM

```bash
POST /api/apk/device/fcm-token
{
  "fcmToken": "firebase_token_xxx"
}
```

### Envio de NotificaÃ§Ã£o

```javascript
// Backend envia notificaÃ§Ã£o
const message = {
  notification: {
    title: "AtenÃ§Ã£o: Pagamento Atrasado",
    body: "Sua parcela venceu hÃ¡ 5 dias. Regularize para evitar bloqueios."
  },
  data: {
    type: "payment_reminder",
    deviceId: "device_xxx",
    installmentId: "inst_xxx"
  },
  token: device.fcmToken
};

await admin.messaging().send(message);
```

### Tipos de NotificaÃ§Ã£o

1. **payment_reminder**: Lembrete de pagamento
2. **block_warning**: Aviso de bloqueio iminente
3. **block_applied**: Bloqueio aplicado
4. **unblock_applied**: Desbloqueio aplicado
5. **system_message**: Mensagem do sistema

---

## ğŸ’¼ Casos de Uso PrÃ¡ticos

### ğŸ“ Caso 1: Cliente Negociou Prazo Extra

**SituaÃ§Ã£o:**
- Cliente estÃ¡ com 10 dias de atraso (seria nÃ­vel 3)
- Negociou mais 15 dias de prazo
- Quer que dispositivo fique desbloqueado

**SoluÃ§Ã£o:**
```bash
# 1. Alternar para modo manual
POST /api/devices/device_xxx/toggle-auto-manual
{ "mode": "manual" }

# 2. ForÃ§ar nÃ­vel 0 (desbloqueado)
POST /api/devices/device_xxx/progressive-block
{ "targetLevel": 0, "manualOverride": true }

# Resultado: Dispositivo fica desbloqueado
# Sistema automÃ¡tico NÃƒO altera

# Depois dos 15 dias:
POST /api/devices/device_xxx/toggle-auto-manual
{ "mode": "auto" }
# Sistema retoma controle
```

---

### ğŸ“ Caso 2: Roubo Reportado

**SituaÃ§Ã£o:**
- Cliente reportou roubo
- Precisa bloquear imediatamente

**SoluÃ§Ã£o:**
```bash
# Bloquear imediatamente (bloqueio bÃ¡sico)
POST /api/devices/device_xxx/block
{
  "reason": "Roubo reportado pelo cliente",
  "sendNotification": true
}

# Resultado:
# âœ… Comando enviado via WebSocket instantaneamente
# âœ… Push notification enviada via FCM
# âœ… APK exibe tela preta
# âœ… Audit log criado
```

---

### ğŸ“ Caso 3: Cliente VIP sem Bloqueio

**SituaÃ§Ã£o:**
- Cliente VIP nunca deve ser bloqueado
- Independente de atrasos

**SoluÃ§Ã£o:**
```bash
# Configurar permanentemente em modo manual nÃ­vel 0
POST /api/devices/device_xxx/toggle-auto-manual
{ "mode": "manual" }

POST /api/devices/device_xxx/progressive-block
{ "targetLevel": 0, "manualOverride": true }

# Resultado: Cliente VIP nunca bloqueado automaticamente
```

---

### ğŸ“ Caso 4: Teste de Bloqueio

**SituaÃ§Ã£o:**
- Quer testar como fica bloqueio nÃ­vel 4
- Mas nÃ£o quer que sistema altere automaticamente

**SoluÃ§Ã£o:**
```bash
# 1. Modo manual
POST /api/devices/device_xxx/toggle-auto-manual
{ "mode": "manual" }

# 2. Aplicar nÃ­vel 4
POST /api/devices/device_xxx/progressive-block
{ "targetLevel": 4 }

# 3. Testar no APK...

# 4. Voltar para auto
POST /api/devices/device_xxx/toggle-auto-manual
{ "mode": "auto" }
```

---

### ğŸ“ Caso 5: Cliente Pagou Parcelas Atrasadas

**SituaÃ§Ã£o:**
- Cliente tinha 3 parcelas atrasadas (nÃ­vel 3)
- Pagou todas as parcelas
- Quer desbloquear automaticamente

**SoluÃ§Ã£o:**
```bash
# Admin registra pagamentos no sistema
POST /api/payments
{ "installmentId": "inst_1", "amount": 150.00 }
POST /api/payments
{ "installmentId": "inst_2", "amount": 150.00 }
POST /api/payments
{ "installmentId": "inst_3", "amount": 150.00 }

# Sistema automÃ¡tico (a cada 15 min):
# 1. Detecta que parcelas foram pagas
# 2. Calcula novo nÃ­vel: 0 dias de atraso = nÃ­vel 0
# 3. Envia comando UNBLOCK_PROGRESSIVE via WebSocket
# 4. APK recebe e fecha overlay/desbloqueia
# 5. Cliente volta a usar dispositivo normalmente

# NÃ£o precisa fazer nada manualmente!
```

---

## ğŸ¤– IntegraÃ§Ã£o para IA

### Exemplo: IA gerenciando dispositivos

```javascript
// Exemplo de script para IA gerenciar dispositivos

const axios = require('axios');

class DeviceManagementAI {
  constructor(jwtToken, baseUrl = 'http://localhost:5000') {
    this.token = jwtToken;
    this.baseUrl = baseUrl;
  }

  // Listar todos os dispositivos
  async listDevices(filters = {}) {
    const params = new URLSearchParams(filters);
    const response = await axios.get(`${this.baseUrl}/api/devices?${params}`, {
      headers: { Authorization: `Bearer ${this.token}` }
    });
    return response.data;
  }

  // Verificar dispositivos com bloqueio progressivo
  async getDevicesWithBlocking() {
    const response = await axios.get(`${this.baseUrl}/api/devices/block-levels`, {
      headers: { Authorization: `Bearer ${this.token}` }
    });
    return response.data;
  }

  // Aplicar bloqueio progressivo
  async applyProgressiveBlock(deviceId, level, manual = false) {
    const response = await axios.post(
      `${this.baseUrl}/api/devices/${deviceId}/progressive-block`,
      { targetLevel: level, manualOverride: manual },
      { headers: { Authorization: `Bearer ${this.token}` } }
    );
    return response.data;
  }

  // Alternar modo auto/manual
  async toggleMode(deviceId, mode) {
    const response = await axios.post(
      `${this.baseUrl}/api/devices/${deviceId}/toggle-auto-manual`,
      { mode },
      { headers: { Authorization: `Bearer ${this.token}` } }
    );
    return response.data;
  }

  // Bloquear dispositivo (emergÃªncia)
  async blockDevice(deviceId, reason) {
    const response = await axios.post(
      `${this.baseUrl}/api/devices/${deviceId}/block`,
      { reason, sendNotification: true },
      { headers: { Authorization: `Bearer ${this.token}` } }
    );
    return response.data;
  }

  // Desbloquear dispositivo
  async unblockDevice(deviceId, reason) {
    const response = await axios.post(
      `${this.baseUrl}/api/devices/${deviceId}/unblock`,
      { reason, sendNotification: true },
      { headers: { Authorization: `Bearer ${this.token}` } }
    );
    return response.data;
  }

  // Analisar e agir baseado em atrasos
  async autoManageDevices() {
    const devices = await this.getDevicesWithBlocking();
    
    for (const device of devices) {
      console.log(`Analisando dispositivo ${device.deviceName}...`);
      
      // Dispositivo em modo manual? Pula
      if (device.manualOverride) {
        console.log(`  â†’ Modo manual, pulando`);
        continue;
      }
      
      // Verifica atrasos
      if (device.daysOverdue >= 18 && device.currentLevel < 6) {
        console.log(`  â†’ 18+ dias de atraso, aplicando nÃ­vel 6`);
        await this.applyProgressiveBlock(device.deviceId, 6);
      } else if (device.daysOverdue >= 15 && device.currentLevel < 5) {
        console.log(`  â†’ 15+ dias de atraso, aplicando nÃ­vel 5`);
        await this.applyProgressiveBlock(device.deviceId, 5);
      } else if (device.daysOverdue === 0 && device.currentLevel > 0) {
        console.log(`  â†’ Sem atrasos, desbloqueando (nÃ­vel 0)`);
        await this.applyProgressiveBlock(device.deviceId, 0);
      }
    }
  }

  // Negociar prazo com cliente
  async negotiateGracePeriod(deviceId, extraDays) {
    console.log(`Negociando ${extraDays} dias extras para dispositivo ${deviceId}`);
    
    // 1. Alternar para modo manual
    await this.toggleMode(deviceId, 'manual');
    
    // 2. ForÃ§ar nÃ­vel 0 (desbloqueado)
    await this.applyProgressiveBlock(deviceId, 0, true);
    
    // 3. Agendar volta para auto depois do prazo
    setTimeout(async () => {
      console.log(`Prazo expirou, voltando para modo automÃ¡tico`);
      await this.toggleMode(deviceId, 'auto');
    }, extraDays * 24 * 60 * 60 * 1000);
    
    return { success: true, message: `${extraDays} dias de prazo concedidos` };
  }
}

// Uso:
const ai = new DeviceManagementAI('jwt_token_xxx');

// Listar dispositivos
const devices = await ai.listDevices({ storeId: 'store_xxx' });

// Auto-gerenciar dispositivos
await ai.autoManageDevices();

// Negociar prazo
await ai.negotiateGracePeriod('device_xxx', 15);
```

---

## ğŸ“Š Resumo de Endpoints

### Dispositivos

| MÃ©todo | Endpoint | DescriÃ§Ã£o | Auth |
|--------|----------|-----------|------|
| GET | `/api/devices` | Listar dispositivos | JWT |
| POST | `/api/devices` | Criar dispositivo | JWT |
| GET | `/api/devices/:id` | Obter dispositivo | JWT |
| DELETE | `/api/devices/:id` | Deletar dispositivo | JWT (admin) |
| GET | `/api/devices/imei/:imei` | Buscar por IMEI | JWT |
| GET | `/api/devices/check-paired` | Verificar pareamento | JWT |

### Bloqueio BÃ¡sico

| MÃ©todo | Endpoint | DescriÃ§Ã£o | Auth |
|--------|----------|-----------|------|
| POST | `/api/devices/:id/block` | Bloquear (bÃ¡sico) | JWT |
| POST | `/api/devices/:id/unblock` | Desbloquear (bÃ¡sico) | JWT |

### Bloqueio Progressivo

| MÃ©todo | Endpoint | DescriÃ§Ã£o | Auth |
|--------|----------|-----------|------|
| GET | `/api/devices/block-levels` | Listar nÃ­veis | JWT |
| GET | `/api/devices/:id/block-level` | Obter nÃ­vel | JWT |
| POST | `/api/devices/:id/progressive-block` | Aplicar bloqueio progressivo | JWT (admin) |

### Auto/Manual

| MÃ©todo | Endpoint | DescriÃ§Ã£o | Auth |
|--------|----------|-----------|------|
| GET | `/api/devices/:id/block-mode` | Verificar modo | JWT |
| POST | `/api/devices/:id/toggle-auto-manual` | Alternar modo | JWT (admin) |

### Parcelas

| MÃ©todo | Endpoint | DescriÃ§Ã£o | Auth |
|--------|----------|-----------|------|
| GET | `/api/devices/:id/overdue-installments` | Parcelas em atraso | JWT |
| GET | `/api/devices/:id/installments` | Todas as parcelas | JWT |

### APK

| MÃ©todo | Endpoint | DescriÃ§Ã£o | Auth |
|--------|----------|-----------|------|
| POST | `/api/apk/auth` | Autenticar APK | - |
| GET | `/api/apk/device/status` | Status do dispositivo | APK Token |
| GET | `/api/apk/device/overdue` | Parcelas em atraso (overlay) | APK Token |
| POST | `/api/apk/device/fcm-token` | Registrar FCM token | APK Token |
| POST | `/api/apk/device/heartbeat` | Heartbeat | APK Token |
| POST | `/api/apk/device/permissions` | Reportar permissÃµes | APK Token |
| GET | `/api/apk/device/:serial/commands` | Buscar comandos MDM | APK Token |
| POST | `/api/apk/device/:serial/command-response` | Confirmar execuÃ§Ã£o | APK Token |

---

## ğŸ”‘ AutenticaÃ§Ã£o

### Admin/Store User (Portal Web)

```bash
# 1. Login
POST /api/auth/login
{
  "email": "admin@admin.com",
  "password": "admin123"
}

# Response:
{
  "token": "jwt_token_xxx",
  "user": { ... }
}

# 2. Usar token em todas as requisiÃ§Ãµes
Header: Authorization: Bearer jwt_token_xxx
```

### APK (Dispositivo)

```bash
# 1. Autenticar
POST /api/apk/auth
{
  "imei": "123456789012345",
  "serialNumber": "SN12345",
  "fingerprint": "fingerprint_xxx"
}

# Response:
{
  "token": "apk_token_xxx",
  "deviceId": "device_xxx"
}

# 2. Usar token em todas as requisiÃ§Ãµes
Header: X-APK-Token: apk_token_xxx
```

---

## ğŸ¨ REFERÃŠNCIA RÃPIDA VISUAL

### ğŸ“ Endpoints APK - Cole Aqui no Seu CÃ³digo

```kotlin
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“± ENDPOINTS APK - CREDIT SMART - REFERÃŠNCIA RÃPIDA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

object ApkEndpoints {
  const val BASE_URL = "https://cdccreditsmart.com"
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ” AUTENTICAÃ‡ÃƒO
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const val AUTH = "/api/apk/auth"
  // POST - Body: { imei, serialNumber, fingerprint }
  // Response: { token, deviceId }
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ“Š STATUS E INFORMAÃ‡Ã•ES
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const val STATUS = "/api/apk/device/status"
  // GET - Header: X-APK-Token
  // Response: { deviceId, isBlocked, blockLevel, ... }
  
  const val OVERDUE = "/api/apk/device/overdue"
  // GET - Header: X-APK-Token
  // Response: { overdueCount, totalOverdueAmount, installments }
  
  const val INSTALLMENTS = "/api/apk/device/installments"
  // GET - Header: X-APK-Token
  // Response: [ { installmentNumber, amount, dueDate, ... } ]
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ® COMANDOS MDM
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fun commands(serialNumber: String) = "/api/apk/device/$serialNumber/commands"
  // GET - Header: X-APK-Token
  // Response: { commands: [ { id, type, payload, ... } ] }
  
  fun commandResponse(serialNumber: String) = "/api/apk/device/$serialNumber/command-response"
  // POST - Header: X-APK-Token
  // Body: { commandId, status, executedAt, result }
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ“² PUSH NOTIFICATIONS E TELEMETRIA
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const val FCM_TOKEN = "/api/apk/device/fcm-token"
  // POST - Header: X-APK-Token
  // Body: { fcmToken }
  
  const val HEARTBEAT = "/api/apk/device/heartbeat"
  // POST - Header: X-APK-Token
  // Body: { batteryLevel, isCharging, signalStrength, location }
  
  const val PERMISSIONS = "/api/apk/device/permissions"
  // POST - Header: X-APK-Token
  // Body: { permissions: { DEVICE_ADMIN: true, ... } }
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸŒ WEBSOCKET
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fun webSocket(token: String) = "wss://cdccreditsmart.com/ws?token=$token"
  // WebSocket connection with APK token
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âŒ ENDPOINTS QUE NÃƒO EXISTEM - NÃƒO USE!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âŒ /api/contracts/*
// âŒ /api/sales/*
// âŒ /api/admin/mdm/devices/* (403 Forbidden)
// âŒ /api/devices/* (Requer JWT admin)
```

### ğŸ”‘ Headers APK

```kotlin
// âœ… SEMPRE use este header nas requisiÃ§Ãµes APK:
headers {
  append("X-APK-Token", apkToken)
  append("Content-Type", "application/json")
}

// âŒ NÃƒO use este (Ã© para admin):
headers {
  append("Authorization", "Bearer $jwtToken")  // ERRADO!
}
```

### ğŸ¯ Fluxo de AutenticaÃ§Ã£o Simples

```
1. POST /api/apk/auth
   â†“
2. Salvar { token, deviceId, serialNumber }
   â†“
3. Usar token em TODAS as requisiÃ§Ãµes (header X-APK-Token)
   â†“
4. Buscar comandos: GET /api/apk/device/{serialNumber}/commands
```

### ğŸ“Š Tipos de Comando MDM

```kotlin
enum class MdmCommandType {
  BLOCK_BASIC,              // Bloqueio bÃ¡sico total
  UNBLOCK_BASIC,            // Desbloqueio bÃ¡sico
  BLOCK_APPS_PROGRESSIVE,   // Bloqueio progressivo (nÃ­veis 1-5)
  UNBLOCK_APPS_PROGRESSIVE, // Desbloqueio progressivo (nÃ­vel 0)
  FULL_DEVICE_LOCK,         // Bloqueio total com overlay (nÃ­vel 6)
  WIPE,                     // Limpar dados do dispositivo
  NOTIFICATION              // Enviar notificaÃ§Ã£o
}
```

### ğŸš¦ Status Codes

| CÃ³digo | Significado | AÃ§Ã£o |
|--------|-------------|------|
| **200** | âœ… OK | Comando recebido com sucesso |
| **401** | ğŸ”’ Unauthorized | Token invÃ¡lido ou expirado - Re-autenticar |
| **403** | ğŸš« Forbidden | Endpoint errado - Usar `/api/apk/*` |
| **404** | ğŸ” Not Found | Endpoint nÃ£o existe - Verificar URL |
| **429** | â³ Rate Limited | Muitas requisiÃ§Ãµes - Aguardar |
| **500** | ğŸ’¥ Server Error | Erro no servidor - Tentar novamente |

### ğŸ”„ Exemplo MÃ­nimo Completo

```kotlin
// 1. Autenticar
val auth = apiClient.post("/api/apk/auth") {
  body = { "imei" to imei, "serialNumber" to serial }
}
apkToken = auth.token
serialNumber = serial

// 2. Buscar comandos
val commands = apiClient.get("/api/apk/device/$serialNumber/commands") {
  header("X-APK-Token", apkToken)
}

// 3. Executar comandos
commands.forEach { cmd ->
  when (cmd.type) {
    "BLOCK_BASIC" -> blockDevice()
    "UNBLOCK_BASIC" -> unblockDevice()
    else -> Log.w("APK", "Unknown: ${cmd.type}")
  }
  
  // 4. Confirmar execuÃ§Ã£o
  apiClient.post("/api/apk/device/$serialNumber/command-response") {
    header("X-APK-Token", apkToken)
    body = { "commandId" to cmd.id, "status" to "executed" }
  }
}
```

---

## ğŸ“š ReferÃªncias Adicionais

- **SISTEMA_DESBLOQUEIO_AUTOMATICO.md**: Detalhes do desbloqueio automÃ¡tico
- **MODOS_DE_BLOQUEIO.md**: ExplicaÃ§Ã£o dos 3 modos de bloqueio
- **SISTEMA_AUTO_MANUAL.md**: Sistema de alternÃ¢ncia auto/manual
- **RELATORIO_TESTES_BLOQUEIO.md**: RelatÃ³rio de testes realizados

---

**Ãšltima atualizaÃ§Ã£o:** 17/11/2025  
**VersÃ£o:** 1.0.0  
**Sistema:** CDC CreditSmart - GestÃ£o de Dispositivos MDM

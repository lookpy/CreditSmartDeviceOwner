# Notifica√ß√µes WebSocket Progressivas - Biometria

## üìã Vis√£o Geral

O sistema agora envia **3 notifica√ß√µes WebSocket progressivas** durante a verifica√ß√£o biom√©trica, permitindo que o PDV atualize a interface em tempo real conforme cada etapa √© completada.

## üîÑ Fluxo Completo

```
APK ‚Üí Envia Biometria ‚Üí Backend ‚Üí 3 Notifica√ß√µes WebSocket ‚Üí PDV
                            ‚Üì
                    1. Liveness Check ‚úì
                    2. Fraud Analysis ‚úì
                    3. Final Approval ‚úì
```

## üì° Notifica√ß√µes WebSocket Enviadas pelo Backend

### 1Ô∏è‚É£ Notifica√ß√£o: Liveness Check Completado

**Quando √© enviada:** Imediatamente ap√≥s validar que `livenessScore >= 0.8`

**Payload WebSocket:**
```json
{
  "step": "biometric_liveness_check",
  "status": "completed",
  "data": {
    "livenessScore": 0.9927,
    "result": "PASSED",
    "message": "Valida√ß√£o facial com liveness completada"
  }
}
```

**O que o PDV faz:**
- ‚úÖ Marca indicador de "Liveness" como completado
- Atualiza `biometricProgress.livenessCompleted = true`

---

### 2Ô∏è‚É£ Notifica√ß√£o: Fraud Check Completado

**Quando √© enviada:** Ap√≥s completar a an√°lise antifraude (compara√ß√£o de embeddings faciais)

**Payload WebSocket:**
```json
{
  "step": "biometric_fraud_check",
  "status": "completed",
  "data": {
    "biometrySessionId": "bio_ses_1760319755352_nzn3x1ck5s",
    "livenessScore": 0.9927,
    "result": "PASSED",
    "message": "An√°lise de fraude completada - Sem duplicatas detectadas",
    "fraudFlags": null
  }
}
```

**O que o PDV faz:**
- ‚úÖ Marca indicador de "An√°lise Antifraude" como completado
- Atualiza `biometricProgress.fraudCheckCompleted = true`

---

### 3Ô∏è‚É£ Notifica√ß√£o: Biometria Aprovada

**Quando √© enviada:** Ap√≥s salvar o perfil biom√©trico e aprovar a transa√ß√£o

**Payload WebSocket:**
```json
{
  "step": "biometric_approved",
  "status": "completed",
  "data": {
    "biometrySessionId": "bio_ses_1760319755352_nzn3x1ck5s",
    "livenessScore": 0.9927,
    "result": "APPROVED",
    "message": "Biometria verificada com sucesso",
    "deviceId": "abc123..."
  }
}
```

**O que o PDV faz:**
- ‚úÖ Marca indicador de "Aprova√ß√£o" como completado
- Atualiza `biometricProgress.approved = true`
- **Aguarda 2 segundos** e ent√£o **finaliza a venda automaticamente**

---

## üîë Chave de Roteamento WebSocket

**Contract Key:** `IMEI_{imei_do_dispositivo}`

Exemplo: Se o IMEI √© `352099876543210`, a chave √© `IMEI_352099876543210`

Todas as 3 notifica√ß√µes s√£o enviadas para a **mesma chave** para garantir que o PDV correto receba as atualiza√ß√µes.

---

## üì± O que o APK precisa fazer?

### ‚úÖ **NADA MUDA NO APK!**

O APK continua fazendo **exatamente o que j√° faz**:

1. Capturar a selfie do cliente
2. Processar a imagem (extrair embedding, calcular liveness, etc.)
3. Enviar **UMA √öNICA REQUISI√á√ÉO** para o backend

```kotlin
// O APK envia APENAS ISTO (como sempre fez):
suspend fun verifyBiometry(
    token: String,
    sessionId: String,
    storeId: String,
    customerCpf: String,
    faceBitmap: Bitmap
): BiometryResponse {
    
    val request = BiometryVerifyRequest(
        biometrySessionId = sessionId,
        documentHash = generateDocumentHash(customerCpf),
        storeId = storeId,
        faceImage = bitmapToBase64(faceBitmap),
        faceEmbedding = extractFaceEmbedding(faceBitmap),
        livenessScore = calculateLivenessScore(faceBitmap),
        qualityScore = calculateQualityScore(faceBitmap)
    )
    
    // ENVIA APENAS 1 REQUISI√á√ÉO
    return apiClient.post("/v1/biometry/face/verify") {
        header("Authorization", "Bearer $token")
        body = request
    }
}
```

**O backend √© respons√°vel por:**
- Processar a biometria em etapas
- Enviar as 3 notifica√ß√µes WebSocket progressivamente
- Retornar a resposta final para o APK

---

## üéØ Endpoints de Biometria

### Endpoint Principal (Recomendado)
```
POST https://cdccreditsmart.com/v1/biometry/face/verify
```

### Endpoint Legacy (Compatibilidade)
```
POST https://cdccreditsmart.com/api/biometry/verify
```

**Ambos os endpoints enviam as 3 notifica√ß√µes progressivas!**

---

## üìã Request Completo do APK

**Endpoint:**
```
POST https://cdccreditsmart.com/v1/biometry/face/verify
```

**Headers:**
```http
Authorization: Bearer {immutableToken}
Content-Type: application/json
User-Agent: CDC-CreditSmart/1.0.0
```

**Body:**
```json
{
  "biometrySessionId": "bio_ses_1760319755352_nzn3x1ck5s",
  "documentHash": "a8476735b37a541a38402a2e7037c79e2d217fe9780e5e34347156ef61eff42b",
  "storeId": "f3d6763d-9661-44fc-9ffd-d1dc9af5674d",
  "faceImage": "base64_encoded_image...",
  "faceEmbedding": [0.199, -0.197, 1.679, ...],
  "livenessScore": 0.9927,
  "qualityScore": 0.6808
}
```

**Campos obrigat√≥rios:**
- ‚úÖ `biometrySessionId` - ID √∫nico da sess√£o (gere com timestamp + random)
- ‚úÖ `documentHash` - SHA-256 do CPF do cliente (somente n√∫meros)
- ‚úÖ `storeId` - UUID da loja
- ‚úÖ `faceImage` - Imagem da selfie em Base64 (JPEG, 85% qualidade)
- ‚úÖ `faceEmbedding` - Array de 512 floats (embedding facial)
- ‚úÖ `livenessScore` - Score de prova de vida (0.0 a 1.0, m√≠nimo 0.8)
- ‚úÖ `qualityScore` - Score de qualidade da imagem (0.0 a 1.0, m√≠nimo 0.6)

---

## ‚úÖ Resposta de Sucesso

```json
{
  "success": true,
  "verified": true,
  "result": "APPROVED",
  "status": "APPROVED",
  "confidence": 0.9927,
  "message": "Biometria verificada com sucesso",
  "nextAction": "CONTINUE",
  "biometrySessionId": "bio_ses_1760319755352_nzn3x1ck5s",
  "deviceId": "abc123...",
  "customerId": "customer456...",
  "livenessScore": 0.9927,
  "fraudFlags": null,
  "requestId": "req_789xyz..."
}
```

---

## ‚ùå Resposta de Erro - Liveness Baixo

```json
{
  "success": false,
  "error": "BIO_422",
  "code": "BIO_422",
  "details": "Liveness muito baixo",
  "livenessScore": 0.65
}
```

---

## ‚ùå Resposta de Erro - Fraude Detectada

```json
{
  "success": false,
  "verified": false,
  "result": "DENIED",
  "error": "FRAUD_DETECTED",
  "details": "FRAUDE DETECTADA: Mesmo rosto j√° registrado com CPF(s) diferente(s)",
  "fraudType": "same_face_different_cpf",
  "message": "Esta pessoa j√° est√° cadastrada no sistema com outro CPF. Tentativa de fraude bloqueada.",
  "duplicateCustomerIds": ["customer123", "customer456"],
  "totalDuplicates": 2,
  "fraudFlags": {
    "duplicateAcrossStores": true
  },
  "action": "transaction_blocked",
  "canRetry": false
}
```

---

## üîê Autentica√ß√£o

O APK deve usar o **immutableToken** recebido no QR Code para autenticar:

```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

## üé® Interface do PDV (Auto-atualizada)

Durante a verifica√ß√£o biom√©trica, o PDV mostra 3 indicadores visuais:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úÖ Valida√ß√£o Facial (Liveness)     ‚îÇ  ‚Üê Atualizado pela notifica√ß√£o 1
‚îÇ  ‚úÖ An√°lise Antifraude              ‚îÇ  ‚Üê Atualizado pela notifica√ß√£o 2
‚îÇ  ‚úÖ Aprova√ß√£o Final                 ‚îÇ  ‚Üê Atualizado pela notifica√ß√£o 3
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

Cada indicador muda de:
- ‚è≥ Pendente (cinza)
- ‚úÖ Completado (verde)

Ap√≥s todos completarem, o PDV **aguarda 2 segundos** e **finaliza a venda automaticamente**.

---

## üöÄ Resumo para sua IA

**Para integrar o APK com o sistema de biometria:**

1. **Capture a selfie** do cliente
2. **Processe a imagem:**
   - Extraia o face embedding (512 dimens√µes)
   - Calcule o liveness score (m√≠nimo 0.8)
   - Calcule o quality score (m√≠nimo 0.6)
   - Converta a imagem para Base64
3. **Gere o documentHash** (SHA-256 do CPF)
4. **Envie UMA requisi√ß√£o** para `/v1/biometry/face/verify`
5. **Aguarde a resposta** (o backend cuida das notifica√ß√µes WebSocket)

**O APK N√ÉO precisa:**
- ‚ùå Conectar ao WebSocket
- ‚ùå Enviar m√∫ltiplas requisi√ß√µes
- ‚ùå Monitorar progresso em tempo real

**Tudo isso √© gerenciado automaticamente pelo backend!**

---

## üìä Diagrama de Sequ√™ncia

```
APK                Backend              WebSocket           PDV
 ‚îÇ                   ‚îÇ                     ‚îÇ                  ‚îÇ
 ‚îÇ‚îÄ‚îÄPOST /biometry‚îÄ‚îÄ>‚îÇ                     ‚îÇ                  ‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ                  ‚îÇ
 ‚îÇ                   ‚îÇ‚îÄ‚îÄValida Liveness‚îÄ‚îÄ‚îÄ>‚îÇ                  ‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ                  ‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ‚îÄ‚îÄNotification 1‚îÄ‚îÄ>‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ (liveness_check) ‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ                  ‚îÇ
 ‚îÇ                   ‚îÇ‚îÄ‚îÄAnalisa Fraude‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                  ‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ                  ‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ‚îÄ‚îÄNotification 2‚îÄ‚îÄ>‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ (fraud_check)    ‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ                  ‚îÇ
 ‚îÇ                   ‚îÇ‚îÄ‚îÄSalva Embedding‚îÄ‚îÄ‚îÄ>‚îÇ                  ‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ                  ‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ‚îÄ‚îÄNotification 3‚îÄ‚îÄ>‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ (approved)       ‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ                  ‚îÇ
 ‚îÇ<‚îÄ‚îÄ200 APPROVED‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                     ‚îÇ                  ‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ                  ‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ                  ‚îÇ‚îÄ‚îÄAuto-finaliza‚îÄ>‚îÇ
 ‚îÇ                   ‚îÇ                     ‚îÇ                  ‚îÇ  (ap√≥s 2s)      ‚îÇ
```

---

## üõ†Ô∏è C√≥digo de Exemplo - Gera√ß√£o do documentHash

```kotlin
fun generateDocumentHash(cpf: String): String {
    // Remove caracteres especiais (deixa apenas n√∫meros)
    val cleanCpf = cpf.replace(Regex("[^0-9]"), "")
    
    // Gera SHA-256
    val messageDigest = MessageDigest.getInstance("SHA-256")
    val hashBytes = messageDigest.digest(cleanCpf.toByteArray())
    
    // Converte para hexadecimal
    return hashBytes.joinToString("") { "%02x".format(it) }
}

// Exemplo:
// CPF: "123.456.789-00"
// Clean: "12345678900"
// Hash: "a8476735b37a541a38402a2e7037c79e2d217fe9780e5e34347156ef61eff42b"
```

---

## üõ†Ô∏è C√≥digo de Exemplo - Gera√ß√£o do biometrySessionId

```kotlin
fun generateBiometrySessionId(): String {
    val timestamp = System.currentTimeMillis()
    val randomPart = UUID.randomUUID().toString()
        .replace("-", "")
        .substring(0, 12)
    
    return "bio_ses_${timestamp}_${randomPart}"
}

// Exemplo: "bio_ses_1760319755352_nzn3x1ck5s"
```

---

## ‚úÖ Checklist de Implementa√ß√£o

**Sua IA deve implementar no APK:**

- [ ] Captura de selfie do cliente
- [ ] Extra√ß√£o de face embedding (512 dimens√µes) usando TensorFlow Lite
- [ ] C√°lculo de liveness score (m√≠nimo 0.8)
- [ ] C√°lculo de quality score (m√≠nimo 0.6)
- [ ] Convers√£o da imagem para Base64
- [ ] Gera√ß√£o de documentHash (SHA-256 do CPF)
- [ ] Gera√ß√£o de biometrySessionId √∫nico
- [ ] Envio da requisi√ß√£o POST para `/v1/biometry/face/verify`
- [ ] Tratamento da resposta (sucesso ou erro)

**Sua IA N√ÉO precisa implementar:**

- ‚ùå Conex√£o WebSocket
- ‚ùå Notifica√ß√µes progressivas
- ‚ùå Monitoramento de status em tempo real

---

## üìû Suporte

Para d√∫vidas sobre a integra√ß√£o, consulte:
- `GUIA_INTEGRACAO_APK.md` - Guia completo de integra√ß√£o
- `INTEGRACAO_APK_IA.md` - Guia espec√≠fico para IA
- `JWT_401_SOLUTION.md` - Solu√ß√£o de problemas de autentica√ß√£o

---

**√öltima atualiza√ß√£o:** 19 de Outubro de 2025
**Vers√£o da API:** 1.0.0
**Dom√≠nio de Produ√ß√£o:** https://cdccreditsmart.com/

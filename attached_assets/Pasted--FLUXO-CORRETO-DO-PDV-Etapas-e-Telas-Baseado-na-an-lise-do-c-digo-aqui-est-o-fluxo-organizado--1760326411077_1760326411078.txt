 FLUXO CORRETO DO PDV - Etapas e Telas
Baseado na an√°lise do c√≥digo, aqui est√° o fluxo organizado:

ETAPA 1: BUSCAR CLIENTE + VENDA
Tela: search-sale

1.1 Sele√ß√£o/Cadastro de Cliente
 Buscar cliente existente OU
 Cadastrar novo cliente (nome, CPF, telefone, etc.)
1.2 An√°lise de Cr√©dito
 Sistema analisa CPF + valor do aparelho
 Exibe resultado: Aprovado ‚úÖ ou Negado ‚ùå
 Mostra limite aprovado
1.3 Configura√ß√£o da Venda
 Selecionar dispositivo do cat√°logo
 Digitar IMEI do dispositivo f√≠sico (valida√ß√£o autom√°tica)
 Definir valor de entrada
 Sistema calcula:
N√∫mero de parcelas
Valor das parcelas quinzenais
Juros aplicados
1.4 Preparar Venda
 Sistema cria ImeiValidation (janela de 24h)
 Gera Contract Code (ex: CTR_1760326002928_560533)
 N√ÉO cria o Device ainda (apenas valida√ß√£o)
 Avan√ßa para pr√≥xima etapa
Backend: POST /api/sales ‚Üí Cria validation, retorna contractCode e saleId

ETAPA 2: APLICATIVO (APK)
Tela: app

2.1 QR Code / Instru√ß√µes
 PDV exibe QR Code com contractCode
 Cliente escaneia no dispositivo Android
 Timeout: 5 minutos
2.2 Device Attestation (APK)
APK ‚Üí L√™ IMEI do hardware
APK ‚Üí GET /api/device/claim-sale?imei=xxx
APK ‚Üí POST /api/device/claim-sale (com fingerprint)
APK ‚Üí Recebe JWT imut√°vel
2.3 Eventos WebSocket
device:attestation-start ‚Üí "Verificando integridade..."
device:imei-verification ‚Üí "Validando IMEI..."
device:bind-success ‚Üí ‚úÖ "Dispositivo vinculado!"
device:bind-error ‚Üí ‚ùå Modal de erro
2.4 Transi√ß√£o Autom√°tica
 Ao receber device:bind-success
 PDV avan√ßa para biometrics automaticamente
Backend: APK faz claim-sale, recebe JWT (com saleId ou deviceId tempor√°rio)

ETAPA 3: BIOMETRIA
Tela: biometrics

3.1 Verifica√ß√£o Facial (PDV)
 PDV inicia captura biom√©trica do cliente
 Cliente posiciona rosto na c√¢mera
 Sistema verifica:
Liveness (prova de vida)
Quality score (qualidade da imagem)
Face embedding (512 dimens√µes)
3.2 Anti-Fraude
 Compara com rostos cadastrados (mesmo CPF)
 Detecta duplicatas (fraude potencial)
 Resultados:
‚úÖ Aprovado ‚Üí Prossegue
‚ö†Ô∏è Revis√£o Manual ‚Üí Aguarda aprova√ß√£o
‚ùå Fraude Detectada ‚Üí Bloqueia venda
3.3 Finaliza√ß√£o da Venda (CR√çTICO)
POST /api/sales/finalize
‚Üí Cria Device com ID √∫nico
‚Üí Atualiza ImeiValidation.deviceId = device.id
‚Üí Gera contrato PDF
‚Üí Cria comiss√µes
‚Üí Envia notifica√ß√µes
Importante: √â AQUI que o Device √© criado com deviceId real!

3.4 Eventos WebSocket
biometric:validation-start ‚Üí "Iniciando verifica√ß√£o..."
biometric:liveness-check ‚Üí "Verificando prova de vida..."
biometric:approved ‚Üí ‚úÖ Avan√ßa para conclus√£o
biometric:fraud-detected ‚Üí ‚ùå Interrompe fluxo
Backend: POST /api/sales/finalize ‚Üí Cria device, atualiza validation com deviceId

ETAPA 4: CONCLU√çDO
Tela: completed

4.1 Assinatura Digital
 Cliente l√™ termos do contrato
 Cliente assina digitalmente
 Sistema finaliza transa√ß√£o
4.2 Entrega
 Dispositivo liberado para cliente
 Contrato salvo no sistema
 Vendedor pode iniciar nova venda
4.3 Eventos WebSocket
contract:reading-start ‚Üí "Cliente lendo termos..."
contract:signature-start ‚Üí "Assinando contrato..."
contract:completed ‚Üí üéâ "Venda conclu√≠da!"
üîÑ FLUXO BACKEND CORRETO
1Ô∏è‚É£ POST /api/sales
   ‚Üì
   Cria ImeiValidation (deviceId = NULL)
   ‚Üì
   Retorna contractCode, saleId, validationId
2Ô∏è‚É£ APK: GET /api/device/claim-sale?imei=xxx
   ‚Üì
   Busca validation pendente
3Ô∏è‚É£ APK: POST /api/device/claim-sale
   ‚Üì
   Gera JWT (deviceId = saleId tempor√°rio se validation.deviceId = NULL)
   ‚Üì
   Retorna immutableToken
4Ô∏è‚É£ POST /api/sales/finalize (ap√≥s biometria PDV)
   ‚Üì
   Cria Device (ID real gerado)
   ‚Üì
   Atualiza validation.deviceId = device.id
   ‚Üì
   APK agora pode usar JWT para biometria
5Ô∏è‚É£ APK: POST /v1/biometry/face/verify
   ‚Üì
   JWT autenticado
   ‚Üì
   Device encontrado via deviceId ou IMEI
   ‚Üì
   Biometria validada ‚úÖ
‚ö†Ô∏è TIMING CR√çTICO
PROBLEMA ATUAL: APK tenta biometria ANTES de PDV finalizar venda
# Documenta√ß√£o T√©cnica - Comandos MDM de Bloqueio
## Sistema CDC CreditSmart - Integra√ß√£o APK

---

## üìã Sum√°rio
1. [Vis√£o Geral](#vis√£o-geral)
2. [Bloqueio Progressivo (BLOCK_APPS_PROGRESSIVE)](#bloqueio-progressivo)
3. [Bloqueio Total do Dispositivo (LOCK_SCREEN)](#bloqueio-total-do-dispositivo)
4. [Estrutura de Comunica√ß√£o](#estrutura-de-comunica√ß√£o)
5. [Exemplos de Implementa√ß√£o](#exemplos-de-implementa√ß√£o)

---

## üéØ Vis√£o Geral

O sistema MDM (Mobile Device Management) do backend CDC CreditSmart envia dois tipos principais de comandos de bloqueio:

### Comandos Dispon√≠veis

| Comando | Tipo | Finalidade | Requer Device Owner |
|---------|------|------------|---------------------|
| `BLOCK_APPS_PROGRESSIVE` | Bloqueio Progressivo | Bloqueia categorias de apps baseado em dias de atraso | ‚úÖ Sim |
| `UNBLOCK_APPS_PROGRESSIVE` | Desbloqueio Progressivo | Remove restri√ß√µes de apps | ‚úÖ Sim |
| `LOCK_SCREEN` | Bloqueio Total | Bloqueia dispositivo inteiro com banner de pagamento | ‚úÖ Sim |

---

## üîí Bloqueio Progressivo

### BLOCK_APPS_PROGRESSIVE

Bloqueia categorias espec√≠ficas de aplicativos baseado no n√≠vel de atraso do cliente.

### Estrutura do Comando

```json
{
  "id": "uuid-do-comando",
  "deviceId": "device_xxx",
  "commandType": "BLOCK_APPS_PROGRESSIVE",
  "parameters": {
    "targetLevel": 1,
    "daysOverdue": 7,
    "categories": ["photos", "gallery", "video_players", "web_browsers"],
    "exceptions": [
      "com.whatsapp",
      "com.android.dialer",
      "com.android.messaging"
    ],
    "reason": "Atraso de 7 dias - Bloqueio n√≠vel 1"
  },
  "status": "pending",
  "priority": "high",
  "expiresAt": "2025-11-13T00:00:00Z"
}
```

### N√≠veis de Bloqueio Progressivo

#### N√≠vel 1 - 7 dias de atraso
```json
{
  "targetLevel": 1,
  "daysOverdue": 7,
  "categories": ["photos", "gallery", "video_players", "web_browsers"],
  "exceptions": ["com.whatsapp", "com.android.dialer", "com.android.messaging", "bancos_allowed", "emails_allowed"],
  "message_title": "Aten√ß√£o: limite de apps reduzido",
  "message_body": "Seu aparelho est√° com atraso de 7 dias. Aplicativos de fotos, galeria, v√≠deos e navegadores foram temporariamente bloqueados at√© a regulariza√ß√£o."
}
```

#### N√≠vel 2 - 15 dias de atraso
```json
{
  "targetLevel": 2,
  "daysOverdue": 15,
  "categories": ["youtube", "music_players", "play_store", "games"],
  "exceptions": ["com.whatsapp", "com.android.dialer", "com.android.messaging", "bancos_allowed", "emails_allowed"],
  "message_title": "Aten√ß√£o: restri√ß√£o ampliada",
  "message_body": "Atraso de 15 dias. YouTube, apps de m√∫sica, Play Store e jogos foram bloqueados al√©m das restri√ß√µes anteriores."
}
```

#### N√≠vel 3 - 30 dias de atraso
```json
{
  "targetLevel": 3,
  "daysOverdue": 30,
  "categories": ["social_media"],
  "exceptions": ["com.whatsapp", "com.android.dialer", "com.android.messaging", "bancos_allowed", "emails_allowed"],
  "message_title": "Aten√ß√£o: redes sociais bloqueadas",
  "message_body": "Atraso de 30 dias. Todas as redes sociais foram bloqueadas, exceto WhatsApp."
}
```

#### N√≠vel 4 - 45 dias de atraso
```json
{
  "targetLevel": 4,
  "daysOverdue": 45,
  "categories": ["all_apps_except_whatsapp"],
  "exceptions": ["com.whatsapp", "com.android.dialer", "com.android.messaging", "bancos_allowed", "emails_allowed"],
  "message_title": "Aten√ß√£o: restri√ß√£o severa",
  "message_body": "Atraso de 45 dias. Quase todos os aplicativos est√£o bloqueados, WhatsApp continua liberado."
}
```

#### N√≠vel 5 - 60 dias de atraso
```json
{
  "targetLevel": 5,
  "daysOverdue": 60,
  "categories": ["all_apps_except_banks_calls_sms_emails"],
  "exceptions": ["bancos_allowed", "com.android.dialer", "com.android.messaging", "emails_allowed"],
  "message_title": "Aten√ß√£o: restri√ß√£o m√°xima",
  "message_body": "Atraso de 60 dias. Apenas apps banc√°rios, de e-mail, telefone e SMS permanecer√£o dispon√≠veis. Demais apps foram bloqueados."
}
```

### ‚ö†Ô∏è Exce√ß√µes SEMPRE Permitidas

**CR√çTICO**: Os seguintes apps NUNCA devem ser bloqueados em nenhum n√≠vel:

```kotlin
val NEVER_BLOCK_APPS = listOf(
    // Comunica√ß√£o essencial
    "com.whatsapp",
    "com.android.dialer",           // Telefone
    "com.android.messaging",        // SMS
    
    // Bancos (categoria especial)
    // Todos os apps com package name contendo "banco" ou "bank"
    // Ex: com.santander.app, com.bradesco.next, etc.
    
    // Emails (categoria especial)
    // Todos os apps de email
    // Ex: com.google.android.gm, etc.
    
    // Sistema Android
    "com.android.settings",         // Configura√ß√µes
    "com.android.systemui",         // Interface do sistema
    "com.android.launcher",         // Launcher
)
```

### Mapeamento de Categorias

O APK deve mapear as categorias para package names espec√≠ficos:

```kotlin
object AppCategories {
    val PHOTOS = listOf(
        "com.google.android.apps.photos",
        "com.android.gallery3d",
        "com.sec.android.gallery3d"
    )
    
    val GALLERY = listOf(
        "com.android.gallery3d",
        "com.sec.android.gallery3d",
        "com.miui.gallery"
    )
    
    val VIDEO_PLAYERS = listOf(
        "com.google.android.youtube",
        "com.google.android.videos",
        "org.videolan.vlc"
    )
    
    val WEB_BROWSERS = listOf(
        "com.android.chrome",
        "org.mozilla.firefox",
        "com.opera.browser",
        "com.microsoft.emmx"
    )
    
    val YOUTUBE = listOf(
        "com.google.android.youtube"
    )
    
    val MUSIC_PLAYERS = listOf(
        "com.spotify.music",
        "com.google.android.music",
        "com.soundcloud.android"
    )
    
    val PLAY_STORE = listOf(
        "com.android.vending"
    )
    
    val GAMES = listOf(
        // Detectar por categoria no PackageManager
        // category == CATEGORY_GAME
    )
    
    val SOCIAL_MEDIA = listOf(
        "com.facebook.katana",
        "com.instagram.android",
        "com.twitter.android",
        "com.snapchat.android",
        "com.tiktok.android"
        // Exceto WhatsApp que √© exce√ß√£o
    )
}
```

---

## üö® Bloqueio Total do Dispositivo

### LOCK_SCREEN

Bloqueia o dispositivo inteiro exibindo um banner em tela cheia com informa√ß√µes de pagamento e op√ß√µes de regulariza√ß√£o.

### Estrutura do Comando

```json
{
  "id": "uuid-do-comando",
  "deviceId": "device_xxx",
  "commandType": "LOCK_SCREEN",
  "parameters": {
    "lockType": "payment_overdue",
    "severity": "critical",
    "allowUnlock": false,
    "message": {
      "title": "Dispositivo Bloqueado",
      "subtitle": "Pagamento em atraso",
      "body": "Este aparelho foi bloqueado devido a atraso no pagamento. Regularize sua situa√ß√£o para desbloquear o dispositivo.",
      "footer": "CDC CreditSmart - Solu√ß√µes Inteligentes em Cr√©dito"
    },
    "contractInfo": {
      "contractId": "device_1762725359153_ogqi20gqqp",
      "contractNumber": "CDC-2025-001234",
      "customerName": "Jo√£o da Silva",
      "customerCpf": "123.456.789-00",
      "deviceName": "Samsung Galaxy A54",
      "totalValue": 2400.00,
      "amountPaid": 800.00,
      "amountDue": 1600.00,
      "installmentsPaid": 4,
      "installmentsTotal": 12,
      "nextDueDate": "2025-11-15",
      "daysOverdue": 60
    },
    "paymentInfo": {
      "totalDue": 1600.00,
      "overdueAmount": 800.00,
      "interestAmount": 120.00,
      "fineAmount": 80.00,
      "nextInstallment": 200.00,
      "installmentsDue": [
        {
          "number": 5,
          "dueDate": "2025-10-01",
          "value": 200.00,
          "daysOverdue": 41
        },
        {
          "number": 6,
          "dueDate": "2025-10-15",
          "value": 200.00,
          "daysOverdue": 27
        },
        {
          "number": 7,
          "dueDate": "2025-11-01",
          "value": 200.00,
          "daysOverdue": 10
        },
        {
          "number": 8,
          "dueDate": "2025-11-15",
          "value": 200.00,
          "daysOverdue": 0
        }
      ]
    },
    "contactInfo": {
      "companyName": "CDC CreditSmart",
      "storeName": "Loja Centro - S√£o Paulo",
      "phone": "(11) 98765-4321",
      "whatsapp": "5511987654321",
      "email": "atendimento@cdccreditsmart.com",
      "address": "Av. Paulista, 1000 - S√£o Paulo/SP",
      "businessHours": "Seg-Sex: 9h-18h | S√°b: 9h-13h"
    },
    "paymentOptions": [
      {
        "type": "pix",
        "label": "Pagar com PIX",
        "pixKey": "atendimento@cdccreditsmart.com",
        "qrCode": "00020126580014br.gov.bcb.pix...",
        "enabled": true,
        "icon": "pix"
      },
      {
        "type": "boleto",
        "label": "Gerar Boleto",
        "boletoUrl": "https://backend.url/api/payments/boleto/xxx",
        "enabled": true,
        "icon": "barcode"
      },
      {
        "type": "whatsapp",
        "label": "Falar no WhatsApp",
        "whatsappNumber": "5511987654321",
        "whatsappMessage": "Ol√°! Preciso regularizar o pagamento do contrato CDC-2025-001234",
        "enabled": true,
        "icon": "whatsapp"
      },
      {
        "type": "call",
        "label": "Ligar para Loja",
        "phoneNumber": "1198765432",
        "enabled": true,
        "icon": "phone"
      }
    ],
    "allowedActions": [
      "call_emergency",      // Ligar para emerg√™ncias (190, 192, 193)
      "receive_calls",       // Receber liga√ß√µes
      "use_banking_apps"     // Usar apps banc√°rios para pagamento
    ],
    "theme": {
      "primaryColor": "#E45713",      // Orange CDC
      "backgroundColor": "#1A1A1A",   // Dark background
      "textColor": "#FFFFFF",
      "accentColor": "#FFA500"
    }
  },
  "status": "pending",
  "priority": "urgent",
  "expiresAt": null
}
```

### Layout do Banner de Bloqueio

O APK deve exibir uma Activity em tela cheia (sem possibilidade de fechar) com o seguinte layout:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üîí CDC CREDITMART - Dispositivo Bloqueado ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                           ‚îÇ
‚îÇ  ‚ö†Ô∏è PAGAMENTO EM ATRASO                  ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  Contrato: CDC-2025-001234                ‚îÇ
‚îÇ  Cliente: Jo√£o da Silva                   ‚îÇ
‚îÇ  CPF: 123.456.789-00                      ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ   ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  Aparelho: Samsung Galaxy A54             ‚îÇ
‚îÇ  Valor Total: R$ 2.400,00                 ‚îÇ
‚îÇ  Pago: R$ 800,00 (4/12 parcelas)          ‚îÇ
‚îÇ  Saldo Devedor: R$ 1.600,00               ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ   ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  üí∞ VALORES EM ATRASO                     ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  Parcelas vencidas: 4                     ‚îÇ
‚îÇ  Valor atrasado: R$ 800,00                ‚îÇ
‚îÇ  Juros: R$ 120,00                         ‚îÇ
‚îÇ  Multa: R$ 80,00                          ‚îÇ
‚îÇ  Total a pagar: R$ 1.000,00               ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  Dias de atraso: 60 dias                  ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ   ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  üì± REGULARIZE SEU PAGAMENTO:             ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  üí≥ Pagar com PIX                   ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  üìÑ Gerar Boleto                    ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  üí¨ Falar no WhatsApp               ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  üìû Ligar para Loja                 ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ   ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  üìû CONTATO                               ‚îÇ
‚îÇ  Loja Centro - S√£o Paulo                  ‚îÇ
‚îÇ  (11) 98765-4321                          ‚îÇ
‚îÇ  atendimento@cdccreditsmart.com           ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  Hor√°rio: Seg-Sex 9h-18h | S√°b 9h-13h    ‚îÇ
‚îÇ                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Implementa√ß√£o Kotlin - LockScreenActivity

```kotlin
@AndroidEntryPoint
class LockScreenActivity : ComponentActivity() {
    
    private lateinit var lockScreenParams: LockScreenParameters
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        // Parse par√¢metros do comando MDM
        lockScreenParams = parseLockScreenCommand(intent)
        
        // Configurar Activity como tela de bloqueio
        setupLockScreenMode()
        
        // Renderizar UI
        setContent {
            LockScreenTheme(lockScreenParams.theme) {
                LockScreenContent(
                    params = lockScreenParams,
                    onPaymentAction = ::handlePaymentAction
                )
            }
        }
    }
    
    private fun setupLockScreenMode() {
        // Impedir que usu√°rio feche a Activity
        window.addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON)
        window.addFlags(WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD)
        window.addFlags(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED)
        window.addFlags(WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON)
        
        // Modo Kiosk - impedir sa√≠da
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
            startLockTask()
        }
        
        // Desabilitar bot√£o voltar
        onBackPressedDispatcher.addCallback(this) {
            // N√£o faz nada - bloqueio ativo
            Toast.makeText(
                this@LockScreenActivity,
                "Regularize seu pagamento para desbloquear",
                Toast.LENGTH_SHORT
            ).show()
        }
    }
    
    private fun handlePaymentAction(action: PaymentAction) {
        when (action.type) {
            "pix" -> {
                // Mostrar QR Code PIX em dialog
                showPixQrCodeDialog(action.qrCode, action.pixKey)
            }
            "boleto" -> {
                // Abrir URL do boleto (permitido mesmo bloqueado)
                val intent = Intent(Intent.ACTION_VIEW).apply {
                    data = Uri.parse(action.boletoUrl)
                }
                startActivity(intent)
            }
            "whatsapp" -> {
                // Abrir WhatsApp (permitido mesmo bloqueado)
                val intent = Intent(Intent.ACTION_VIEW).apply {
                    data = Uri.parse("https://wa.me/${action.whatsappNumber}?text=${action.whatsappMessage}")
                }
                startActivity(intent)
            }
            "call" -> {
                // Fazer liga√ß√£o (permitido mesmo bloqueado)
                val intent = Intent(Intent.ACTION_DIAL).apply {
                    data = Uri.parse("tel:${action.phoneNumber}")
                }
                startActivity(intent)
            }
        }
    }
    
    private fun parseLockScreenCommand(intent: Intent): LockScreenParameters {
        val parametersJson = intent.getStringExtra("parameters") ?: "{}"
        return Gson().fromJson(parametersJson, LockScreenParameters::class.java)
    }
}

data class LockScreenParameters(
    val lockType: String,
    val severity: String,
    val allowUnlock: Boolean,
    val message: MessageInfo,
    val contractInfo: ContractInfo,
    val paymentInfo: PaymentInfo,
    val contactInfo: ContactInfo,
    val paymentOptions: List<PaymentOption>,
    val allowedActions: List<String>,
    val theme: ThemeInfo
)

data class MessageInfo(
    val title: String,
    val subtitle: String,
    val body: String,
    val footer: String
)

data class ContractInfo(
    val contractId: String,
    val contractNumber: String,
    val customerName: String,
    val customerCpf: String,
    val deviceName: String,
    val totalValue: Double,
    val amountPaid: Double,
    val amountDue: Double,
    val installmentsPaid: Int,
    val installmentsTotal: Int,
    val nextDueDate: String,
    val daysOverdue: Int
)

data class PaymentInfo(
    val totalDue: Double,
    val overdueAmount: Double,
    val interestAmount: Double,
    val fineAmount: Double,
    val nextInstallment: Double,
    val installmentsDue: List<InstallmentDue>
)

data class InstallmentDue(
    val number: Int,
    val dueDate: String,
    val value: Double,
    val daysOverdue: Int
)

data class ContactInfo(
    val companyName: String,
    val storeName: String,
    val phone: String,
    val whatsapp: String,
    val email: String,
    val address: String,
    val businessHours: String
)

data class PaymentOption(
    val type: String,
    val label: String,
    val pixKey: String? = null,
    val qrCode: String? = null,
    val boletoUrl: String? = null,
    val whatsappNumber: String? = null,
    val whatsappMessage: String? = null,
    val phoneNumber: String? = null,
    val enabled: Boolean,
    val icon: String
)

data class ThemeInfo(
    val primaryColor: String,
    val backgroundColor: String,
    val textColor: String,
    val accentColor: String
)
```

### Comportamento do Bloqueio Total

#### A√ß√µes Permitidas Durante o Bloqueio

1. **Chamadas de Emerg√™ncia**: 190, 192, 193
2. **Receber Liga√ß√µes**: Telefone toca normalmente
3. **Apps Banc√°rios**: Permitir acesso para facilitar pagamento
4. **WhatsApp**: Apenas para contato com a loja
5. **Abrir URLs de Pagamento**: PIX, boleto

#### A√ß√µes Bloqueadas

1. ‚ùå Sair da tela de bloqueio
2. ‚ùå Usar qualquer outro app
3. ‚ùå Desinstalar o APK MDM
4. ‚ùå Remover Device Owner
5. ‚ùå Reiniciar em Safe Mode

#### Desbloqueio

O dispositivo s√≥ √© desbloqueado quando:
1. Backend envia comando `UNLOCK_DEVICE`
2. Sistema detecta que pagamento foi confirmado
3. Administrador remove bloqueio manualmente

---

## üì° Estrutura de Comunica√ß√£o

### Polling de Comandos

O APK deve fazer polling a cada 30 segundos (ou intervalo configur√°vel):

```kotlin
// Endpoint de polling
GET /api/apk/device/{deviceId}/commands
Authorization: Bearer {apk_jwt_token}

// Resposta
{
  "commandsCount": 2,
  "commands": [
    {
      "id": "cmd-001",
      "commandType": "BLOCK_APPS_PROGRESSIVE",
      "parameters": { ... },
      "priority": "high",
      "createdAt": "2025-11-11T01:36:00Z",
      "expiresAt": "2025-11-13T01:36:00Z"
    },
    {
      "id": "cmd-002",
      "commandType": "LOCK_SCREEN",
      "parameters": { ... },
      "priority": "urgent",
      "createdAt": "2025-11-11T02:00:00Z",
      "expiresAt": null
    }
  ]
}
```

### Envio de ACK (Acknowledgment)

Ap√≥s receber e processar cada comando:

```kotlin
// Sucesso
POST /api/apk/device/{deviceId}/commands/{commandId}/ack
Authorization: Bearer {apk_jwt_token}

{
  "status": "completed",
  "result": {
    "success": true,
    "executedAt": "2025-11-11T01:36:43Z",
    "blockedApps": [
      "com.facebook.katana",
      "com.instagram.android"
    ],
    "deviceInfo": {
      "androidVersion": "13",
      "deviceOwnerActive": true
    }
  }
}

// Falha
POST /api/apk/device/{deviceId}/commands/{commandId}/ack
Authorization: Bearer {apk_jwt_token}

{
  "status": "failed",
  "result": {
    "success": false,
    "errorCode": "NO_DEVICE_OWNER",
    "errorMessage": "App n√£o √© Device Owner - n√£o pode bloquear apps",
    "executedAt": "2025-11-11T01:36:43Z"
  }
}
```

---

## üîê Seguran√ßa e Device Owner

### Verifica√ß√£o de Permiss√µes

Antes de executar qualquer comando de bloqueio:

```kotlin
fun isDeviceOwner(): Boolean {
    val dpm = getSystemService(Context.DEVICE_POLICY_SERVICE) as DevicePolicyManager
    val adminComponent = ComponentName(this, DeviceAdminReceiver::class.java)
    return dpm.isDeviceOwnerApp(packageName) && dpm.isAdminActive(adminComponent)
}

fun canExecuteCommand(commandType: String): Boolean {
    return when (commandType) {
        "BLOCK_APPS_PROGRESSIVE",
        "UNBLOCK_APPS_PROGRESSIVE",
        "LOCK_SCREEN" -> isDeviceOwner()
        
        "CHECK_STATUS",
        "REPORT_LOCATION" -> true  // N√£o precisa Device Owner
        
        else -> false
    }
}
```

### Tratamento de Erros

```kotlin
fun executeCommand(command: MdmCommand) {
    try {
        if (!canExecuteCommand(command.commandType)) {
            sendAck(
                commandId = command.id,
                status = "failed",
                errorCode = "NO_DEVICE_OWNER",
                errorMessage = "App n√£o √© Device Owner - n√£o pode executar ${command.commandType}"
            )
            return
        }
        
        when (command.commandType) {
            "BLOCK_APPS_PROGRESSIVE" -> blockAppsProgressive(command.parameters)
            "UNBLOCK_APPS_PROGRESSIVE" -> unblockAppsProgressive(command.parameters)
            "LOCK_SCREEN" -> lockDevice(command.parameters)
            else -> {
                sendAck(
                    commandId = command.id,
                    status = "failed",
                    errorCode = "UNKNOWN_COMMAND",
                    errorMessage = "Comando n√£o reconhecido: ${command.commandType}"
                )
            }
        }
        
    } catch (e: Exception) {
        Log.e(TAG, "Erro ao executar comando ${command.id}", e)
        sendAck(
            commandId = command.id,
            status = "failed",
            errorCode = "EXECUTION_ERROR",
            errorMessage = e.message ?: "Erro desconhecido"
        )
    }
}
```

---

## üìä Exemplos Completos

### Exemplo 1: Comando de Bloqueio Progressivo N√≠vel 3

```json
{
  "id": "d27ca004-fae6-448c-b2a6-e0723619f7da",
  "deviceId": "device_1762725359153_ogqi20gqqp",
  "commandType": "BLOCK_APPS_PROGRESSIVE",
  "parameters": {
    "targetLevel": 3,
    "daysOverdue": 30,
    "categories": ["social_media"],
    "exceptions": [
      "com.whatsapp",
      "com.android.dialer",
      "com.android.messaging"
    ],
    "reason": "30 dias de atraso - Bloqueio n√≠vel 3"
  },
  "status": "pending",
  "priority": "high",
  "createdAt": "2025-11-11T01:36:00.000Z",
  "expiresAt": "2025-11-13T01:36:00.000Z"
}
```

**Resultado esperado no APK:**
- Bloquear: Facebook, Instagram, Twitter, TikTok, Snapchat
- Manter: WhatsApp, Telefone, SMS, Apps banc√°rios, Emails

### Exemplo 2: Comando de Bloqueio Total

```json
{
  "id": "lock-screen-001",
  "deviceId": "device_1762725359153_ogqi20gqqp",
  "commandType": "LOCK_SCREEN",
  "parameters": {
    "lockType": "payment_overdue",
    "severity": "critical",
    "allowUnlock": false,
    "message": {
      "title": "Dispositivo Bloqueado",
      "subtitle": "Pagamento em atraso - 60 dias",
      "body": "Este aparelho foi bloqueado devido a atraso prolongado no pagamento. Regularize sua situa√ß√£o para desbloquear o dispositivo imediatamente.",
      "footer": "CDC CreditSmart - Solu√ß√µes Inteligentes em Cr√©dito"
    },
    "contractInfo": {
      "contractId": "device_1762725359153_ogqi20gqqp",
      "contractNumber": "CDC-2025-001234",
      "customerName": "Jo√£o da Silva Santos",
      "customerCpf": "123.456.789-00",
      "deviceName": "Samsung Galaxy A54 5G 128GB",
      "totalValue": 2400.00,
      "amountPaid": 800.00,
      "amountDue": 1600.00,
      "installmentsPaid": 4,
      "installmentsTotal": 12,
      "nextDueDate": "2025-11-15",
      "daysOverdue": 60
    },
    "paymentInfo": {
      "totalDue": 1000.00,
      "overdueAmount": 800.00,
      "interestAmount": 120.00,
      "fineAmount": 80.00,
      "nextInstallment": 200.00,
      "installmentsDue": [
        {
          "number": 5,
          "dueDate": "2025-10-01",
          "value": 200.00,
          "daysOverdue": 41
        },
        {
          "number": 6,
          "dueDate": "2025-10-15",
          "value": 200.00,
          "daysOverdue": 27
        },
        {
          "number": 7,
          "dueDate": "2025-11-01",
          "value": 200.00,
          "daysOverdue": 10
        },
        {
          "number": 8,
          "dueDate": "2025-11-15",
          "value": 200.00,
          "daysOverdue": 0
        }
      ]
    },
    "contactInfo": {
      "companyName": "CDC CreditSmart",
      "storeName": "Loja Centro - S√£o Paulo",
      "phone": "(11) 98765-4321",
      "whatsapp": "5511987654321",
      "email": "atendimento@cdccreditsmart.com",
      "address": "Av. Paulista, 1000 - Bela Vista, S√£o Paulo/SP - CEP 01310-100",
      "businessHours": "Segunda a Sexta: 9h √†s 18h | S√°bado: 9h √†s 13h"
    },
    "paymentOptions": [
      {
        "type": "pix",
        "label": "Pagar com PIX",
        "pixKey": "atendimento@cdccreditsmart.com",
        "qrCode": "00020126580014br.gov.bcb.pix0136atendimento@cdccreditsmart.com...",
        "enabled": true,
        "icon": "pix"
      },
      {
        "type": "boleto",
        "label": "Gerar Boleto Banc√°rio",
        "boletoUrl": "https://api.cdccreditsmart.com/payments/boleto/device_1762725359153_ogqi20gqqp",
        "enabled": true,
        "icon": "barcode"
      },
      {
        "type": "whatsapp",
        "label": "Negociar no WhatsApp",
        "whatsappNumber": "5511987654321",
        "whatsappMessage": "Ol√°! Preciso regularizar o pagamento do contrato CDC-2025-001234. Meu CPF √© 123.456.789-00.",
        "enabled": true,
        "icon": "whatsapp"
      },
      {
        "type": "call",
        "label": "Ligar para Loja",
        "phoneNumber": "1198765432",
        "enabled": true,
        "icon": "phone"
      }
    ],
    "allowedActions": [
      "call_emergency",
      "receive_calls",
      "use_banking_apps"
    ],
    "theme": {
      "primaryColor": "#E45713",
      "backgroundColor": "#1A1A1A",
      "textColor": "#FFFFFF",
      "accentColor": "#FFA500"
    }
  },
  "status": "pending",
  "priority": "urgent",
  "createdAt": "2025-11-11T02:00:00.000Z",
  "expiresAt": null
}
```

**Resultado esperado no APK:**
- Exibir tela de bloqueio em tela cheia
- Mostrar todas as informa√ß√µes do contrato
- Disponibilizar bot√µes de pagamento funcionais
- Impedir qualquer outra a√ß√£o no dispositivo
- Permitir apenas chamadas de emerg√™ncia e apps banc√°rios

---

## ‚úÖ Checklist de Implementa√ß√£o

### Para BLOCK_APPS_PROGRESSIVE
- [ ] Validar se √© Device Owner antes de executar
- [ ] Mapear categorias para package names
- [ ] Respeitar SEMPRE as exce√ß√µes (WhatsApp, telefone, SMS, bancos, emails)
- [ ] Bloquear apps usando DevicePolicyManager.setApplicationRestrictions()
- [ ] Enviar ACK com lista de apps bloqueados
- [ ] Tratar erros e enviar ACK de falha

### Para LOCK_SCREEN
- [ ] Criar LockScreenActivity com layout completo
- [ ] Implementar modo Kiosk (startLockTask)
- [ ] Exibir informa√ß√µes do contrato
- [ ] Mostrar valores em atraso com detalhes
- [ ] Implementar bot√µes de pagamento funcionais
- [ ] Permitir chamadas de emerg√™ncia
- [ ] Aplicar tema customizado (cores CDC)
- [ ] Impedir fechamento da Activity
- [ ] Enviar ACK quando bloqueio for ativado

### Geral
- [ ] Sistema de polling a cada 30 segundos
- [ ] Parser JSON robusto para comandos
- [ ] Logging detalhado de todas as a√ß√µes
- [ ] Tratamento de erros completo
- [ ] Testes com Device Owner ativo
- [ ] Testes sem Device Owner (deve falhar corretamente)

---

## üìû Suporte Backend

Para d√∫vidas ou problemas com os comandos MDM, contate o desenvolvedor do backend fornecendo:
1. Log completo do APK
2. ID do comando que falhou
3. Device ID
4. Vers√£o do Android
5. Status de Device Owner (ativo/inativo)

---

**√öltima atualiza√ß√£o:** 11 de Novembro de 2025
**Vers√£o do documento:** 1.0.0
**Sistema:** CDC CreditSmart MDM - APK Integration

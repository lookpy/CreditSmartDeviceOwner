üì± Feedback Backend - Autentica√ß√£o APK Implementada
Data: 23/01/2026
Status: ‚úÖ Implementado e Testado

Problema Reportado
O APK fazia auto-discovery com sucesso mas n√£o conseguia obter um token JWT para chamadas autenticadas como GET /api/apk/device/installments.

Solu√ß√£o Implementada
Foram implementadas duas op√ß√µes de autentica√ß√£o que podem ser usadas conforme a necessidade:

Op√ß√£o 1: Token JWT via Auto-Discovery (Recomendado)
O endpoint de discovery agora retorna um token JWT v√°lido por 90 dias:

GET /api/apk/discover/{imei}
Response:
{
  "success": true,
  "device": { ... },
  "customer": { ... },
  "connection": { ... },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."  // NOVO CAMPO
}
Uso em chamadas subsequentes:

GET /api/apk/device/installments
Authorization: Bearer {token}
Op√ß√£o 2: Autentica√ß√£o por Headers IMEI (Fallback)
Se o token n√£o estiver dispon√≠vel, o backend aceita autentica√ß√£o via headers:

GET /api/apk/device/installments
X-Device-IMEI: 860875074339718
X-Device-SerialNumber: QJ3H4MKG  (opcional)
X-Device-ID: device_xxx  (opcional)
Fluxo Recomendado para o APK
Na inicializa√ß√£o/reinstala√ß√£o: Chamar GET /api/apk/discover/{imei}
Guardar o token retornado em storage persistente
Usar o token em todas as chamadas autenticadas via Authorization: Bearer {token}
Se o token expirar ou n√£o existir: Usar headers IMEI como fallback
Endpoints Afetados
Todos os endpoints que usam o middleware authenticateApkToken agora aceitam ambas as formas:

GET /api/apk/device/installments
Outros endpoints protegidos por APK
Testes Realizados
Cen√°rio	Resultado
Discover retorna token	‚úÖ OK
Installments com Bearer token	‚úÖ OK
Installments com header IMEI	‚úÖ OK
IMEI inexistente	‚úÖ 401 "Dispositivo n√£o encontrado"
A√ß√µes Necess√°rias no APK
Atualizar o parsing do response de /api/apk/discover/{imei} para capturar o campo token
Implementar storage persistente para o token
Adicionar o token no header Authorization: Bearer {token} nas chamadas
(Opcional) Manter headers IMEI como fallback

Para que um aplicativo Kotlin funcione corretamente como Device Owner no Android 12 e 13+, existem vários pontos técnicos obrigatórios. Se algum deles faltar ou estiver errado, a configuração do perfil de trabalho (work profile / managed profile) ou a adoção como device owner falhará com erro.

Vou detalhar o que é necessário:

1. Permissões e Manifest

O AndroidManifest.xml do seu app precisa declarar permissões especiais de administração:

<uses-permission android:name="android.permission.MANAGE_DEVICE_ADMINS" tools:ignore="ProtectedPermissions"/>
<uses-permission android:name="android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS" tools:ignore="ProtectedPermissions"/>
<uses-permission android:name="android.permission.REQUEST_DELETE_PACKAGES"/>
<uses-permission android:name="android.permission.DISABLE_KEYGUARD"/>
<uses-permission android:name="android.permission.EXPAND_STATUS_BAR"/>
<uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/>
<uses-permission android:name="android.permission.BIND_DEVICE_ADMIN"/>
<uses-permission android:name="android.permission.BIND_DEVICE_SERVICE"/>


Observação: algumas permissões como MANAGE_PROFILE_AND_DEVICE_OWNERS são privilegiadas (só funcionam se o app for instalado como Device Owner via QR Code, NFC ou dpm set-device-owner).

2. Declaração do Device Admin Receiver

Você precisa de uma classe que herda de DeviceAdminReceiver e registrá-la no Manifest:

<receiver
    android:name=".MyDeviceAdminReceiver"
    android:permission="android.permission.BIND_DEVICE_ADMIN"
    android:exported="true">
    <meta-data
        android:name="android.app.device_admin"
        android:resource="@xml/device_admin_receiver" />
    <intent-filter>
        <action android:name="android.app.action.DEVICE_ADMIN_ENABLED" />
    </intent-filter>
</receiver>


Arquivo res/xml/device_admin_receiver.xml:

<device-admin xmlns:android="http://schemas.android.com/apk/res/android">
    <uses-policies>
        <limit-password />
        <watch-login />
        <reset-password />
        <force-lock />
        <wipe-data />
        <expire-password />
        <encrypted-storage />
        <disable-camera />
    </uses-policies>
</device-admin>

3. Suporte a Managed Provisioning

No Android 12+ e 13+, o processo de adoção como Device Owner é feito pelo Managed Provisioning.
O app precisa ter no Manifest:

<intent-filter>
    <action android:name="android.app.action.PROVISION_MANAGED_DEVICE" />
    <category android:name="android.intent.category.DEFAULT" />
</intent-filter>
<intent-filter>
    <action android:name="android.app.action.PROVISION_MANAGED_PROFILE" />
    <category android:name="android.intent.category.DEFAULT" />
</intent-filter>


Isso garante que o sistema reconheça o seu app durante a configuração do perfil de trabalho.

4. Inicialização obrigatória

O DeviceAdminReceiver deve implementar ao menos:

class MyDeviceAdminReceiver : DeviceAdminReceiver() {
    override fun onEnabled(context: Context, intent: Intent) {
        super.onEnabled(context, intent)
        Log.d("DeviceAdmin", "Device Owner ativado")
    }

    override fun onDisabled(context: Context, intent: Intent) {
        super.onDisabled(context, intent)
        Log.d("DeviceAdmin", "Device Owner desativado")
    }
}

5. Instalação como Device Owner

O app não pode virar Device Owner se já houver conta Google ou outro dono configurado.
As formas válidas são:

Factory reset + QR Code: usar o fluxo padrão do Android Enterprise (Managed Provisioning).

NFC bump (antigo, menos usado).

ADB (teste apenas):

adb shell dpm set-device-owner com.seupacote/.MyDeviceAdminReceiver


(só funciona em aparelho zerado ou emulador).

6. Provisionamento via QR Code

No Android 12+ o JSON do QR code deve conter:

{
  "android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME": "com.seupacote/.MyDeviceAdminReceiver",
  "android.app.extra.PROVISIONING_DEVICE_ADMIN_PACKAGE_DOWNLOAD_LOCATION": "https://meuservidor.com/seuapk.apk",
  "android.app.extra.PROVISIONING_DEVICE_ADMIN_PACKAGE_CHECKSUM": "base64sha256",
  "android.app.extra.PROVISIONING_LEAVE_ALL_SYSTEM_APPS_ENABLED": true,
  "android.app.extra.PROVISIONING_SKIP_USER_CONSENT": true
}


Se esse JSON estiver incorreto, o Android não consegue criar o perfil de trabalho e dá erro.

7. Requisitos Específicos do Android 12 e 13+

Android 12+ exige que o APK seja assinato válido e baixado de HTTPS.

Android 13 é ainda mais restritivo:

QR Code deve conter checksum SHA-256 do APK.

Algumas permissões só são ativadas se o app já estiver marcado como Device Owner durante a instalação.

Se o APK foi instalado manualmente antes, o provisionamento falha.

✅ Resumo do que seu APK precisa ter para funcionar:

Permissões especiais no Manifest.

Um DeviceAdminReceiver bem configurado.

Arquivo device_admin_receiver.xml com políticas.

Intents de Provisioning no Manifest.

Suporte a provisionamento via JSON/QR Code correto.

Instalação sempre em aparelho resetado (factory reset).

APK assinado corretamente e com checksum no QR Code para Android 13+.
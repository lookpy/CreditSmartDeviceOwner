# Integra√ß√£o APK - Sistema de Bloqueio Progressivo

## üìã Vis√£o Geral

O sistema de **Bloqueio Progressivo** do CDC CreditSmart aplica restri√ß√µes autom√°ticas em dispositivos com base em dias de atraso no pagamento. Este documento descreve a integra√ß√£o completa para o APK Android (Kotlin).

**Servidor Backend:** `https://cdccreditsmart.com`

---

## üéØ N√≠veis de Bloqueio Progressivo

O backend define **6 n√≠veis** de bloqueio (0-5) baseados em dias de atraso:

### N√≠vel 0 - Sem Bloqueio ‚úÖ
- **Dias de atraso:** 0-6 dias
- **Descri√ß√£o:** Todos os apps liberados
- **A√ß√£o:** Nenhuma restri√ß√£o

### N√≠vel 1 - Bloqueio Leve (7 dias) ‚ö†Ô∏è
- **Dias de atraso:** 7-14 dias
- **Bloqueados:** Fotos, galeria, v√≠deos, navegadores
- **Categorias:** `photos`, `gallery`, `video_players`, `web_browsers`
- **Exce√ß√µes:** WhatsApp, telefone, SMS, bancos, emails
- **Notifica√ß√£o:**
  - **T√≠tulo:** "Aten√ß√£o: limite de apps reduzido"
  - **Mensagem:** "Seu aparelho est√° com atraso de 7 dias. Aplicativos de fotos, galeria, v√≠deos e navegadores foram temporariamente bloqueados at√© a regulariza√ß√£o."

### N√≠vel 2 - Bloqueio M√©dio (15 dias) üü°
- **Dias de atraso:** 15-29 dias
- **Bloqueados:** + YouTube, m√∫sica, Play Store, jogos
- **Categorias:** `youtube`, `music_players`, `play_store`, `games`
- **Exce√ß√µes:** WhatsApp, telefone, SMS, bancos, emails
- **Notifica√ß√£o:**
  - **T√≠tulo:** "Aten√ß√£o: restri√ß√£o ampliada"
  - **Mensagem:** "Atraso de 15 dias. YouTube, apps de m√∫sica, Play Store e jogos foram bloqueados al√©m das restri√ß√µes anteriores."

### N√≠vel 3 - Bloqueio Avan√ßado (30 dias) üü†
- **Dias de atraso:** 30-44 dias
- **Bloqueados:** + Redes sociais (exceto WhatsApp)
- **Categorias:** `social_media`
- **Exce√ß√µes:** WhatsApp, telefone, SMS, bancos, emails
- **Notifica√ß√£o:**
  - **T√≠tulo:** "Aten√ß√£o: redes sociais bloqueadas"
  - **Mensagem:** "Atraso de 30 dias. Todas as redes sociais foram bloqueadas, exceto WhatsApp."

### N√≠vel 4 - Bloqueio Severo (45 dias) üî¥
- **Dias de atraso:** 45-59 dias
- **Bloqueados:** Quase tudo (WhatsApp ainda liberado)
- **Categorias:** `all_apps_except_whatsapp`
- **Exce√ß√µes:** WhatsApp, telefone, SMS, bancos, emails
- **Notifica√ß√£o:**
  - **T√≠tulo:** "Aten√ß√£o: restri√ß√£o severa"
  - **Mensagem:** "Atraso de 45 dias. Quase todos os aplicativos est√£o bloqueados, WhatsApp continua liberado."

### N√≠vel 5 - Bloqueio M√°ximo (60+ dias) ‚õî
- **Dias de atraso:** 60+ dias
- **Bloqueados:** TUDO (exceto bancos, telefone, SMS, email)
- **Categorias:** `all_apps_except_banks_calls_sms_emails`
- **Exce√ß√µes:** APENAS bancos, telefone, SMS, emails (WhatsApp BLOQUEADO)
- **Notifica√ß√£o:**
  - **T√≠tulo:** "Aten√ß√£o: restri√ß√£o m√°xima"
  - **Mensagem:** "Atraso de 60 dias. Apenas apps banc√°rios, de e-mail, telefone e SMS permanecer√£o dispon√≠veis. Demais apps foram bloqueados."

---

## üõ°Ô∏è Apps NUNCA Bloqueados (Prote√ß√£o Permanente)

**CR√çTICO:** Os seguintes apps **JAMAIS** devem ser bloqueados em NENHUM n√≠vel:

### üè¶ Banking & Finance
- **Categoria:** `bancos_allowed`
- **Exemplos:**
  - `com.santander.app`
  - `br.com.bb.android`
  - `com.itau`
  - `com.bradesco`
  - `com.nubank.nu`
  - Qualquer app com "banco", "nubank", "inter", "picpay", "mercadopago" no package name

### ‚òéÔ∏è Comunica√ß√£o de Emerg√™ncia
- `com.android.dialer` (telefone)
- `com.android.messaging` (SMS)
- `com.android.contacts` (contatos)

### üìß Email
- **Categoria:** `emails_allowed`
- **Exemplos:**
  - `com.google.android.gm` (Gmail)
  - `com.microsoft.office.outlook` (Outlook)

### ‚öôÔ∏è Sistema
- `com.android.settings` (configura√ß√µes)
- Apps do sistema Android
- Apps de seguran√ßa

---

## üîÑ Fluxos de Integra√ß√£o

### **Op√ß√£o 1: Comandos MDM via WebSocket (Recomendado)** üöÄ

Este √© o m√©todo **preferencial** para receber comandos de bloqueio em tempo real.

#### 1.1. Conectar ao WebSocket

```kotlin
val wsUrl = "wss://cdccreditsmart.com/ws?token=${jwtToken}"
val webSocket = OkHttpClient().newWebSocket(
    Request.Builder().url(wsUrl).build(),
    object : WebSocketListener() {
        override fun onMessage(webSocket: WebSocket, text: String) {
            handleWebSocketMessage(text)
        }
    }
)
```

#### 1.2. Receber Comando de Bloqueio

```json
{
  "type": "NEW_COMMAND",
  "payload": {
    "commandId": "cmd_uuid_123",
    "data": {
      "command": {
        "id": "cmd_uuid_123",
        "deviceId": "device_xxx",
        "commandType": "BLOCK_APPS_PROGRESSIVE",
        "parameters": {
          "targetLevel": 2,
          "daysOverdue": 15,
          "categories": [
            "photos",
            "gallery",
            "video_players",
            "web_browsers",
            "youtube",
            "music_players",
            "play_store",
            "games"
          ],
          "exceptions": [
            "com.whatsapp",
            "com.android.dialer",
            "com.android.messaging",
            "bancos_allowed",
            "emails_allowed"
          ],
          "reason": "Pagamento em atraso h√° 15 dias",
          "isManual": false
        },
        "status": "sent",
        "priority": "high",
        "expiresAt": "2025-11-12T00:00:00.000Z"
      }
    }
  }
}
```

#### 1.3. Enviar Acknowledgement (Imediatamente)

**Endpoint:** `POST /api/apk/device/{serialNumber}/command-response`

```kotlin
val acknowledgePayload = JSONObject().apply {
    put("commandId", commandId)
    put("status", "acknowledged")
}

client.post("https://cdccreditsmart.com/api/apk/device/${serialNumber}/command-response") {
    contentType(ContentType.Application.Json)
    setBody(acknowledgePayload.toString())
}
```

#### 1.4. Aplicar Bloqueio

```kotlin
fun applyProgressiveBlock(params: BlockParameters) {
    val dpm = getSystemService(Context.DEVICE_POLICY_SERVICE) as DevicePolicyManager
    val adminComponent = ComponentName(this, DeviceAdminReceiver::class.java)
    
    // Coletar apps instalados
    val installedApps = packageManager.getInstalledApplications(0)
    val appsToBlock = mutableListOf<String>()
    
    for (app in installedApps) {
        val packageName = app.packageName
        
        // NUNCA bloquear exce√ß√µes
        if (isProtectedApp(packageName, params.exceptions)) {
            continue
        }
        
        // Verificar se est√° em categoria bloqueada
        if (shouldBlockApp(app, params.categories)) {
            appsToBlock.add(packageName)
        }
    }
    
    // Bloquear apps
    for (packageName in appsToBlock) {
        try {
            dpm.setApplicationHidden(adminComponent, packageName, true)
            Log.i("ProgressiveBlock", "‚úÖ Bloqueado: $packageName")
        } catch (e: Exception) {
            Log.e("ProgressiveBlock", "‚ùå Erro ao bloquear $packageName: ${e.message}")
        }
    }
}

fun isProtectedApp(packageName: String, exceptions: List<String>): Boolean {
    // Apps cr√≠ticos SEMPRE protegidos
    val criticalApps = listOf(
        "com.android.dialer",
        "com.android.messaging",
        "com.android.settings",
        "com.android.contacts"
    )
    
    if (packageName in criticalApps) return true
    
    // Verificar bancos
    if ("bancos_allowed" in exceptions && isBankingApp(packageName)) return true
    
    // Verificar emails
    if ("emails_allowed" in exceptions && isEmailApp(packageName)) return true
    
    // Verificar WhatsApp
    if ("com.whatsapp" in exceptions && packageName == "com.whatsapp") return true
    
    return false
}

fun isBankingApp(packageName: String): Boolean {
    val bankingKeywords = listOf(
        "nubank", "inter", "itau", "bradesco", "santander",
        "caixa", "banco", "picpay", "mercadopago", "paypal",
        "bb.android", "sicoob", "sicredi", "next", "c6bank"
    )
    return bankingKeywords.any { packageName.contains(it, ignoreCase = true) }
}
```

#### 1.5. Enviar Confirma√ß√£o de Execu√ß√£o

**Endpoint:** `POST /api/apk/device/{serialNumber}/command-response`

```kotlin
// SUCESSO
val successPayload = JSONObject().apply {
    put("commandId", commandId)
    put("status", "completed")
    put("response", JSONObject().apply {
        put("success", true)
        put("blockedAppsCount", appsToBlock.size)
        put("appliedLevel", params.targetLevel)
        put("timestamp", System.currentTimeMillis())
    })
}

// ERRO
val errorPayload = JSONObject().apply {
    put("commandId", commandId)
    put("status", "failed")
    put("errorMessage", "Descri√ß√£o do erro")
    put("response", JSONObject().apply {
        put("success", false)
        put("errorCode", "BLOCK_FAILED")
        put("timestamp", System.currentTimeMillis())
    })
}

client.post("https://cdccreditsmart.com/api/apk/device/${serialNumber}/command-response") {
    contentType(ContentType.Application.Json)
    setBody(payload.toString())
}
```

---

### **Op√ß√£o 2: Polling de Comandos Pendentes (Fallback)** üîÑ

Se o WebSocket falhar, use polling a cada **30-60 segundos**.

#### 2.1. Buscar Comandos Pendentes

**Endpoint:** `GET /api/apk/device/{serialNumber}/commands`

**Headers:** N√£o precisa (Play Integrity autom√°tico)

**Response:**

```json
{
  "deviceId": "device_xxx",
  "serialNumber": "ABC123456",
  "commands": [
    {
      "id": "cmd_uuid_123",
      "commandType": "BLOCK_APPS_PROGRESSIVE",
      "parameters": {
        "targetLevel": 2,
        "daysOverdue": 15,
        "categories": ["photos", "gallery", "games"],
        "exceptions": ["com.whatsapp", "bancos_allowed"],
        "reason": "Atraso de 15 dias"
      },
      "priority": "high",
      "createdAt": "2025-11-10T10:00:00.000Z",
      "expiresAt": "2025-11-11T10:00:00.000Z"
    }
  ]
}
```

#### 2.2. Processar Cada Comando

Para cada comando na lista:
1. Verificar se j√° foi processado (evitar duplica√ß√£o)
2. Aplicar bloqueio (mesmo c√≥digo da Op√ß√£o 1.4)
3. Enviar acknowledgement
4. Enviar confirma√ß√£o de execu√ß√£o

---

### **Op√ß√£o 3: Sistema de Decis√µes Pendentes** üìã

Este sistema complementar permite consultar decis√µes de bloqueio administrativas.

#### 3.1. Consultar Decis√µes Pendentes

**Endpoint:** `GET /api/apk/device/{serialNumber}/pending-decisions`

**Headers:** N√£o precisa (Play Integrity autom√°tico)

**Response:**

```json
{
  "serialNumber": "ABC123456",
  "deviceId": "device_xxx",
  "pendingDecisions": [
    {
      "id": "decision_uuid_456",
      "action": "block",
      "reason": "Pagamento em atraso h√° 15 dias",
      "priority": "high",
      "requestedAt": "2025-11-10T10:00:00.000Z",
      "metadata": {
        "daysOverdue": 15,
        "suggestedLevel": 2
      }
    }
  ],
  "hasAnyPending": true,
  "lastChecked": "2025-11-10T12:00:00.000Z"
}
```

#### 3.2. Confirmar Decis√£o Processada

**Endpoint:** `POST /api/apk/device/{serialNumber}/acknowledge-decision`

**Headers:** N√£o precisa (Play Integrity autom√°tico)

**Request:**

```json
{
  "decisionId": "decision_uuid_456",
  "response": {
    "success": true,
    "processedAt": "2025-11-10T12:05:00.000Z"
  }
}
```

**Response:**

```json
{
  "success": true,
  "decisionId": "decision_uuid_456",
  "message": "Decision acknowledged successfully",
  "processedAt": "2025-11-10T12:05:00.000Z"
}
```

---

## üîì Desbloqueio de Dispositivo

### Quando Desbloquear?

- Cliente regularizou o pagamento
- Administrador solicitou desbloqueio manual
- Recebeu comando `UNBLOCK_APPS_PROGRESSIVE`

### Desbloquear via API

**Endpoint:** `POST /api/apk/device/{serialNumber}/unblock`

**Headers:** N√£o precisa (Play Integrity autom√°tico)

**Response:**

```json
{
  "success": true,
  "serialNumber": "ABC123456",
  "deviceId": "device_xxx",
  "isBlocked": false,
  "blockReason": null,
  "message": "Device unblocked successfully"
}
```

### Desbloquear Apps Localmente

```kotlin
fun unblockAllApps() {
    val dpm = getSystemService(Context.DEVICE_POLICY_SERVICE) as DevicePolicyManager
    val adminComponent = ComponentName(this, DeviceAdminReceiver::class.java)
    
    val installedApps = packageManager.getInstalledApplications(0)
    
    for (app in installedApps) {
        try {
            if (dpm.isApplicationHidden(adminComponent, app.packageName)) {
                dpm.setApplicationHidden(adminComponent, app.packageName, false)
                Log.i("ProgressiveBlock", "üîì Desbloqueado: ${app.packageName}")
            }
        } catch (e: Exception) {
            Log.e("ProgressiveBlock", "‚ùå Erro ao desbloquear: ${e.message}")
        }
    }
}
```

---

## ‚è∞ WorkManager - Tarefa Agendada

### Configurar Worker

```kotlin
class BlockingCheckWorker(context: Context, params: WorkerParameters) : Worker(context, params) {
    override fun doWork(): Result {
        try {
            // 1. Buscar comandos pendentes
            val commands = fetchPendingCommands()
            
            // 2. Processar cada comando
            for (command in commands) {
                processBlockingCommand(command)
            }
            
            // 3. Verificar decis√µes pendentes (opcional)
            val decisions = fetchPendingDecisions()
            for (decision in decisions) {
                processDecision(decision)
            }
            
            return Result.success()
        } catch (e: Exception) {
            Log.e("BlockingCheckWorker", "Erro: ${e.message}")
            return Result.retry()
        }
    }
}

// Agendar execu√ß√£o a cada 6 horas
val workRequest = PeriodicWorkRequestBuilder<BlockingCheckWorker>(6, TimeUnit.HOURS)
    .setConstraints(
        Constraints.Builder()
            .setRequiredNetworkType(NetworkType.CONNECTED)
            .build()
    )
    .build()

WorkManager.getInstance(context).enqueueUniquePeriodicWork(
    "blocking_check",
    ExistingPeriodicWorkPolicy.KEEP,
    workRequest
)
```

---

## üìä Logs e Auditoria

### Logs Obrigat√≥rios

```kotlin
// Comando recebido
Log.i("ProgressiveBlock", "üì© Comando recebido - ID: $commandId, N√≠vel: $targetLevel")

// Acknowledgement enviado
Log.i("ProgressiveBlock", "‚úÖ Acknowledgement enviado - ID: $commandId")

// Bloqueio aplicado
Log.i("ProgressiveBlock", "üîí Bloqueando ${appsToBlock.size} apps (N√≠vel $targetLevel)")
Log.d("ProgressiveBlock", "Apps bloqueados: $appsToBlock")

// Apps protegidos
Log.d("ProgressiveBlock", "üõ°Ô∏è Apps protegidos: $protectedApps")

// Conclus√£o
Log.i("ProgressiveBlock", "‚úÖ Bloqueio n√≠vel $targetLevel aplicado com sucesso")
```

---

## üß™ Testes Recomendados

### Teste 1: N√≠vel 0 ‚Üí N√≠vel 1
1. Simular 7 dias de atraso
2. Receber comando de bloqueio n√≠vel 1
3. Verificar: Galeria, navegador bloqueados
4. Verificar: Bancos, telefone, SMS **N√ÉO** bloqueados

### Teste 2: N√≠vel 1 ‚Üí N√≠vel 5
1. Simular 60 dias de atraso
2. Receber comando de bloqueio n√≠vel 5
3. Verificar: Quase tudo bloqueado (incluindo WhatsApp)
4. Verificar: Bancos, telefone, SMS, email **N√ÉO** bloqueados

### Teste 3: N√≠vel 5 ‚Üí N√≠vel 0 (Desbloqueio)
1. Simular pagamento regularizado
2. Receber comando de desbloqueio
3. Verificar: Todos os apps desbloqueados

### Teste 4: Prote√ß√£o de Apps Cr√≠ticos
1. Aplicar n√≠vel 5 (m√°ximo)
2. Tentar bloquear `com.android.dialer`
3. Verificar: Telefone **N√ÉO** bloqueado
4. Verificar log: "App cr√≠tico protegido"

---

## üîê Seguran√ßa

### 1. Play Integrity
- Todos os endpoints APK (`/api/apk/device/...`) validam automaticamente via Play Integrity
- **N√ÉO** √© necess√°rio enviar token JWT nos headers

### 2. Serial Number
- Use sempre `serialNumber` do dispositivo (n√£o `deviceId`)
- O `serialNumber` √© o identificador prim√°rio para o APK

### 3. Certificate Pinning
```kotlin
val certificatePinner = CertificatePinner.Builder()
    .add("cdccreditsmart.com", "sha256/AAAAAAAAAA...")
    .build()

val client = OkHttpClient.Builder()
    .certificatePinner(certificatePinner)
    .build()
```

### 4. Armazenamento Seguro
```kotlin
val masterKey = MasterKey.Builder(context)
    .setKeyScheme(MasterKey.KeyScheme.AES256_GCM)
    .build()

val sharedPreferences = EncryptedSharedPreferences.create(
    context,
    "secure_prefs",
    masterKey,
    EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,
    EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM
)
```

---

## üìû Suporte e Debugging

### Endpoints de Teste

```bash
# Buscar comandos pendentes
curl -X GET https://cdccreditsmart.com/api/apk/device/ABC123456/commands

# Buscar decis√µes pendentes
curl -X GET https://cdccreditsmart.com/api/apk/device/ABC123456/pending-decisions

# Enviar resposta de comando
curl -X POST https://cdccreditsmart.com/api/apk/device/ABC123456/command-response \
  -H "Content-Type: application/json" \
  -d '{"commandId":"cmd_123","status":"completed"}'
```

### Debug Checklist

- [ ] Device Owner ativo? (`dpm.isDeviceOwnerApp()`)
- [ ] Play Integrity configurado?
- [ ] WebSocket conectado?
- [ ] Serial number correto?
- [ ] Apps cr√≠ticos na lista de exce√ß√µes?
- [ ] Logs habilitados?

---

## üìö Refer√™ncias

- **Documenta√ß√£o MDM Completa:** `DOCUMENTACAO_MDM_APK.md`
- **Documenta√ß√£o de Integra√ß√£o:** `APK_INTEGRATION_DOCUMENTATION.md`
- **Endpoint Admin:** `POST /api/devices/:id/progressive-block` (apenas admin)

---

**Vers√£o:** 2.0  
**√öltima atualiza√ß√£o:** 10 de novembro de 2025  
**Compatibilidade:** Android 5.0+ (API 21+) com Device Owner Mode

---

## üìù Changelog

### v2.0 (10/11/2025)
- üéâ Documenta√ß√£o consolidada com todas as op√ß√µes de integra√ß√£o
- ‚úÖ Endpoints corretos (`/api/apk/device/{serialNumber}/...`)
- ‚úÖ Adicionado sistema de decis√µes pendentes
- ‚úÖ C√≥digo Kotlin completo para implementa√ß√£o
- ‚úÖ Testes e debugging detalhados

### v1.1 (10/11/2025)
- ‚úÖ Corre√ß√£o de endpoints MDM

### v1.0 (10/11/2025)
- üéâ Vers√£o inicial

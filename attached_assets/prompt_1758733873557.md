PROMPT PARA CONSTRUIR O APP ‚ÄúCDC Credit Smart‚Äù (Kotlin, Device Owner)
0) Regras fundamentais

N√ÉO implementar QR dentro do app. O QR de Device Owner √© do Android nativo (provisionamento). O app inicia j√° como Device Owner.

Padr√£o visual igual √†s telas enviadas: tema dark + laranja CDC, stepper, cards, tipografia forte, feedback claro.

Fluxo: Atestado ‚Üí Biometria ‚Üí Assinatura ‚Üí Conclu√≠do ‚Üí Dashboard ‚Üí Parcelas/Pagamentos ‚Üí Suporte ‚Üí Perfil ‚Üí Overlay (quando devido).

Seguran√ßa: TLS1.3 + Certificate Pinning, JWT com escopos e exp curto, Idempotency-Key em POSTs, assinatura da requisi√ß√£o X-Device-Signature com chave do Android Keystore, Play Integrity/Key Attestation, anti-debug/anti-root/anti-emulador.

1) Stack e arquitetura

Kotlin, minSdk 26+.

Jetpack Compose + Material 3 (sem Dynamic Color; usar paleta fixa CDC).

Clean + MVVM, m√≥dulos:

app (UI/NAV/DI/Theme)

domain (use cases)

data (Room + DAOs + Repos)

network (Retrofit/OkHttp + seguran√ßa)

device (DevicePolicyManager, attestation, lock task, overlay, updates)

payments (PIX/Boleto)

biometry (facade do SDK de liveness; se n√£o houver SDK, mock do fluxo)

Hilt para DI; Coroutines/Flow; WorkManager para jobs; Room (com Migrations); EncryptedSharedPreferences para segredos; FCM para push.

2) Tema CDC (igual seus exemplos)

Background: #121212

Card: #1E1E1E

Primary: #FF7A1A

Secondary: #F47C2C

TextPrimary: #FFFFFF

TextSecondary: #CFCFCF

Success: #4CAF50

Error: #E53935

Warning: #FFC107

Radius: 16‚Äì20px; elevation suave; √≠cones simples (Material Symbols Filled).

3) Navega√ß√£o (Compose)

Rotas:

/onboarding/welcome

/flow/attested

/flow/biometry

/flow/sign

/flow/done

/home

/installments

/payment/{installmentId}

/support

/profile

/lock/overlay (Activity separada, lock task)

Stepper (componente): estados NOT_STARTED | IN_PROGRESS | DONE | ERROR.

4) Telas (iguais √†s imagens que voc√™ mandou)
4.1 Atestado do dispositivo

T√≠tulo: ‚ÄúAtestado do Dispositivo‚Äù

Stepper: Atestado (ativo) ‚Üí Biometria ‚Üí Assinatura ‚Üí Conclu√≠do

Card ‚ÄúAguardando atestado‚Ä¶‚Äù

Card sucesso: IMEI digitado √ó IMEI real (laranja)

CTA: Continuar

A√ß√µes:

Chamar /v1/device/attest (Play Integrity/Key Attestation + devicePublicKey)

Salvar attestedDeviceId, fingerprint da pubkey, emitir JWT device:bind

Em seguida /v1/device/bind com contractCode|imeiPDV, imeiDigitado, attestedDeviceId

4.2 Biometria facial (liveness)

T√≠tulo: ‚ÄúValida√ß√£o Facial‚Äù

Preview da c√¢mera; status ‚ÄúCapturando‚Ä¶ / Validando‚Ä¶ / Aprovado / Revis√£o / Negado‚Äù

Exibir mensagem verde ao aprovar

CTA: Avan√ßar para Assinatura

A√ß√£o: /v1/biometry/face/verify com biometrySessionId, faceEmbedding, livenessScore, documentHash, storeId

4.3 Assinatura + Termos

T√≠tulo: ‚ÄúAssinatura do Contrato‚Äù

Card termos (hash/vers√£o); scroll obrigat√≥rio

SignaturePad (via ViewInterop) + bot√£o ‚ÄúLimpar‚Äù

CTA: Confirmar Assinatura

A√ß√µes:

GET /v1/contract/terms?version=latest

POST /v1/contract/sign (imagem base64 + termsHash + signatureVectorsHash)

Receber signatureReceiptId + JWT contract:sync

4.4 Conclu√≠do

‚ÄúContrato validado com sucesso‚Äù

Mostrar contractId, auditRef

CTA: Ir para In√≠cio

4.5 Home (Dashboard)

Cards: Pr√≥xima parcela, Status do contrato, Atrasos

Bot√µes: Ver Parcelas, Pagar agora, Suporte

Banner informativo quando h√° atraso (amarelo/vermelho)

4.6 Parcelas

Lista: n¬∫, vencimento, valor, status (Pago / Em aberto / Atrasado)

CTA item: Pagar ‚Üí /payment/{installmentId}

4.7 Pagamento (PIX/Boleto)

PIX: exibir QR + ‚ÄúCopiar PIX Copia & Cola‚Äù; status de confirma√ß√£o (polling ou WS)

Boleto: link/PDF (salvar em Downloads/CDC/), bot√£o ‚ÄúCompartilhar‚Äù

Ap√≥s confirma√ß√£o, atualizar Room e UI

4.8 Suporte

FAQ, WhatsApp, telefone, abrir chamado (POST suporte)

Mostrar protocolo

4.9 Perfil

Informa√ß√µes pessoais (nome/CPF/telefone/email) ‚Äì placeholders at√© sincronizar

Informa√ß√µes do dispositivo (modelo, IMEIs, data da compra)

Informa√ß√µes do pagamento (valor total, n¬∫ de parcelas)

4.10 Overlay (bloqueio)

Activity fullscreen em Lock Task Mode

Mensagem: ‚ÄúPagamento atrasado. Regularize para liberar.‚Äù

A√ß√µes: Pagar agora (abre /installments//payment)

Home/back desabilitados; sair somente por pol√≠tica do servidor (ou pagamento)

5) Banco local (Room)

Entities/DAO (resumo):

DeviceBinding(id, contractCode, attestedDeviceId, devicePubKeyFp, status, updatedAt)

Installment(id, contractId, number, dueDate, amount, status, txId?, lastSyncAt)

Payment(id, installmentId, method, amount, txId, createdAt, status)

BiometrySession(id, status, livenessScore?, resultId?, createdAt)

SignatureSession(id, termsVersion, termsHash, receiptId?, createdAt)

SyncQueue(id, type, payloadJson, idempotencyKey, retries, nextRunAt, status)

Terms(version, hash, text, fetchedAt)

AuditLog(id, event, metaJson, createdAt)

Flags(key, value, updatedAt)
Regras:

Primeiro grava local ‚Üí WorkManager envia ‚Üí idempot√™ncia por Idempotency-Key.

Conflito: servidor decide pelo updatedAt.

6) Jobs (WorkManager)

AttestationWorker (boot + di√°rio)

HeartbeatWorker (POST /api/apk/device/heartbeat, 6/6h)

SyncQueueWorker (envio robusto com backoff e retry)

PaymentsPollWorker (se n√£o houver webhook)

UpdatesWorker (check & download; instalar silencioso via DO)

BlockPolicyWorker (aplica/suspende pacotes, mostra overlay conforme pol√≠tica servidor)

7) Integra√ß√£o com APIs (headers e rotas)

Headers padr√£o:

Authorization: Bearer <JWT>
X-Idempotency-Key: <UUID>
X-Device-Signature: base64(ECDSA_sign(SHA256(body)))
Content-SHA256: <hex>


Novas rotas /v1 (uso principal no app):

POST /v1/device/attest

POST /v1/device/bind

POST /v1/biometry/face/verify

GET /v1/contract/terms?version=latest

POST /v1/contract/sign

POST /v1/contract/sync

Legado ainda utilizado:

GET /api/apk/device/installments

POST /api/apk/device/{serial}/pay/{installmentId} (ideal migrar p/ /v1/payments/pay com body)

POST /api/apk/device/heartbeat

GET /api/android/updates/check

GET /api/android/updates/download

GET /api/apk/active (metadados+checksum)

C√≥digos de erro a tratar no app:
AUTH_401/403, BIND_409, BIO_422/409, SIGN_422, SYNC_409, RATE_429 (backoff).

8) Seguran√ßa (implementa√ß√£o)

OkHttp Certificate Pinning

(Opcional/ideal) mTLS nas rotas cr√≠ticas

JWT ‚â§ 15min + Refresh rotativo (salvar em Keystore)

Play Integrity / Key Attestation (boot + di√°rio)

Assinatura de requisi√ß√£o (Keystore ECDSA)

Anti-tamper: R8 agressivo, anti-debug/Frida/emulador/root; verifica√ß√£o de assinatura do APK + hash de assets

Lock Task + DPM:

DISALLOW_FACTORY_RESET

DISALLOW_USB_FILE_TRANSFER

DISALLOW_DEBUGGING_FEATURES

DISALLOW_INSTALL_UNKNOWN_SOURCES

setLockTaskPackages, setPackagesSuspended (bloqueio de apps)

LGPD: consentimento dos termos, versionamento/hash, reten√ß√£o, acesso do titular

9) Pseudoc√≥digo essencial (resumo)

Pinning:

val pinner = CertificatePinner.Builder()
  .add("cdccreditsmart.com", "sha256/AAAA...=")
  .build()
val ok = OkHttpClient.Builder()
  .certificatePinner(pinner)
  .addInterceptor(AuthInterceptor(tokensRepo))
  .build()


Assinatura:

fun xDeviceSignature(body: ByteArray): String {
  val key = loadKeystorePrivateKey()
  val sig = Signature.getInstance("SHA256withECDSA")
  sig.initSign(key); sig.update(body)
  return Base64.encodeToString(sig.sign(), Base64.NO_WRAP)
}


Overlay (lock task):

class LockActivity : ComponentActivity() {
  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    startLockTask()
    setContent { OverlayScreen(onPayNow = { navTo("/installments") }) }
  }
  override fun onBackPressed() {} // no-op
}


SignaturePad (Compose):

AndroidView(factory = { ctx ->
  SignaturePad(ctx, null).apply {
    setOnSignedListener(object : OnSignedListener { /* salva bitmap/base64 */ })
  }
})

10) Atualiza√ß√µes silenciosas

UpdatesWorker: GET /api/android/updates/check ‚Üí baixa com checksum ‚Üí instala via PackageInstaller + DPM (ou Managed Play privado).

Reportar sucesso/falha (criar /v1/device/update-report se necess√°rio).

11) Testes (resumo)

Happy path completo

Rosto duplicado (DENIED/REVIEW)

IMEI divergente (BIND_409)

JWT expirado/escopo errado

Idempot√™ncia (mesma Idempotency-Key)

Rede intermitente (retry + backoff)

Regras de bloqueio por atraso (suspens√£o ‚Üí overlay parcial ‚Üí overlay total)

Update silenciosa (download/instala√ß√£o/rollback)

12) Entreg√°veis

Projeto Android completo em m√≥dulos, com Hilt/Room/WorkManager/Compose.

Theming CDC (cores, tipografia, componentes Stepper/Timeline/StatusChip).

Implementa√ß√£o das telas iguais √†s imagens (layout, √≠cones, cores, microtextos).

Clients Retrofit das rotas acima + interceptors de seguran√ßa.

Banco offline + filas de sync + jobs.

Pol√≠ticas Device Owner aplicadas (sem QR dentro do app).

Scripts de build (prod/dev), proguard-rules.pro endurecido.

README com requisitos de provisionamento (Android Enterprise QR) e passos de QA.

0) Regras fundamentais

[igual ao anterior‚Ä¶]

O app DEVE manter um servi√ßo em background cont√≠nuo para estabilidade, bloqueios e sincroniza√ß√£o.

6) Jobs (WorkManager) + Servi√ßo Persistente

Al√©m dos workers j√° definidos, criar um servi√ßo residente, obrigat√≥rio para Device Owner:

6.1 Servi√ßo Foreground/Persistente

Criar CoreDeviceService : LifecycleService, inicializado no boot.

Deve rodar em Foreground com NotificationChannel discreto (pode ser oculto via categoria ‚ÄúService‚Äù).

Registra listeners para:

Conectividade (rede ligada/desligada)

Bateria (carga cr√≠tica)

Eventos de bloqueio/atraso (recebidos por push ou fila local)

Tentativas de kill do processo (restart autom√°tico)

6.2 Auto-Restart (impar√°vel)

Implementar BroadcastReceiver para ACTION_BOOT_COMPLETED, ACTION_MY_PACKAGE_REPLACED, ACTION_USER_PRESENT.

Se o app for encerrado, AlarmManager/WorkManager reiniciam CoreDeviceService.

Device Owner ‚Üí pode usar Lock Task Mode e setLockTaskPackages para impedir o usu√°rio de for√ßar encerramento.

Pol√≠tica DPM: DISALLOW_UNINSTALL_APPS para o pr√≥prio pacote.

6.3 Fun√ß√µes do Servi√ßo

Monitorar status de parcelas e aplicar bloqueios em tempo real.

Heartbeat peri√≥dico para /api/apk/device/heartbeat.

Sincronizar fila (SyncQueueWorker).

Escutar FCM ‚Üí aplicar comandos imediatos (ex: bloqueio remoto).

Ativar Overlay em caso de atraso (iniciar LockActivity).

Checar updates silenciosas e disparar instala√ß√£o.

6.4 Resili√™ncia

startForegroundService() sempre que reiniciar.

setForegroundServiceBehavior(FOREGROUND_SERVICE_IMMEDIATE) no Android 14+.

Usar PARTIAL_WAKE_LOCK quando processar filas cr√≠ticas.

Revalidar attestation (Play Integrity) de tempos em tempos, sempre pelo servi√ßo.

8) Seguran√ßa (complemento)

CoreDeviceService deve verificar se est√° rodando; caso parado, BroadcastReceiver reativa.

Para evitar bypass, bloquear acesso ao menu de desenvolvedor via DevicePolicyManager (DISALLOW_DEBUGGING_FEATURES).

Impedir desligar o servi√ßo: mesmo se o usu√°rio tentar for√ßar parada, Device Owner pode reativar em boot ou push imediato.

12) Entreg√°veis (complemento)

CoreDeviceService com:

Boot auto-start.

ForegroundService persistente.

Auto-restart via Alarm/WorkManager.

Monitoramento cont√≠nuo.

Integra√ß√£o com bloqueios e overlay.

üìå Em resumo:
O CDC Credit Smart APK deve ser impar√°vel, rodando em segundo plano 24/7, protegido por Device Owner, com servi√ßo foreground persistente + auto-restart, mantendo a sincroniza√ß√£o, monitorando pagamentos e aplicando bloqueios.
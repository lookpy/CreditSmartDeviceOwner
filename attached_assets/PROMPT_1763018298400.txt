# DocumentaÃ§Ã£o de IntegraÃ§Ã£o - Backend PIX e Time Sync

## ğŸ¯ Objetivo
Integrar o APK Android com o sistema de pagamentos PIX e sincronizaÃ§Ã£o de tempo do backend.

---

## ğŸ“¡ ENDPOINTS DISPONÃVEIS

### 1. SINCRONIZAÃ‡ÃƒO DE TEMPO (CRÃTICO - JÃ IMPLEMENTADO âœ…)

#### `GET /api/apk/time/now`

**AutenticaÃ§Ã£o:** JWT Token (Bearer)

**Request:**
```http
GET /api/apk/time/now HTTP/1.1
Authorization: Bearer {JWT_TOKEN}
Host: seu-backend.replit.app
```

**Response (200 OK):**
```json
{
  "timestamp": 1762986789123,
  "timezone": "America/Sao_Paulo",
  "serverDate": "2024-11-12T22:26:29.123Z"
}
```

**Campos:**
- `timestamp` (Long): Timestamp Unix em milissegundos (epoch) - usar para cÃ¡lculos
- `timezone` (String): Timezone do servidor (sempre "America/Sao_Paulo")
- `serverDate` (String): Data ISO 8601 para debug/logs

**Uso no APK:**
Este endpoint JÃ ESTÃ implementado e funcionando. O APK deve continuar usando conforme jÃ¡ implementado.

---

## ğŸ’³ SISTEMA PIX - NOVOS ENDPOINTS

### 2. LISTAR PARCELAS PENDENTES/VENCIDAS

#### `GET /v1/pix/installments/:deviceId`

**AutenticaÃ§Ã£o:** JWT Token APK (Bearer)

**Request:**
```http
GET /v1/pix/installments/uuid-do-dispositivo HTTP/1.1
Authorization: Bearer {APK_JWT_TOKEN}
Host: seu-backend.replit.app
```

**Response (200 OK):**
```json
{
  "success": true,
  "installments": [
    {
      "id": "installment-uuid-1",
      "installmentNumber": 1,
      "value": "150.00",
      "dueDate": "2024-11-15T00:00:00.000Z",
      "status": "overdue",
      "daysOverdue": 5,
      "deviceId": "device-uuid",
      "saleId": "sale-uuid"
    },
    {
      "id": "installment-uuid-2",
      "installmentNumber": 2,
      "value": "150.00",
      "dueDate": "2024-11-30T00:00:00.000Z",
      "status": "pending",
      "daysOverdue": 0,
      "deviceId": "device-uuid",
      "saleId": "sale-uuid"
    }
  ]
}
```

**Status possÃ­veis:**
- `pending` - Parcela pendente, ainda nÃ£o vencida
- `overdue` - Parcela vencida (atrasada)
- `paid` - Parcela paga (nÃ£o retorna nesta lista)

**Quando chamar:**
- Quando usuÃ¡rio abrir tela de pagamentos
- ApÃ³s receber notificaÃ§Ã£o push sobre cobranÃ§a
- Periodicamente (a cada hora) se houver parcelas vencidas

---

### 3. GERAR QR CODE PIX

#### `POST /v1/pix/generate/:installmentId`

**AutenticaÃ§Ã£o:** JWT Token APK (Bearer)

**Request:**
```http
POST /v1/pix/generate/installment-uuid-1 HTTP/1.1
Authorization: Bearer {APK_JWT_TOKEN}
Content-Type: application/json
Host: seu-backend.replit.app
```

**Response (200 OK):**
```json
{
  "success": true,
  "qrCode": "00020126580014br.gov.bcb.pix...",
  "qrImage": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUg...",
  "orderId": "ORDER-2024-001",
  "transactionId": "TXN-123456789",
  "expirationDate": "2024-11-13T00:26:29.123Z"
}
```

**Campos:**
- `qrCode` (String): CÃ³digo PIX Copia e Cola (para copiar)
- `qrImage` (String): QR Code em Base64 (para mostrar na tela)
- `orderId` (String): ID do pedido (usar para consultar status)
- `transactionId` (String): ID da transaÃ§Ã£o PIX
- `expirationDate` (String): Data de expiraÃ§Ã£o do QR Code (normalmente 24h)

**Response (503 Service Unavailable):**
```json
{
  "success": false,
  "message": "Failed to generate PIX QR code",
  "error": "PIX API token nÃ£o configurado"
}
```

**Quando chamar:**
- Quando usuÃ¡rio tocar em "Pagar com PIX" em uma parcela vencida
- Gerar novo QR Code se o anterior expirou

---

### 4. VERIFICAR STATUS DE PAGAMENTO

#### `GET /v1/pix/status/:orderId`

**AutenticaÃ§Ã£o:** JWT Token APK (Bearer)

**Request:**
```http
GET /v1/pix/status/ORDER-2024-001 HTTP/1.1
Authorization: Bearer {APK_JWT_TOKEN}
Host: seu-backend.replit.app
```

**Response (200 OK - Pago):**
```json
{
  "success": true,
  "status": "PAID",
  "paid": true
}
```

**Response (200 OK - Pendente):**
```json
{
  "success": true,
  "status": "PENDING",
  "paid": false
}
```

**Status possÃ­veis:**
- `PENDING` - Aguardando pagamento
- `PAID` - Pago com sucesso
- `EXPIRED` - QR Code expirado
- `CANCELLED` - Cancelado

**Quando chamar:**
- Polling: A cada 5 segundos enquanto tela de pagamento estiver aberta
- ApÃ³s usuÃ¡rio informar que pagou
- Parar polling quando status = `PAID` ou usuÃ¡rio fechar tela

---

## ğŸ”” WEBHOOK AUTOMÃTICO (Backend â†’ APK)

O backend **automaticamente** processa webhooks da API PIX quando o pagamento Ã© confirmado.

**O que acontece automaticamente:**
1. âœ… Parcela Ã© marcada como paga no banco de dados
2. âœ… Dispositivo Ã© desbloqueado SE todas parcelas vencidas foram pagas
3. âœ… NotificaÃ§Ã£o push FCM Ã© enviada ao dispositivo (se configurado)
4. âœ… WebSocket notifica mudanÃ§a de status (se conectado)

**O APK deve:**
- Escutar notificaÃ§Ãµes FCM com tipo `PAYMENT`
- Atualizar UI quando receber notificaÃ§Ã£o de pagamento aprovado
- Re-consultar lista de parcelas pendentes
- Verificar status do dispositivo (pode ter sido desbloqueado)

---

## ğŸ”„ FLUXO COMPLETO DE PAGAMENTO PIX

### Fluxo Recomendado:

```
1. UsuÃ¡rio abre app â†’ GET /v1/pix/installments/:deviceId
   â””â”€> Mostra lista de parcelas vencidas

2. UsuÃ¡rio toca "Pagar Parcela X" â†’ POST /v1/pix/generate/:installmentId
   â””â”€> Recebe QR Code + orderId
   â””â”€> Mostra QR Code na tela
   â””â”€> BotÃ£o "Copiar cÃ³digo PIX"

3. Enquanto tela aberta â†’ Polling GET /v1/pix/status/:orderId (5s)
   â””â”€> Se paid=true: Mostra "âœ… Pagamento Confirmado!"
   â””â”€> Fecha tela automaticamente apÃ³s 2s
   â””â”€> Atualiza lista de parcelas

4. NotificaÃ§Ã£o Push recebida (tipo PAYMENT)
   â””â”€> Toast: "Pagamento confirmado!"
   â””â”€> Atualiza lista de parcelas
   â””â”€> Se dispositivo foi desbloqueado, mostrar toast

5. UsuÃ¡rio fecha tela antes de pagar
   â””â”€> Para polling
   â””â”€> QR Code continua vÃ¡lido atÃ© expirar (24h)
```

---

## ğŸ¨ SUGESTÃƒO DE UI/UX

### Tela: Lista de Parcelas Vencidas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’³ Minhas Parcelas                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚ âš ï¸ Parcela 1 - VENCIDA (5 dias)    â”‚
â”‚ Vencimento: 15/11/2024              â”‚
â”‚ Valor: R$ 150,00                    â”‚
â”‚ [Pagar com PIX] ğŸ“±                  â”‚
â”‚                                     â”‚
â”‚ â³ Parcela 2 - Vence em 3 dias      â”‚
â”‚ Vencimento: 30/11/2024              â”‚
â”‚ Valor: R$ 150,00                    â”‚
â”‚ [Pagar com PIX] ğŸ“±                  â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tela: QR Code PIX

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Voltar    PIX - Parcela 1         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚         â”‚               â”‚           â”‚
â”‚         â”‚   QR CODE     â”‚           â”‚
â”‚         â”‚    IMAGE      â”‚           â”‚
â”‚         â”‚               â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                     â”‚
â”‚ Valor: R$ 150,00                    â”‚
â”‚ Vencimento: 15/11/2024              â”‚
â”‚                                     â”‚
â”‚ CÃ³digo PIX Copia e Cola:            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ 00020126580014br.gov.bcb... â”‚ ğŸ“‹ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚ â³ Aguardando pagamento...          â”‚
â”‚ [JÃ¡ Paguei] [Cancelar]              â”‚
â”‚                                     â”‚
â”‚ QR Code vÃ¡lido atÃ©: 13/11 00:26    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” AUTENTICAÃ‡ÃƒO

Todos os endpoints `/v1/pix/*` e `/api/apk/time/now` requerem autenticaÃ§Ã£o JWT.

**Header obrigatÃ³rio:**
```
Authorization: Bearer {APK_JWT_TOKEN}
```

O token JWT Ã© o mesmo jÃ¡ usado pelo APK para outros endpoints.

---

## âš ï¸ TRATAMENTO DE ERROS

### Erro 401 - NÃ£o Autenticado
```json
{
  "success": false,
  "message": "Token invÃ¡lido ou expirado"
}
```
**AÃ§Ã£o:** Redirecionar para login ou renovar token

### Erro 404 - Parcela nÃ£o encontrada
```json
{
  "success": false,
  "message": "Installment not found"
}
```
**AÃ§Ã£o:** Atualizar lista de parcelas (pode ter sido paga)

### Erro 500 - Erro interno
```json
{
  "success": false,
  "message": "Failed to generate PIX QR code",
  "error": "..."
}
```
**AÃ§Ã£o:** Mostrar erro ao usuÃ¡rio, permitir tentar novamente

### Erro 503 - ServiÃ§o indisponÃ­vel
```json
{
  "success": false,
  "message": "PIX service temporarily unavailable"
}
```
**AÃ§Ã£o:** Mostrar "ServiÃ§o temporariamente indisponÃ­vel"

---

## ğŸ“Š DADOS ARMAZENADOS LOCALMENTE (SQLite)

### RecomendaÃ§Ãµes:

1. **Cache de parcelas pendentes:**
   - Atualizar a cada abertura do app
   - Atualizar apÃ³s pagamento confirmado
   - TTL: 1 hora

2. **Ãšltimo QR Code gerado:**
   - Armazenar `orderId` + `qrCode` + `expirationDate`
   - Permitir reabrir se nÃ£o expirou
   - Limpar apÃ³s expiraÃ§Ã£o

3. **HistÃ³rico de pagamentos:**
   - Armazenar parcelas pagas
   - Mostrar em "HistÃ³rico"

---

## ğŸ§ª TESTES RECOMENDADOS

### 1. Teste de Lista de Parcelas
```kotlin
// Chamar endpoint
val response = apiService.getPendingInstallments(deviceId)

// Verificar
assert(response.success == true)
assert(response.installments.isNotEmpty())
assert(response.installments[0].status in listOf("pending", "overdue"))
```

### 2. Teste de GeraÃ§Ã£o de QR Code
```kotlin
val response = apiService.generatePixQRCode(installmentId)

assert(response.success == true)
assert(response.qrCode.isNotEmpty())
assert(response.orderId.isNotEmpty())
```

### 3. Teste de Polling de Status
```kotlin
// Simular polling
for (i in 1..10) {
    delay(5000)
    val status = apiService.checkPixStatus(orderId)
    
    if (status.paid) {
        // Pagamento confirmado!
        break
    }
}
```

---

## ğŸš€ PRÃ“XIMOS PASSOS

### Para a IA do APK implementar:

1. âœ… **JÃ¡ implementado:** Endpoint `/api/apk/time/now` - continuar usando

2. ğŸ†• **Novo:** Criar serviÃ§o Retrofit para endpoints PIX:
   - `GET /v1/pix/installments/:deviceId`
   - `POST /v1/pix/generate/:installmentId`
   - `GET /v1/pix/status/:orderId`

3. ğŸ†• **Novo:** Criar tela "Minhas Parcelas":
   - Lista de parcelas vencidas/pendentes
   - Badge de "X dias atrasado"
   - BotÃ£o "Pagar com PIX"

4. ğŸ†• **Novo:** Criar tela "QR Code PIX":
   - Mostrar QR Code (ImageView + Base64)
   - BotÃ£o "Copiar cÃ³digo PIX" (clipboard)
   - Polling automÃ¡tico de status (5s)
   - Feedback visual quando pago

5. ğŸ†• **Novo:** Integrar com FCM:
   - Escutar notificaÃ§Ãµes tipo `PAYMENT`
   - Atualizar UI quando receber
   - Mostrar toast de confirmaÃ§Ã£o

6. ğŸ†• **Novo:** Cache local:
   - Salvar lista de parcelas pendentes
   - Salvar Ãºltimo QR Code gerado
   - Limpar cache ao expirar

---

## ğŸ“ EXEMPLO DE CÃ“DIGO KOTLIN

### Retrofit Service
```kotlin
interface PixApiService {
    @GET("/v1/pix/installments/{deviceId}")
    suspend fun getPendingInstallments(
        @Path("deviceId") deviceId: String,
        @Header("Authorization") token: String
    ): PixInstallmentsResponse

    @POST("/v1/pix/generate/{installmentId}")
    suspend fun generatePixQRCode(
        @Path("installmentId") installmentId: String,
        @Header("Authorization") token: String
    ): PixQRCodeResponse

    @GET("/v1/pix/status/{orderId}")
    suspend fun checkPixStatus(
        @Path("orderId") orderId: String,
        @Header("Authorization") token: String
    ): PixStatusResponse
}

data class PixInstallmentsResponse(
    val success: Boolean,
    val installments: List<Installment>
)

data class Installment(
    val id: String,
    val installmentNumber: Int,
    val value: String,
    val dueDate: String,
    val status: String,
    val daysOverdue: Int
)

data class PixQRCodeResponse(
    val success: Boolean,
    val qrCode: String,
    val qrImage: String,
    val orderId: String,
    val transactionId: String,
    val expirationDate: String
)

data class PixStatusResponse(
    val success: Boolean,
    val status: String,
    val paid: Boolean
)
```

### ViewModel
```kotlin
class PaymentViewModel : ViewModel() {
    private val _installments = MutableLiveData<List<Installment>>()
    val installments: LiveData<List<Installment>> = _installments

    private val _qrCode = MutableLiveData<PixQRCodeResponse>()
    val qrCode: LiveData<PixQRCodeResponse> = _qrCode

    fun loadPendingInstallments(deviceId: String) {
        viewModelScope.launch {
            try {
                val token = "Bearer ${getJwtToken()}"
                val response = pixApiService.getPendingInstallments(deviceId, token)
                _installments.value = response.installments
            } catch (e: Exception) {
                // Handle error
            }
        }
    }

    fun generateQRCode(installmentId: String) {
        viewModelScope.launch {
            try {
                val token = "Bearer ${getJwtToken()}"
                val response = pixApiService.generatePixQRCode(installmentId, token)
                _qrCode.value = response
                startPollingStatus(response.orderId)
            } catch (e: Exception) {
                // Handle error
            }
        }
    }

    private fun startPollingStatus(orderId: String) {
        viewModelScope.launch {
            while (true) {
                delay(5000) // 5 segundos
                
                val token = "Bearer ${getJwtToken()}"
                val status = pixApiService.checkPixStatus(orderId, token)
                
                if (status.paid) {
                    // Pagamento confirmado!
                    _paymentConfirmed.value = true
                    break
                }
            }
        }
    }
}
```

---

## âœ… CHECKLIST DE IMPLEMENTAÃ‡ÃƒO

- [ ] Adicionar endpoints PIX ao Retrofit service
- [ ] Criar modelos de dados (Response classes)
- [ ] Criar ViewModel para gerenciar estado
- [ ] Criar tela "Minhas Parcelas"
- [ ] Criar tela "QR Code PIX"
- [ ] Implementar polling de status
- [ ] Adicionar botÃ£o "Copiar cÃ³digo PIX"
- [ ] Integrar com notificaÃ§Ãµes FCM (tipo PAYMENT)
- [ ] Adicionar cache local de parcelas
- [ ] Testar fluxo completo
- [ ] Adicionar loading states
- [ ] Adicionar tratamento de erros
- [ ] Adicionar analytics (opcional)

---

## ğŸ†˜ SUPORTE

**Backend Endpoint Base URL:**
```
https://seu-backend.replit.app
```

**DocumentaÃ§Ã£o adicional:**
- Webhook automÃ¡tico: Backend processa automaticamente, APK sÃ³ escuta FCM
- Rate limiting: 100 req/min no webhook (nÃ£o afeta APK)
- Timezone: Sempre "America/Sao_Paulo"

**DÃºvidas?**
Entre em contato com o desenvolvedor do backend.
